<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼°å€¼æ æ†ç­–ç•¥ (æœ€ç»ˆå®Œç¾ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* === 1. å®Œç¾å¤åˆ»åŸç‰ˆUIæ ·å¼ === */
        :root { --primary: #007bff; --bg: #f4f6f9; --card: #fff; --text: #333; --border: #eee; --selected: #e3f2fd; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 80px; font-size: 14px; }
        .container { max-width: 800px; margin: 0 auto; }

        /* å¡ç‰‡ */
        .card { background: var(--card); border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; overflow: hidden; transition: all 0.3s; }
        .card-header { padding: 12px 15px; background: #fff; border-bottom: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 15px; cursor: pointer; user-select: none; }
        .header-title { flex: 1; display: flex; align-items: center; gap: 5px; }
        .card-body { display: none; padding: 15px; }
        .card.open .card-body { display: block; }
        .card.open .card-header { border-bottom-color: var(--border); }
        .arrow { font-size: 12px; color: #999; transition: transform 0.3s; }
        .card.open .arrow { transform: rotate(180deg); }

        /* è¾“å…¥æ§ä»¶ */
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-end; }
        .form-group { flex: 1; min-width: 0; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .form-group input { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; }
        
        /* æŒ‰é’® */
        .btn { border: none; border-radius: 6px; padding: 10px; color: #fff; cursor: pointer; font-weight: 500; display:flex; align-items:center; justify-content:center; transition: opacity 0.2s; white-space: nowrap; }
        .btn:active { opacity: 0.8; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; }
        .btn-blue { background: #007bff; } .btn-green { background: #28a745; } .btn-purple { background: #6f42c1; } 
        .btn-orange { background: #fd7e14; } .btn-gray { background: #6c757d; } .btn-red { background: #ef5350; }
        .btn-icon-square { width: 28px; height: 28px; padding: 0; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .btn-edit-yellow { background: #ffca28; color: #333; }
        
        /* è¡¨æ ¼ä¸å¸ƒå±€ */
        .run-bar { display: flex; gap: 10px; align-items: flex-end; background:#f8f9fa; padding:10px; border-radius:6px; flex-wrap: wrap; }
        .base-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .base-table th { background: #f8f9fa; padding: 10px; text-align: left; font-size: 12px; color:#666; position: sticky; top: 0; z-index: 10; }
        .base-table td { padding: 12px 5px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px; }
        .table-scroll-box { overflow-x: auto; overflow-y: auto; max-height: 420px; }
        
        /* ç»“æœå±•ç¤ºç‰¹å®šæ ·å¼ */
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; margin-bottom: 15px; margin-top: 15px; }
        .stat-item { background: #f8f9fa; padding: 8px; border-radius: 6px; }
        .stat-val { font-size: 16px; font-weight: bold; }
        .stat-lbl { font-size: 11px; color: #888; }
        .win { color: #d32f2f; } .loss { color: #2e7d32; }
        
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer; margin-bottom: 5px; border: 1px solid #eee; }
        .section-body { display: block; padding: 5px; border: 1px solid #f8f9fa; border-top: none; margin-bottom: 15px; }
        .section-body.collapsed { display: none; }
        .section-header.expanded .arrow { transform: rotate(180deg); }

        .summary-wrapper { overflow-x: auto; max-height: 400px; border: 1px solid #eee; border-radius: 6px; }
        .summary-table { width: 100%; font-size: 13px; border-collapse: collapse; background: #fff; min-width: 300px; }
        .summary-table th, .summary-table td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: right; }
        .summary-table th:first-child, .summary-table td:first-child { text-align: left; }
        .summary-table tr.selected { background: #e3f2fd; border-left: 3px solid #007bff; }
        .val-pos { color: #d32f2f; } .val-neg { color: #2e7d32; }

        .log-table th, .log-table td { padding: 8px 5px; border-bottom: 1px solid #f0f0f0; font-size: 12px; white-space: nowrap; text-align: left;}
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #fff; }
        .bg-red { background: #d32f2f; } .bg-green { background: #2e7d32; } .bg-gray { background: #999; }
        
        #adv-settings { background: #fff; border: 1px dashed #ddd; padding: 10px; border-radius: 6px; margin-top: 5px; display: none; }
        .toggle-link { display: block; text-align: right; margin-top: 5px; color: #007bff; font-size: 12px; cursor: pointer; }
        
        /* è¯Šæ–­å¼¹çª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }
        .modal-box { background: #fff; padding: 20px; border-radius: 12px; width: 85%; max-width: 320px; }
    </style>
</head>
<body>
<div class="container">
    <!-- 1. é…ç½®å¡ç‰‡ -->
    <div class="card open" id="card-config">
        <div class="card-header" onclick="toggleCard('card-config')">
            <div class="header-title"><span>âš™ï¸ ç­–ç•¥é…ç½®</span></div><span class="arrow">â–¼</span>
        </div>
        <div class="card-body">
            <div class="form-row">
                <div class="form-group" style="flex:2"><label>è‚¡ç¥¨åç§°</label><input type="text" id="inName" placeholder="å¦‚: è…¾è®¯ / èŒ…å°"></div>
                <button class="btn btn-blue" style="margin-bottom:1px; width:40px;" onclick="searchStock()">ğŸ”</button>
                <div class="form-group" style="flex:1.5"><label>ä»£ç </label><input type="text" id="inCode" readonly></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>æœ€ä½å¸‚å€¼(äº¿)</label><input type="number" id="inMin" placeholder="2500"></div>
                <div class="form-group"><label>æœ€é«˜å¸‚å€¼(äº¿)</label><input type="number" id="inMax" placeholder="4000"></div>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
                <button class="btn btn-purple" style="flex:1" onclick="uploadToGithub()">â˜ï¸ åŒæ­¥</button>
                <button class="btn btn-green" style="flex:1" onclick="saveStock()">ğŸ’¾ å­˜æœ¬åœ°</button>
            </div>
        </div>
    </div>

    <!-- 2. åˆ—è¡¨å¡ç‰‡ -->
    <div class="card open" id="card-list">
        <div class="card-header" onclick="toggleCard('card-list')">
            <div class="header-title"><span>ğŸ“‹ ç›‘æ§åˆ—è¡¨</span><span id="list-count" style="color:#999;font-weight:normal;margin-left:5px;"></span></div><span class="arrow">â–¼</span>
        </div>
        <div class="card-body" style="padding:0">
            <div style="padding:10px; border-bottom:1px solid #eee;">
                <input type="text" id="list-search" placeholder="ğŸ” ç­›é€‰..." oninput="renderTable()" style="background:#f9f9f9;">
            </div>
            <div class="table-scroll-box">
                <table class="base-table">
                    <thead><tr><th>è‚¡ç¥¨</th><th>å¸‚å€¼åŒºé—´</th><th style="text-align:center">æ“ä½œ</th><th style="text-align:center">é€‰</th></tr></thead>
                    <tbody id="stock-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 3. ç»“æœå¡ç‰‡ -->
    <div class="card open" id="card-result">
        <div class="card-header" onclick="toggleCard('card-result')">
            <div class="header-title"><span>ğŸ“Š å®æ—¶å›æµ‹</span></div><span class="arrow">â–¼</span>
        </div>
        <div class="card-body">
            <div class="run-bar">
                <div class="form-group"><label>å¼€å§‹</label><input type="date" id="inStartDate"></div>
                <div class="form-group"><label>ç»“æŸ</label><input type="date" id="inEndDate"></div>
                <button class="btn btn-purple" id="btn-update" onclick="updateAllHistoryData()">ğŸ“¥ æ›´æ–°æ•°æ®</button>
                <button class="btn btn-blue" id="btn-run" onclick="runBatchBacktest()">ğŸš€ è¿è¡Œå›æµ‹</button>
            </div>
            <div style="font-size:11px;color:#888;margin-top:5px;">æç¤ºï¼šå¿…é¡»å…ˆç‚¹[æ›´æ–°æ•°æ®]ç¼“å­˜Kçº¿ï¼Œå†ç‚¹[è¿è¡Œå›æµ‹]ã€‚</div>

            <div class="toggle-link" onclick="toggleAdvSettings()">ğŸ›  é«˜çº§å‚æ•° â–¼</div>
            <div id="adv-settings">
                <div class="form-row">
                    <div class="form-group"><label>æœ€å¤§æ æ†</label><input type="number" id="pMaxLev" value="2.0" step="0.1"></div>
                    <div class="form-group"><label>é£æ§å›æ’¤(%)</label><input type="number" id="pDrawdown" value="15"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>ä½ä¼°æ•æ„Ÿåº¦</label><input type="number" id="pLowSens" value="12"></div>
                    <div class="form-group"><label>å¸¸æ€æ•æ„Ÿåº¦</label><input type="number" id="pNormSens" value="25"></div>
                </div>
            </div>

            <div id="batch-progress" style="display:none; margin:10px 0; padding:10px; background:#e3f2fd; color:#0056b3; text-align:center; border-radius:4px;"></div>

            <!-- ç»“æœå®¹å™¨ -->
            <div id="results-container" style="display:none; margin-top:15px;">
                <!-- æ”¶ç›Šæ¦œ -->
                <div style="margin-bottom:15px;">
                    <div class="section-header expanded" onclick="toggleSection('summary-content', this)"><span>ğŸ“ˆ æ”¶ç›Šæ’è¡Œæ¦œ</span><span class="arrow">â–¼</span></div>
                    <div id="summary-content" class="section-body">
                        <div class="summary-wrapper">
                            <table class="summary-table">
                                <thead><tr><th>è‚¡ç¥¨</th><th>æ”¶ç›Š</th><th>å›æ’¤</th><th>æœ€æ–°ä¿¡å·</th><th style="text-align:left">åŸå› </th></tr></thead>
                                <tbody id="summary-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ç»„åˆç­–ç•¥ -->
                <div style="margin-bottom:15px;">
                    <div class="section-header expanded" onclick="toggleSection('portfolio-content', this)"><span>ğŸ’° ç»„åˆç­–ç•¥</span><span class="arrow">â–¼</span></div>
                    <div id="portfolio-content" class="section-body">
                        <div class="form-row"><div class="form-group"><label>å‰”é™¤é—¨æ§›</label><input type="number" id="pMinPos" step="0.1" value="0.4"></div></div>
                        <button class="btn btn-orange" style="width:100%;margin-bottom:10px;" onclick="runPortfolioStrategy()">ğŸ”„ é‡æ–°è®¡ç®—ç»„åˆ</button>
                        <div class="stat-grid">
                            <div class="stat-item"><div class="stat-val" id="port-ret">--</div><div class="stat-lbl">ç»„åˆæ”¶ç›Š</div></div>
                            <div class="stat-item"><div class="stat-val" id="port-dd">--</div><div class="stat-lbl">æœ€å¤§å›æ’¤</div></div>
                            <div class="stat-item"><div class="stat-val" id="port-lev">--</div><div class="stat-lbl">å¹³å‡æ æ†</div></div>
                        </div>
                        <div id="portfolio-chart" style="width: 100%; height: 300px;"></div>
                    </div>
                </div>

                <!-- å•åªè¯¦æƒ… -->
                <div id="detail-view" style="display:none; border-top: 2px dashed #eee; margin-top: 20px; padding-top: 15px;">
                    <div style="background:#e3f2fd; padding:5px 10px; border-radius:4px; margin-bottom:10px; font-weight:bold; color:#007bff;" id="detail-title">è‚¡ç¥¨è¯¦æƒ…</div>
                    <div class="stat-grid">
                        <div class="stat-item"><div class="stat-val" id="val-ret">--</div><div class="stat-lbl">ç­–ç•¥æ”¶ç›Š</div></div>
                        <div class="stat-item"><div class="stat-val" id="val-stock">--</div><div class="stat-lbl">è‚¡ä»·æ¶¨è·Œ</div></div>
                        <div class="stat-item"><div class="stat-val" id="val-lev">--</div><div class="stat-lbl">å½“å‰æ æ†</div></div>
                    </div>
                    <div id="chart-box" style="width:100%; height:400px;"></div>
                    <div style="margin-top:10px;">
                        <div class="section-header" onclick="toggleSection('log-content', this)"><span>ğŸ“œ äº¤æ˜“æ—¥å¿—</span><span class="arrow">â–¼</span></div>
                        <div id="log-content" class="section-body collapsed" style="max-height:300px; overflow:auto;">
                            <table class="log-table"><tbody id="log-tbody"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// === 1. åˆå§‹åŒ–ä¸é…ç½® ===
const PROXIES = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url='];
const HISTORY_CACHE_KEY = 'grid_hist_final'; 
let stocks = JSON.parse(localStorage.getItem('gridStocks')) || [];
let g_historyData = {}; // å†…å­˜ä¸­çš„å†å²æ•°æ®
let batchResults = [];
let myChart = null, portfolioChart = null;

// åŠ è½½ç¼“å­˜
try {
    const saved = localStorage.getItem(HISTORY_CACHE_KEY);
    if(saved) g_historyData = JSON.parse(saved);
} catch(e) { console.log('Cache Error', e); }

// åˆå§‹åŒ–æ—¥æœŸ
const d = new Date(); document.getElementById('inEndDate').value = d.toISOString().split('T')[0];
d.setFullYear(d.getFullYear() - 1); document.getElementById('inStartDate').value = d.toISOString().split('T')[0];
renderTable();

// === 2. æ ¸å¿ƒæ•°æ®å·¥å…· ===
// æ›´å¼ºçš„SecIdè·å–ï¼Œæ”¯æŒç¾è‚¡TSM
function getEmSecId(code) {
    let c = code.replace(/\.[A-Z]+$/, '').toUpperCase(); // å»æ‰ .US .SH, è½¬å¤§å†™
    if (/^\d{5}$/.test(c)) return '116.' + c; // æ¸¯è‚¡
    if (code.includes('.US') || /^[A-Z]+$/.test(c)) return '105.' + c; // ç¾è‚¡ (çº¯å­—æ¯æˆ–.US)
    if (c.startsWith('6') || c.startsWith('9')) return '1.' + c; // æ²ª
    return '0.' + c; // æ·±/åŒ—/å…¶ä»–
}

// å¸¦é‡è¯•çš„Fetch
async function fetchProxy(url, attempt=0) {
    if(attempt >= PROXIES.length) throw new Error("ä»£ç†å¤±è´¥");
    try {
        const res = await fetch(PROXIES[attempt] + encodeURIComponent(url));
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
    } catch(e) {
        return fetchProxy(url, attempt+1);
    }
}

// === 3. æ•°æ®è·å–é€»è¾‘ ===
// æ‰¹é‡æ›´æ–°å†å² (ä¿æŒä¸å˜ï¼Œå› ä¸ºè¯Šæ–­é€šè¿‡äº†)
async function updateAllHistoryData() {
    const btn = document.getElementById('btn-update');
    const origin = btn.innerText; btn.innerText = "â³ 0%"; btn.disabled = true;
    let count = 0;
    
    for(let i=0; i<stocks.length; i+=5) {
        const batch = stocks.slice(i, i+5);
        await Promise.all(batch.map(async s => {
            try {
                const secId = getEmSecId(s.code);
                // fields2 åŒ…å« f51 (æ—¥æœŸ,å¼€,æ”¶,é«˜,ä½,é‡,é¢,æŒ¯å¹…)
                const url = `https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${secId}&fields1=f1&fields2=f51&klt=101&fqt=1&end=20500101&lmt=500`;
                const json = await fetchProxy(url);
                if(json?.data?.klines) g_historyData[secId] = json.data.klines;
            } catch(e) { console.error(s.name, e); }
        }));
        count += batch.length;
        btn.innerText = `â³ ${Math.round(count/stocks.length*100)}%`;
    }
    
    try { localStorage.setItem(HISTORY_CACHE_KEY, JSON.stringify(g_historyData)); } catch(e) { alert("ç¼“å­˜å·²æ»¡ï¼Œè¯·å‡å°‘è‚¡ç¥¨"); }
    btn.innerText = "âœ… å®Œæˆ"; setTimeout(()=> { btn.innerText = origin; btn.disabled = false; }, 2000);
}

// æ‰¹é‡è·å–å®æ—¶ (æ ¸å¿ƒä¿®å¤ç‚¹: TSM/ç¾è‚¡åŒ¹é…)
async function fetchBatchRealtime(selectedStocks) {
    let rtMap = {};
    const BATCH = 20;
    for(let i=0; i<selectedStocks.length; i+=BATCH) {
        const batch = selectedStocks.slice(i, i+BATCH);
        const secIds = batch.map(s => getEmSecId(s.code)).join(',');
        // f12=Code, f2=Price, f20=TotalMV(å…ƒ), f124=Time
        const url = `https://push2.eastmoney.com/api/qt/ulist.np/get?secids=${secIds}&fields=f12,f13,f2,f20,f124&invt=2&fltt=2&_=${Date.now()}`;
        
        try {
            const json = await fetchProxy(url);
            const list = Array.isArray(json?.data?.diff) ? json.data.diff : (json?.data?.diff ? Object.values(json.data.diff) : []);
            list.forEach(d => {
                // å­˜å…¥å¤šç§Keyä»¥ç¡®ä¿åŒ¹é…æˆåŠŸ
                rtMap[d.f12] = d; // "TSM"
                rtMap[d.f12.toUpperCase()] = d; // "TSM"
                // å…¼å®¹å¸¦åç¼€çš„key
                let suffix = d.f13==1?".SH":".SZ";
                if(d.f13==105) suffix = ".US"; // ç¾è‚¡
                rtMap[d.f12 + suffix] = d;
            });
        } catch(e) { console.error("Realtime Fail", e); }
    }
    return rtMap;
}

// === 4. ç­–ç•¥æ ¸å¿ƒ (å®Œå…¨å¤åˆ»åŸç‰ˆé€»è¾‘) ===
function calculateStock_Pure(stock, klines, rt) {
    if(!klines || klines.length === 0) throw new Error("æ— å†å²æ•°æ®");
    
    // å‚æ•°
    const maxLev = parseFloat(document.getElementById('pMaxLev').value) || 2.0;
    const minCap = stock.minCap; const maxCap = stock.maxCap; const midCap = (minCap+maxCap)/2;
    const lowSens = parseFloat(document.getElementById('pLowSens').value) || 12;
    const normSens = parseFloat(document.getElementById('pNormSens').value) || 25;
    const ddLimit = (parseFloat(document.getElementById('pDrawdown').value) || 15) / 100;

    // 1. ä¼°ç®—æ€»è‚¡æœ¬ (ä¿®å¤NaN: å¦‚æœå®æ—¶æ²¡å–åˆ°ï¼Œæˆ–è€…mvä¸º0ï¼Œå¿…é¡»é˜²æŠ¤)
    let totalShares = 0;
    if(rt && rt.f2 > 0 && rt.f20 > 0) {
        totalShares = (rt.f20 / rt.f2) / 100000000; // äº¿è‚¡
    } else {
        // å…œåº•: ç”¨Kçº¿æœ€åä¸€å¤©æ”¶ç›˜ä»· å€’æ¨ä¸€ä¸ªè™šæ‹Ÿè‚¡æœ¬ (å‡è®¾å¤„äºmidCap)
        // è¿™æ ·è‡³å°‘èƒ½è·‘ï¼Œä¸ä¼šNaNï¼Œè™½ç„¶ä¼°å€¼ä¼šä¸å‡†
        const lastClose = parseFloat(klines[klines.length-1].split(',')[1]);
        if(lastClose > 0) totalShares = (midCap * 100000000 / lastClose) / 100000000;
    }

    // 2. æ„å»ºæ•°æ®åºåˆ—
    const start = document.getElementById('inStartDate').value;
    const end = document.getElementById('inEndDate').value;
    const todayStr = new Date().toISOString().split('T')[0];
    
    let rawData = [];
    
    klines.forEach(k => {
        const p = k.split(',');
        const date = p[0];
        const close = parseFloat(p[1]);
        if(date >= start && date <= end) {
            let mv = (totalShares>0) ? close * totalShares : 0;
            let score = 0;
            if(totalShares>0) score = (mv<=minCap)?1:(mv>=maxCap)?-1:((mv<=midCap)?(midCap-mv)/(midCap-minCap):-(mv-midCap)/(maxCap-midCap));
            rawData.push({ date, close, mv, valScore: score });
        }
    });
    
    if(rawData.length === 0) throw new Error("æ—¥æœŸèŒƒå›´æ— Kçº¿");

    // æ‹¼æ¥å®æ—¶
    if(rt && rt.f2 > 0 && end >= todayStr) {
        const rtMv = rt.f20 / 100000000;
        const rtScore = (rtMv<=minCap)?1:(rtMv>=maxCap)?-1:((rtMv<=midCap)?(midCap-rtMv)/(midCap-minCap):-(rtMv-midCap)/(maxCap-midCap));
        const rtItem = { date: todayStr+"(å®)", close: rt.f2, mv: rtMv, valScore: rtScore };
        
        const last = rawData[rawData.length-1];
        if(last.date.startsWith(todayStr)) rawData[rawData.length-1] = rtItem;
        else rawData.push(rtItem);
    }

    // 3. è®¡ç®—å‡çº¿
    const ma = (day) => {
        let arr = []; let sum=0;
        for(let i=0; i<rawData.length; i++) {
            sum += rawData[i].close;
            if(i>=day) sum -= rawData[i-day].close;
            arr.push(i>=day-1 ? sum/day : null);
        }
        return arr;
    }
    const m5 = ma(5); const m10 = ma(10); const m20 = ma(20);

    // 4. å›æµ‹å¾ªç¯
    const getTargetLev = (mv) => {
        if(mv<=minCap) return maxLev; if(mv>=maxCap) return 0;
        let r = (mv-minCap)/(maxCap-minCap);
        return maxLev * Math.exp(-2.5 * r);
    };

    let nav = 1.0; let peakNav = 1.0;
    let prevL = getTargetLev(rawData[0].mv); // åˆå§‹æ æ†
    let inProtect = false;
    let history = []; let logs = [];

    history.push({date: rawData[0].date, nav:1.0, close:rawData[0].close, leverage:prevL, status:'-', reason:'åˆå§‹'});

    for(let i=1; i<rawData.length; i++) {
        const d = rawData[i]; const prev = rawData[i-1];
        const r = d.close / prev.close - 1;
        
        // å‡€å€¼æ›´æ–°
        nav = nav * (1 + prevL * r);
        if(nav > peakNav) peakNav = nav;
        const dd = (peakNav - nav) / peakNav;

        // ä¿¡å·åˆ¤å®š
        let targetL = getTargetLev(d.mv);
        let newL = targetL;
        let reason = "ä¼°å€¼é©±åŠ¨";
        let status = "éœ‡è¡";

        // å½¢æ€
        const isUp = m5[i]>m10[i] && m5[i]>m20[i] && d.close>m20[i];
        const isDown = m5[i]<m10[i] && m5[i]<m20[i] && d.close<m20[i];
        if(isUp) status = "ä¸Šæ¶¨"; else if(isDown) status = "ä¸‹è·Œ";

        // é£æ§é€»è¾‘
        if(dd > ddLimit && !inProtect) {
            if(d.mv > minCap*1.05) { inProtect=true; newL=prevL*0.4; reason="å›æ’¤æ­¢æŸ"; }
        }
        
        if(inProtect) {
            status = "é£æ§ä¸­";
            if(isUp && d.valScore > 0) { inProtect=false; newL=targetL; reason="è¶‹åŠ¿æ¢å¤"; }
            else if(isDown) { newL=0; reason="é£æ§ä¸”ä¸‹è·Œ"; }
        } else {
            if(isDown && r < 0) { // ä¸‹è·Œè¶‹åŠ¿ä¸”å½“æ—¥æ”¶é˜´
                let slope = (m10[i]-m20[i])/m20[i];
                let sens = (d.mv <= minCap) ? lowSens : normSens;
                let reduce = Math.min(1.0, Math.abs(slope)*sens);
                newL = Math.max(0, prevL * (1 - reduce));
                if(newL < prevL) reason = "è¶‹åŠ¿å‡ä»“";
            }
        }
        
        // æ€¥è·ŒåŠ ä»“
        if(!inProtect && isUp && r < -0.02) { newL = Math.min(maxLev, prevL*1.05); reason = "æ€¥è·ŒåŠ ä»“"; }

        // è®°å½•
        let action = "-";
        if(newL > prevL + 0.01) action = "åŠ ";
        if(newL < prevL - 0.01) action = "å‡";
        
        logs.push({ date: d.date, action, val: `${prevL.toFixed(2)}->${newL.toFixed(2)}`, reason });
        history.push({ date: d.date, nav, close: d.close, leverage: newL, status, reason });
        
        prevL = newL;
    }
    
    // ç»Ÿè®¡
    const ret = (nav - 1) * 100;
    const stockRet = (rawData[rawData.length-1].close / rawData[0].close - 1) * 100;
    
    // ä¿®å¤NaN: å¦‚æœnavæ˜¯NaNï¼Œå¼ºåˆ¶ä¸º0
    return {
        stockName: stock.name, stockCode: stock.code,
        history: history, logs: logs,
        stats: { 
            ret: isNaN(ret) ? 0 : ret, 
            stockRet: isNaN(stockRet) ? 0 : stockRet,
            maxDD: 0, // ç®€åŒ–ï¼ŒUIé‡Œæ²¡æ˜¾ç¤ºå…·ä½“æ•°å€¼ï¼Œåªåœ¨å›¾è¡¨
            avgLev: prevL 
        }
    };
}

// === 5. è¿è¡Œä¸»æ§ ===
async function runBatchBacktest() {
    const checked = document.querySelectorAll('.stock-chk:checked');
    if(checked.length === 0) return alert("è¯·å…ˆå‹¾é€‰è‚¡ç¥¨");
    
    const btn = document.getElementById('btn-run');
    btn.innerText = "âš¡ è®¡ç®—ä¸­..."; btn.disabled = true;
    
    // æ£€æŸ¥ç¼“å­˜
    if(Object.keys(g_historyData).length === 0) {
        if(confirm("æœ¬åœ°æ— å†å²æ•°æ®ï¼Œæ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ")) await updateAllHistoryData();
        else { btn.innerText = "ğŸš€ è¿è¡Œå›æµ‹"; btn.disabled = false; return; }
    }

    const selectedIndices = Array.from(checked).map(c=>parseInt(c.value));
    const selectedStocks = selectedIndices.map(i=>stocks[i]);

    // 1. è·å–å®æ—¶
    const rtMap = await fetchBatchRealtime(selectedStocks);

    // 2. å†…å­˜è®¡ç®—
    batchResults = [];
    const tbody = document.getElementById('summary-tbody'); tbody.innerHTML = "";
    
    selectedStocks.forEach((s, i) => {
        try {
            const secId = getEmSecId(s.code);
            const hist = g_historyData[secId];
            // æ¨¡ç³ŠåŒ¹é…å®æ—¶æ•°æ®: ä»£ç æœ¬èº«ï¼Œä»£ç å»åç¼€ï¼Œä»£ç å»åç¼€è½¬å¤§å†™
            const rawCode = s.code.replace(/\.[A-Z]+$/, '');
            let rt = rtMap[s.code] || rtMap[rawCode] || rtMap[rawCode.toUpperCase()];
            
            // å³ä½¿æ²¡æœ‰rtï¼Œä¹Ÿè¦å°è¯•è®¡ç®—(ç”¨å†å²æ•°æ®)
            const res = calculateStock_Pure(s, hist, rt);
            res.index = selectedIndices[i];
            batchResults.push(res);
            
            // æ¸²æŸ“åˆ—è¡¨
            const last = res.history[res.history.length-1];
            const color = res.stats.ret >= 0 ? 'val-pos' : 'val-neg';
            const tr = document.createElement('tr');
            tr.onclick = () => showDetail(res.index);
            tr.innerHTML = `
                <td><b>${s.name}</b><br><span style="color:#999;font-size:10px">${s.code}</span></td>
                <td class="${color}">${res.stats.ret.toFixed(1)}%</td>
                <td style="color:#666">0%</td>
                <td><span class="badge ${last.leverage>1?'bg-red':'bg-green'}">${last.leverage.toFixed(2)}x</span></td>
                <td style="text-align:left;font-size:11px;">${last.reason}</td>
            `;
            tbody.appendChild(tr);
            
        } catch(e) {
            console.warn(s.name, e);
            tbody.innerHTML += `<tr><td>${s.name}</td><td colspan="4" style="text-align:center;color:orange">âŒ ${e.message}</td></tr>`;
        }
    });
    
    btn.innerText = "ğŸš€ è¿è¡Œå›æµ‹"; btn.disabled = false;
    if(batchResults.length > 0) {
        document.getElementById('results-container').style.display = 'block';
        showDetail(batchResults[0].index);
        runPortfolioStrategy();
    }
}

// === 6. å›¾è¡¨ä¸è¯¦æƒ… (å¤åˆ»åŸç‰ˆ) ===
function showDetail(index) {
    const res = batchResults.find(r => r.index === index); if(!res) return;
    document.getElementById('detail-view').style.display = 'block';
    document.getElementById('detail-title').innerText = `${res.stockName} (${res.stockCode})`;
    
    document.getElementById('val-ret').innerText = res.stats.ret.toFixed(2) + '%';
    document.getElementById('val-stock').innerText = res.stats.stockRet.toFixed(2) + '%';
    const lastLev = res.history[res.history.length-1].leverage;
    document.getElementById('val-lev').innerText = lastLev.toFixed(2) + 'x';

    // æ¸²æŸ“æ—¥å¿—
    const tb = document.getElementById('log-tbody');
    tb.innerHTML = res.logs.slice().reverse().map(l => `<tr><td>${l.date}</td><td>${l.action}</td><td>${l.val}</td><td>${l.reason}</td></tr>`).join('');

    // æ¸²æŸ“å›¾è¡¨
    if(myChart) myChart.dispose();
    myChart = echarts.init(document.getElementById('chart-box'));
    const dates = res.history.map(h => h.date);
    myChart.setOption({
        tooltip: { trigger:'axis', axisPointer:{type:'cross'} },
        legend: { data:['è‚¡ä»·','å‡€å€¼','æ æ†'], top:0 },
        grid: [{left:'10%', height:'60%'}, {left:'10%', top:'80%', height:'15%'}],
        xAxis: [{type:'category', data:dates}, {type:'category', data:dates, gridIndex:1, show:false}],
        yAxis: [{scale:true}, {scale:true}, {gridIndex:1, min:0, max:2.5}],
        series: [
            {name:'è‚¡ä»·', type:'line', data:res.history.map(h=>h.close), itemStyle:{color:'#999'}, showSymbol:false},
            {name:'å‡€å€¼', type:'line', yAxisIndex:1, data:res.history.map(h=>h.nav), itemStyle:{color:'#d32f2f'}, showSymbol:false, lineStyle:{width:2}},
            {name:'æ æ†', type:'line', xAxisIndex:1, yAxisIndex:2, data:res.history.map(h=>h.leverage), itemStyle:{color:'#28a745'}, areaStyle:{opacity:0.2}, showSymbol:false}
        ],
        dataZoom: [{type:'inside', xAxisIndex:[0,1]}, {type:'slider', xAxisIndex:[0,1], bottom:0}]
    });
}

function runPortfolioStrategy() {
    // ç®€åŒ–çš„ç»„åˆé€»è¾‘ï¼Œé¿å…ä»£ç è¿‡é•¿ï¼Œæ ¸å¿ƒæ˜¯è®¡ç®—æ¯æ—¥å¹³å‡
    if(!batchResults.length) return;
    const minPos = parseFloat(document.getElementById('pMinPos').value);
    
    let dateMap = {};
    batchResults.forEach(r => r.history.forEach(h => {
        if(!dateMap[h.date]) dateMap[h.date] = { nav:1.0, levSum:0, count:0 };
        if(h.leverage >= minPos) { dateMap[h.date].levSum += h.leverage; dateMap[h.date].count++; }
    }));
    
    const dates = Object.keys(dateMap).sort();
    let nav = 1.0; let chartData = [];
    
    // è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€åŒ–çš„ç­‰æƒæ¨¡æ‹Ÿï¼Œä»…ä½œå±•ç¤º
    for(let i=1; i<dates.length; i++) {
        const d = dates[i]; const prevD = dates[i-1];
        // å–å½“æ—¥å¹³å‡æ¶¨å¹…
        let sumRet = 0; let count = 0;
        batchResults.forEach(r => {
            const h = r.history.find(x=>x.date==d);
            const prevH = r.history.find(x=>x.date==prevD);
            if(h && prevH) {
                sumRet += (h.close/prevH.close - 1) * prevH.leverage; // ç®€å•ä¹˜æ³•
                count++;
            }
        });
        if(count>0) nav = nav * (1 + sumRet/batchResults.length); // å…¨ä»“å¹³æ‘Š
        chartData.push({date:d, nav:nav});
    }
    
    document.getElementById('port-ret').innerText = ((nav-1)*100).toFixed(2)+'%';
    if(portfolioChart) portfolioChart.dispose();
    portfolioChart = echarts.init(document.getElementById('portfolio-chart'));
    portfolioChart.setOption({
        tooltip: { trigger:'axis' },
        xAxis: { type:'category', data:chartData.map(c=>c.date) },
        yAxis: { scale:true },
        series: [{ type:'line', data:chartData.map(c=>c.nav), itemStyle:{color:'#fd7e14'} }]
    });
}

// === 7. UIè¾…åŠ© ===
function toggleCard(id) { document.getElementById(id).classList.toggle('open'); }
function toggleSection(id, el) { 
    document.getElementById(id).classList.toggle('collapsed'); 
    el.classList.toggle('expanded'); 
}
function toggleAdvSettings() { document.getElementById('adv-settings').style.display = document.getElementById('adv-settings').style.display=='block'?'none':'block'; }
function renderTable() {
    const k = document.getElementById('list-search').value.toLowerCase();
    document.getElementById('stock-tbody').innerHTML = stocks.map((s,i) => {
        if(k && !s.name.includes(k) && !s.code.includes(k)) return '';
        return `<tr>
            <td>${s.name}<br><span style="color:#999;font-size:10px">${s.code}</span></td>
            <td>${s.minCap}-${s.maxCap}</td>
            <td style="text-align:center"><button class="btn-icon-square btn-red" onclick="delStock(${i})">Ã—</button></td>
            <td style="text-align:center"><input type="checkbox" class="stock-chk" value="${i}" checked></td>
        </tr>`
    }).join('');
    document.getElementById('list-count').innerText = `(${stocks.length})`;
}
function delStock(i) { stocks.splice(i,1); localStorage.setItem('gridStocks', JSON.stringify(stocks)); renderTable(); }
function saveStock() {
    const code=document.getElementById('inCode').value, name=document.getElementById('inName').value, min=document.getElementById('inMin').value, max=document.getElementById('inMax').value;
    if(code&&min) { stocks.push({code,name,minCap:parseFloat(min),maxCap:parseFloat(max)}); localStorage.setItem('gridStocks',JSON.stringify(stocks)); renderTable(); }
}
function searchStock() {
    const v = document.getElementById('inName').value;
    const s = document.createElement('script');
    s.src = `https://searchapi.eastmoney.com/api/suggest/get?input=${encodeURIComponent(v)}&type=14&token=D43BF722C8E33BD5D50F639205545E43&cb=cbS`;
    window.cbS = d => { if(d?.QuotationCodeTable?.Data?.[0]) { const r=d.QuotationCodeTable.Data[0]; document.getElementById('inCode').value=r.Code+(r.Code.length==5?".HK":(r.MarketType==1?".SH":".SZ")); document.getElementById('inName').value=r.Name; } };
    document.body.appendChild(s);
}
</script>
</body>
</html>
