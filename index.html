# â˜…â˜…â˜…â˜…â˜… ä»…æ”¹â€œä¸Šæ¶¨è¶‹åŠ¿åŠ æ æ†â€é€»è¾‘ï¼Œå…¶å®ƒæ‰€æœ‰å†…å®¹å…¨éƒ¨ä¿æŒåŸæ · â˜…â˜…â˜…â˜…â˜…

# -*- coding: utf-8 -*-
"""
ä¼°å€¼é©±åŠ¨æ æ†ç‰ˆï¼ˆä¼˜åŒ–ç‰ˆï¼‰ï¼š
- å¯é€‰æŒ‡æ•°/å¯¹æ•°æ›²çº¿
- åŠ¨æ€å›æ’¤ä¿æŠ¤ï¼ˆè¿‘20æ—¥é«˜ç‚¹ï¼‰
- è¶‹åŠ¿åˆ¤æ–­ï¼šå¤šå¤´æ’åˆ— + å‡çº¿æ–œç‡å‘ä¸Šï¼ˆæˆ–å®½æ¾åˆ¤å®šï¼Œè‡ªé€‚åº”å‰æœŸæ•°æ®ï¼‰
- ä¸Šæ¶¨è¶‹åŠ¿ä¸­æš‚åœä¼°å€¼è°ƒæ•´ï¼ˆå‰æœŸæ ·æœ¬ä¹Ÿèƒ½è¯†åˆ«ï¼‰
- å¸‚å€¼æ¥è¿‘æœ€ä½å¸‚å€¼5%å†…æ—¶ï¼Œä¸è§¦å‘ä¿æŠ¤
- ä¸‹è·Œè¶‹åŠ¿æ—¶æŒ‰æ–œç‡é€æ­¥é™ä½æ æ†ï¼ˆä¸å…è®¸ä¸Šå‡ï¼‰
- æ‰“å°æ¯æ¬¡æ æ†ç‡å˜åŒ–çš„æ—¥æœŸä¸åŸå› ï¼›å¹¶è®°å½•â€œæš‚åœä¼°å€¼è°ƒæ•´â€äº‹ä»¶
"""
from WindPy import w
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# ------------------ ç”¨æˆ·å¯è°ƒå‚æ•° ------------------
stock_name = "éš†é‘«é€šç”¨"
START_DATE = "2025-02-01"
END_DATE = "2025-11-17"

LOW_MV = 240e8
HIGH_MV = 320e8

MAX_LEVERAGE = 2.0
MIN_LEVERAGE = 0.01

CURVE_TYPE = "exp"        # "exp" æˆ– "log"
CURVE_PARAM = 2.5
MDD_MAX = 0.15
PROTECT_REDUCE_PCT = 0.6
RECOVER_STABLE_DAYS = 10

LOW_MV_NO_PROTECT_PCT = 0.05
# --------------------------------------------------

plt.rcParams['font.sans-serif'] = ['PingFang SC', 'Microsoft YaHei', 'SimHei', 'Arial']
plt.rcParams['axes.unicode_minus'] = False

# ---------- Wind ----------
w.start()
if not w.isconnected():
    raise RuntimeError("WindPy å¯åŠ¨å¤±è´¥ï¼Œè¯·ç¡®è®¤ Wind desktop å·²ç™»å½•å¹¶å…è®¸ Python è®¿é—®ã€‚")

# ---------- è‚¡ç¥¨ä»£ç  ----------
stock_all = pd.read_excel('/Users/yangwenjian/PycharmProjects/PythonProject/å…¨A.xlsx')
result = stock_all[stock_all['è¯åˆ¸ç®€ç§°'] == stock_name]
if result.empty:
    raise RuntimeError(f"æœªæ‰¾åˆ°è¯åˆ¸åç§°: {stock_name}")
SYMBOL = str(result.iloc[0]['è¯åˆ¸ä»£ç ']).strip()

# ---------- è·å–æ•°æ® ----------
fld = "close,mkt_cap"
data = w.wsd(SYMBOL, fld, START_DATE, END_DATE, "Period=D;PriceAdj=F")
if data.ErrorCode != 0:
    raise RuntimeError(f"Wind æ•°æ®è·å–å¤±è´¥ï¼Œé”™è¯¯ç : {data.ErrorCode}")

df = pd.DataFrame({
    "Date": pd.to_datetime(data.Times),
    "Close": data.Data[0],
    "MarketCap": data.Data[1]
}).dropna()
df.reset_index(drop=True, inplace=True)

# ---------- ä¼°å€¼å¾—åˆ† ----------
mid_mv = (LOW_MV + HIGH_MV) / 2.0
def valuation_score(mv, low_mv, high_mv):
    if mv <= low_mv:
        return 1.0
    elif mv >= high_mv:
        return -1.0
    elif mv <= mid_mv:
        return (mid_mv - mv) / (mid_mv - low_mv)
    else:
        return - (mv - mid_mv) / (high_mv - mid_mv)
df['ValScore'] = df['MarketCap'].apply(lambda x: valuation_score(x, LOW_MV, HIGH_MV))

# ---------- æ æ†å‡½æ•° ----------
def dynamic_leverage_from_mv(mv, low_mv, high_mv, min_L, max_L, curve_type="exp", param=3.0):
    if mv <= low_mv:
        return max_L
    elif mv >= high_mv:
        return min_L
    else:
        r = (mv - low_mv) / (high_mv - low_mv)
        if curve_type == "exp":
            L = min_L + (max_L - min_L) * np.exp(-param * r)
        elif curve_type == "log":
            L = min_L + (max_L - min_L) * (1 - np.log(1 + param * r) / np.log(1 + param))
        else:
            raise ValueError("curve_type å¿…é¡»æ˜¯ 'exp' æˆ– 'log'")
        return L

# ---------- è¶‹åŠ¿åˆ¤æ–­å‡½æ•° ----------
def is_uptrend_loose(df, i):
    if i < 5:
        return False
    elif i < 10:
        ma3 = df['Close'].iloc[max(0, i-3):i].mean()
        ma5 = df['Close'].iloc[max(0, i-5):i].mean()
        return ma3 > ma5
    elif i < 20:
        ma5 = df['Close'].iloc[max(0, i-5):i].mean()
        ma10 = df['Close'].iloc[max(0, i-10):i].mean()
        return ma5 > ma10
    else:
        ma5 = df['Close'].iloc[i-5:i].mean()
        ma10 = df['Close'].iloc[i-10:i].mean()
        ma20 = df['Close'].iloc[i-20:i].mean()
        return (ma5 > ma10) and (ma10 > ma20)

is_uptrend = is_uptrend_loose

# ---------- åˆå§‹åŒ– ----------
df['NAV'] = np.nan
df['PeakNAV'] = np.nan
df['Drawdown'] = np.nan
df['Leverage'] = np.nan
df['ProtectFlag'] = False

df.at[0, 'NAV'] = 1.0
df.at[0, 'PeakNAV'] = 1.0
df.at[0, 'Drawdown'] = 0.0
init_L = dynamic_leverage_from_mv(df.at[0, 'MarketCap'], LOW_MV, HIGH_MV,
                                  MIN_LEVERAGE, MAX_LEVERAGE,
                                  curve_type=CURVE_TYPE, param=CURVE_PARAM)
df.at[0, 'Leverage'] = init_L

nav, peak_nav, prev_L = 1.0, 1.0, init_L
in_protect, protect_since_idx = False, None
change_log = []

prev_up_trend = False

# ---------- ä¸»å¾ªç¯ ----------
for i in range(1, len(df)):
    r = df.at[i, 'Close'] / df.at[i - 1, 'Close'] - 1
    cur_mv = df.at[i, 'MarketCap']
    up_trend = is_uptrend(df, i)

    target_L = dynamic_leverage_from_mv(cur_mv, LOW_MV, HIGH_MV,
                                        MIN_LEVERAGE, MAX_LEVERAGE,
                                        curve_type=CURVE_TYPE, param=CURVE_PARAM)
    new_L = target_L
    protect_flag = False
    reason = None

    # --- å›æ’¤è§¦å‘ä¿æŠ¤ï¼ˆåŸé€»è¾‘å®Œå…¨ä¿ç•™ï¼‰ ---
    window_nav = df['NAV'].iloc[max(0, i-20):i].max() if i >= 20 else peak_nav
    cur_drawdown = (window_nav - nav) / window_nav if window_nav > 0 else 0
    near_low_mv = (cur_mv <= LOW_MV * (1.0 + LOW_MV_NO_PROTECT_PCT))

    if cur_drawdown > MDD_MAX and not in_protect:
        if near_low_mv:
            reason = f"âš ï¸ æœ¬åº”è§¦å‘å›æ’¤({cur_drawdown*100:.2f}%)ï¼Œä½†å¸‚å€¼æ¥è¿‘ä½ä¼°ï¼ˆè·³è¿‡ä¿æŠ¤ï¼‰"
        else:
            in_protect = True
            protect_flag = True
            new_L = prev_L * (1 - PROTECT_REDUCE_PCT)
            reason = f"âš ï¸ å›æ’¤è§¦å‘ä¿æŠ¤({cur_drawdown*100:.2f}%)"
            peak_nav = nav

    # --- ä¿æŠ¤çŠ¶æ€é€»è¾‘ï¼ˆåŸæ ·ï¼‰ ---
    if in_protect:
        start_check_idx = max(0, i - RECOVER_STABLE_DAYS)
        avg_val = np.mean(df['ValScore'].iloc[start_check_idx:i])
        cur_val = df.at[i, 'ValScore']
        ma5_ = df['Close'].iloc[max(0, i - 5):i].mean()
        ma10_ = df['Close'].iloc[max(0, i - 10):i].mean()
        ma20_ = df['Close'].iloc[max(0, i - 20):i].mean()
        trend_up = (ma5_ > ma10_ > ma20_)
        undervalued = (cur_val <= avg_val)

        if trend_up and undervalued:
            new_L = target_L
            in_protect = False
            protect_flag = False
            reason = "âœ… è¶‹åŠ¿æ¢å¤ (5>10>20 & ä¼°å€¼æ”¹å–„)"
        else:
            down_trend = (ma5_ < ma10_) and (ma10_ < ma20_)
            if down_trend:
                slope_factor = (ma10_ - ma20_) / ma20_
                reduce_ratio = min(1.0, abs(slope_factor) * 10)
                new_L = max(MIN_LEVERAGE, prev_L * (1 - reduce_ratio * 0.3))
                reason = f"ğŸ“‰ ä½ä¼°åŒºå†…ä»å¤„ä¸‹è·Œè¶‹åŠ¿ï¼ŒæŒ‰æ–œç‡ç»§ç»­å‡ä»“({reduce_ratio * 30:.1f}%)"
            else:
                new_L = MIN_LEVERAGE
            protect_flag = True

    # --- ä¸‹è·Œè¶‹åŠ¿ï¼ˆä¿æŒåŸé€»è¾‘ï¼‰ ---
    ma5_now = df['Close'].iloc[max(0, i-5):i].mean()
    ma10_now = df['Close'].iloc[max(0, i-10):i].mean()
    ma20_now = df['Close'].iloc[max(0, i-20):i].mean()
    down_trend = (ma5_now < ma10_now) and (ma10_now < ma20_now)

    if down_trend:
        slope_factor = (ma10_now - ma20_now) / ma20_now
        reduce_ratio = min(1.0, abs(slope_factor) * 10)
        new_L = max(MIN_LEVERAGE, prev_L * (1 - reduce_ratio * 0.3))
        if reason is None:
            reason = f"ğŸ“‰ ä¸‹è·Œè¶‹åŠ¿ï¼ˆMA5<MA10<MA20ï¼‰æŒ‰æ–œç‡é™æ æ†({reduce_ratio*30:.1f}%)"

    # --- â˜…â˜…â˜…â˜…â˜… ä¸Šæ¶¨è¶‹åŠ¿é€»è¾‘ï¼ˆä½ è¦æ±‚çš„éƒ¨åˆ†ï¼‰â˜…â˜…â˜…â˜…â˜… ---
    if (not in_protect) and up_trend:

        # â— è‹¥å•æ—¥è·Œå¹… > 2% â†’ åŠ æ æ† +5%
        if r < -0.02:
            new_L = prev_L * 1.05
            reason = "ğŸ“ˆ ä¸Šæ¶¨è¶‹åŠ¿ä¸­é‡åˆ°å•æ—¥å¤§è·Œ>2%ï¼ŒåŠ æ æ† +5%"

        else:
            # â— æ­£å¸¸ä¸Šæ¶¨æ—¥ â†’ åªèƒ½ä¸Šå‡ï¼Œä¸å¾—ä¸‹é™
            new_L = max(prev_L, target_L)
            if reason is None:
                reason = "â¸ ä¸Šæ¶¨è¶‹åŠ¿ä¸­ï¼šæ æ†ç‡åªèƒ½ä¸Šå‡æˆ–ç»´æŒï¼Œä¸å¾—ä¸‹é™"

    # --- NAV æ›´æ–°é€»è¾‘ï¼ˆåŸæ ·ï¼‰ ---
    nav = nav * (1 + prev_L * r)
    if nav > peak_nav:
        peak_nav = nav
    drawdown = (peak_nav - nav) / peak_nav if peak_nav != 0 else 0

    df.at[i, 'NAV'] = nav
    df.at[i, 'PeakNAV'] = peak_nav
    df.at[i, 'Drawdown'] = drawdown
    df.at[i, 'Leverage'] = new_L
    df.at[i, 'ProtectFlag'] = protect_flag

    # --- æ—¥å¿—è®°å½•ï¼ˆä¿æŒåŸæ ·ï¼‰ ---
    if abs(new_L - prev_L) > 1e-6:
        change_log.append({
            "æ—¥æœŸ": df.at[i, 'Date'].date(),
            "æ—§æ æ†": round(prev_L, 3),
            "æ–°æ æ†": round(new_L, 3),
            "åŸå› ": reason if reason else "ä¼°å€¼è°ƒæ•´/å¸‚å€¼é©±åŠ¨"
        })
        print(f"{df.at[i,'Date'].date()} æ æ†å˜åŒ– {prev_L:.3f} â†’ {new_L:.3f} ({reason})")

    prev_L = new_L
    prev_up_trend = up_trend

# ---------- ç»©æ•ˆ ----------
valid_nav = df['NAV'].dropna()
total_return = valid_nav.iloc[-1] / valid_nav.iloc[0] - 1.0
days = (df['Date'].iloc[-1] - df['Date'].iloc[0]).days
annualized_return = (1 + total_return) ** (365.0 / max(days, 1)) - 1.0
nav_ret = valid_nav.pct_change().dropna()
sharpe = (nav_ret.mean() / nav_ret.std()) * np.sqrt(252) if nav_ret.std() > 1e-12 else np.nan
max_dd = df['Drawdown'].max()

print("\n=== å›æµ‹ç»“æœ ===")
print(f"æ ‡çš„: {stock_name} ({SYMBOL})")
print(f"æ›²çº¿: {CURVE_TYPE}, å‚æ•°={CURVE_PARAM}")
print(f"æ€»æ”¶ç›Š: {total_return*100:.2f}%  å¹´åŒ–: {annualized_return*100:.2f}%  å¤æ™®: {sharpe:.3f}  æœ€å¤§å›æ’¤: {max_dd*100:.2f}%  å¹³å‡æ æ†: {df['Leverage'].mean():.3f}x")

# ---------- ç»˜å›¾ ----------
plt.rcParams['font.sans-serif'] = ['Hiragino Sans GB', 'Arial', 'PingFang SC', 'Microsoft YaHei']
plt.rcParams['axes.unicode_minus'] = False
fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(14, 9), sharex=True, gridspec_kw={'height_ratios': [2, 1]})
ax1.plot(df['Date'], df['Close'], color='steelblue', label='Price', linewidth=1.2)
ax1.set_ylabel('Price', color='steelblue')
ax1.tick_params(axis='y', colors='steelblue')
ax1r = ax1.twinx()
ax1r.plot(df['Date'], df['NAV'], color='firebrick', label='NAV', linewidth=1.6)
ax1r.set_ylabel('NAV', color='firebrick')
ax1r.tick_params(axis='y', colors='firebrick')
ax1.legend(loc='upper left')
ax1r.legend(loc='upper right')
ax1.set_title(f"{CURVE_TYPE.upper()}æ›²çº¿å¸‚å€¼æ æ† + å›æ’¤ä¿æŠ¤ - {stock_name}", fontsize=13, weight='bold')
ax2.plot(df['Date'], df['Leverage'], color='seagreen', label='Leverage', linewidth=1.4)
ax2.legend(loc='upper left')
ax2.set_ylabel('Leverage(x)')
ax2.grid(True, alpha=0.4)
plt.tight_layout()
plt.show()
