<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç½‘æ ¼ç­–ç•¥ç³»ç»Ÿ (Backtestä»“åº“ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* === åŸºç¡€æ ·å¼å¤ç”¨ === */
        :root { --primary: #007bff; --bg: #f4f6f9; --card: #fff; --text: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 50px; }
        
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* å¡ç‰‡ */
        .card { background: var(--card); border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 15px; }
        .card-header { font-weight: bold; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        
        /* æŒ‰é’®ç»„ */
        .btn { padding: 8px 15px; border: none; border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; color: white; display: inline-flex; align-items: center; gap: 4px; }
        .btn:active { transform: scale(0.98); }
        .btn-blue { background: #007bff; }
        .btn-green { background: #28a745; }
        .btn-purple { background: #6f42c1; }
        .btn-orange { background: #fd7e14; }
        .btn-red { background: #dc3545; }
        .btn-gray { background: #6c757d; }
        .btn-outline { background: transparent; border: 1px solid #ddd; color: #333; }

        /* è¾“å…¥è¡¨å• */
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; align-items: end; }
        .input-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .input-group input { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        .input-group input:focus { border-color: var(--primary); }
        .input-group input[readonly] { background: #f0f0f0; color: #666; }

        /* è¡¨æ ¼ */
        .table-box { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; }
        th { background: #f8f9fa; color: #666; font-weight: 600; white-space: nowrap; }
        tr:hover { background: #f1f3f5; }
        .td-action { display: flex; gap: 5px; }

        /* å›æµ‹ç»“æœåŒºåŸŸ */
        #chart-box { width: 100%; height: 400px; margin-top: 15px; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); text-align: center; gap: 10px; margin-bottom: 10px; }
        .stat-item { background: #f8f9fa; padding: 10px; border-radius: 6px; }
        .stat-val { font-size: 16px; font-weight: bold; }
        .stat-lbl { font-size: 11px; color: #888; margin-top: 2px; }
        .win { color: #d32f2f; } .loss { color: #2e7d32; }

        /* è°ƒè¯•/æ—¥å¿— */
        #console-log { font-family: monospace; font-size: 11px; color: #666; max-height: 100px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px; display: none; }
        
        /* æ¨¡æ€æ¡† (æ—¥å¿—/è®¾ç½®) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; }

        @media (max-width: 600px) {
            .input-grid { grid-template-columns: 1fr 1fr; }
            .btn span { display: none; } /* æ‰‹æœºä¸Šéšè—æŒ‰é’®æ–‡å­—åªç•™å›¾æ ‡ */
        }
    </style>
</head>
<body>

<div class="container">
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="card">
        <div class="card-header">
            <span>ğŸ“¡ ç½‘æ ¼ç­–ç•¥é…ç½®</span>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-purple" onclick="syncFromGithub()">â˜ï¸ æ‹‰å–é…ç½®</button>
                <button class="btn btn-orange" onclick="uploadToGithub()">ğŸš€ ä¿å­˜é…ç½®</button>
            </div>
        </div>
        
        <!-- å½•å…¥è¡¨å• -->
        <div class="input-grid">
            <div class="input-group" style="flex: 2; min-width: 200px;">
                <label>è‚¡ç¥¨åç§° (æ¨¡ç³Šæœç´¢)</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="inName" placeholder="è¾“å…¥å¦‚: èŒ…å°" onkeydown="if(event.keyCode==13) searchStock()">
                    <button class="btn btn-blue" onclick="searchStock()">ğŸ”</button>
                </div>
            </div>
            <div class="input-group">
                <label>ä»£ç  (è‡ªåŠ¨)</label>
                <input type="text" id="inCode" readonly placeholder="ç­‰å¾…æœç´¢...">
            </div>
            <div class="input-group">
                <label>æœ€ä½å¸‚å€¼ (äº¿)</label>
                <input type="number" id="inMin" placeholder="å¦‚ 16000">
            </div>
            <div class="input-group">
                <label>æœ€é«˜å¸‚å€¼ (äº¿)</label>
                <input type="number" id="inMax" placeholder="å¦‚ 25000">
            </div>
            <div class="input-group">
                <label>&nbsp;</label>
                <button class="btn btn-green" style="width:100%; justify-content: center;" onclick="saveStock()">ğŸ’¾ æ·»åŠ /æ›´æ–°</button>
            </div>
        </div>
    </div>

    <!-- è‚¡ç¥¨åˆ—è¡¨ -->
    <div class="card">
        <div class="card-header">ğŸ“‹ ç›‘æ§åˆ—è¡¨ <span id="list-count" style="font-size:12px; font-weight:normal; color:#888; margin-left:10px;"></span></div>
        <div class="table-box">
            <table id="stock-table">
                <thead>
                    <tr>
                        <th>ä»£ç </th>
                        <th>åç§°</th>
                        <th>å¸‚å€¼åŒºé—´ (äº¿)</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="stock-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- å›æµ‹åŒºåŸŸ -->
    <div class="card" id="backtest-area" style="display:none;">
        <div class="card-header">
            <span id="bt-title">ğŸ“Š å›æµ‹ç»“æœ</span>
            <button class="btn btn-outline" onclick="document.getElementById('backtest-area').style.display='none'">âœ• å…³é—­</button>
        </div>
        
        <!-- ç»Ÿè®¡ -->
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-val" id="res-ret">0.00%</div>
                <div class="stat-lbl">ç­–ç•¥æ”¶ç›Š</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="res-stock">0.00%</div>
                <div class="stat-lbl">æŒè‚¡ä¸åŠ¨</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="res-count">0</div>
                <div class="stat-lbl">äº¤æ˜“æ¬¡æ•°</div>
            </div>
        </div>
        
        <div style="text-align:center; font-size:12px; color:#666;" id="bt-info"></div>
        <div id="console-log"></div>
        <div id="chart-box"></div>
    </div>
</div>

<!-- GitHub Token å¼¹çª— -->
<div id="token-modal" class="modal">
    <div class="modal-content">
        <h3>ğŸ”‘ GitHub Token</h3>
        <p style="font-size:12px; color:#666; margin-bottom:10px;">é¦–æ¬¡ä½¿ç”¨éœ€è¦è¾“å…¥ Token ä»¥ä¾¿ä¿å­˜æ•°æ®åˆ°ä½ çš„ä»“åº“ã€‚</p>
        <input type="text" id="gh-token-input" style="width:100%; padding:8px; border:1px solid #ddd; margin-bottom:15px;" placeholder="ghp_xxxx...">
        <div style="text-align:right;">
            <button class="btn btn-gray" onclick="document.getElementById('token-modal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-blue" onclick="saveToken()">ç¡®å®š</button>
        </div>
    </div>
</div>

<script>
    // === 1. é…ç½®ä¸å…¨å±€å˜é‡ (å·²ä¿®æ”¹ä¸º backtest ä»“åº“) ===
    const GITHUB_CONFIG = { username: "dlezywj-cell", repo: "backtest", path: "grid_config.json", branch: "main" };
    const PROXY = 'https://corsproxy.io/?'; 
    let stocks = JSON.parse(localStorage.getItem('gridStocks')) || [];
    
    // åˆå§‹åŒ–
    renderTable();

    // === 2. æœç´¢ä¸å½•å…¥é€»è¾‘ ===
    function searchStock() {
        const name = document.getElementById('inName').value.trim();
        if(!name) return;
        const btn = document.querySelector('.btn-blue');
        const originalText = btn.innerText;
        btn.innerText = '...';

        // ä½¿ç”¨ä¸œè´¢æœç´¢æ¥å£
        const script = document.createElement('script');
        window.handleSearch = function(data) {
            btn.innerText = originalText;
            if(data?.QuotationCodeTable?.Data?.length) {
                const r = data.QuotationCodeTable.Data[0];
                let suffix = r.MarketType == "1" ? ".SH" : (r.MarketType == "2" ? ".SZ" : ".HK");
                if (r.Code.length == 6 && !r.MarketType) suffix = r.Code.startsWith('6') ? ".SH" : ".SZ";
                
                document.getElementById('inCode').value = r.Code + suffix;
                document.getElementById('inName').value = r.Name; // è‡ªåŠ¨ä¿®æ­£ä¸ºæ ‡å‡†å
            } else {
                alert("æœªæ‰¾åˆ°è¯¥è‚¡ç¥¨");
            }
            script.remove();
        };
        script.src = `https://searchapi.eastmoney.com/api/suggest/get?input=${encodeURIComponent(name)}&type=14&token=D43BF722C8E33BD5D50F639205545E43&cb=handleSearch`;
        document.body.appendChild(script);
    }

    function saveStock() {
        const code = document.getElementById('inCode').value;
        const name = document.getElementById('inName').value;
        const min = parseFloat(document.getElementById('inMin').value);
        const max = parseFloat(document.getElementById('inMax').value);

        if(!code || !name || isNaN(min) || isNaN(max)) {
            alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼ˆå…ˆæœç´¢è‚¡ç¥¨ï¼Œå†å¡«å¸‚å€¼ï¼‰");
            return;
        }

        const idx = stocks.findIndex(s => s.code === code);
        const newItem = { code, name, minCap: min, maxCap: max };
        
        if(idx >= 0) stocks[idx] = newItem;
        else stocks.push(newItem);

        localStorage.setItem('gridStocks', JSON.stringify(stocks));
        renderTable();
        // æ¸…ç©ºè¾“å…¥
        document.getElementById('inCode').value = '';
        document.getElementById('inName').value = '';
        document.getElementById('inMin').value = '';
        document.getElementById('inMax').value = '';
    }

    function renderTable() {
        const tbody = document.getElementById('stock-tbody');
        document.getElementById('list-count').innerText = `(${stocks.length})`;
        if(stocks.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999;">æš‚æ— é…ç½®ï¼Œè¯·æ·»åŠ </td></tr>';
            return;
        }
        tbody.innerHTML = stocks.map((s, i) => `
            <tr>
                <td><span style="background:#eee; padding:2px 5px; border-radius:3px; font-size:12px;">${s.code}</span></td>
                <td style="font-weight:bold;">${s.name}</td>
                <td>${s.minCap} - ${s.maxCap}</td>
                <td class="td-action">
                    <button class="btn btn-blue" onclick="prepareBacktest(${i})" style="padding:4px 8px;">â–¶ï¸ å›æµ‹</button>
                    <button class="btn btn-red" onclick="delStock(${i})" style="padding:4px 8px;">ğŸ—‘ï¸</button>
                </td>
            </tr>
        `).join('');
    }

    function delStock(i) {
        if(confirm('ç¡®å®šåˆ é™¤?')) {
            stocks.splice(i, 1);
            localStorage.setItem('gridStocks', JSON.stringify(stocks));
            renderTable();
        }
    }

    // === 3. GitHub åŒæ­¥é€»è¾‘ ===
    function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
    function b64_to_utf8(str) { return decodeURIComponent(escape(window.atob(str))); }

    async function uploadToGithub() {
        let token = localStorage.getItem("github_token");
        if (!token) { document.getElementById('token-modal').style.display='flex'; return; }

        const btn = document.querySelector('.btn-orange');
        const origin = btn.innerText; btn.innerText = "â³ æ¨é€ä¸­..."; btn.disabled = true;
        
        try {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
            // å…ˆè·å– SHA
            const get = await fetch(url, { headers: { "Authorization": `token ${token}` }, cache: "no-store" });
            let sha = null; 
            if (get.ok) sha = (await get.json()).sha;
            
            // æ¨é€
            const content = utf8_to_b64(JSON.stringify(stocks, null, 2));
            const put = await fetch(url, { 
                method: "PUT", 
                headers: { "Authorization": `token ${token}` }, 
                body: JSON.stringify({ message: "Update Grid Config", content: content, sha: sha }) 
            });
            
            if (put.ok) alert("âœ… åŒæ­¥æˆåŠŸï¼(Backtestä»“åº“)");
            else throw new Error((await put.json()).message);
        } catch (e) {
            if(e.message.includes("401")) { alert("Token æ— æ•ˆ"); localStorage.removeItem("github_token"); }
            else alert("âŒ " + e.message);
        } finally {
            btn.innerText = origin; btn.disabled = false;
        }
    }

    async function syncFromGithub() {
        let token = localStorage.getItem("github_token");
        const btn = document.querySelector('.btn-purple');
        const origin = btn.innerText; btn.innerText = "â³..."; btn.disabled = true;
        
        try {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
            const headers = { "Accept": "application/vnd.github.v3+json" };
            if(token) headers["Authorization"] = `token ${token}`;
            
            let res = await fetch(url, { headers, cache: "no-store" });
            let data;
            
            if (res.ok) {
                const json = await res.json();
                data = JSON.parse(b64_to_utf8(json.content));
            } else {
                // å°è¯•ç›´æ¥è¯» raw
                const rawUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.path}?t=${Date.now()}`;
                const raw = await fetch(rawUrl);
                if(!raw.ok) throw new Error("äº‘ç«¯æ— é…ç½®æ–‡ä»¶");
                data = await raw.json();
            }

            if(Array.isArray(data)) {
                if(confirm(`äº‘ç«¯æœ‰ ${data.length} æ¡é…ç½®ï¼Œæœ¬åœ°æœ‰ ${stocks.length} æ¡ã€‚\næ˜¯å¦è¦†ç›–æœ¬åœ°ï¼Ÿ`)) {
                    stocks = data;
                    localStorage.setItem('gridStocks', JSON.stringify(stocks));
                    renderTable();
                }
            }
        } catch (e) {
            alert("âŒ åŒæ­¥å¤±è´¥: " + e.message);
        } finally {
            btn.innerText = origin; btn.disabled = false;
        }
    }

    function saveToken() {
        const t = document.getElementById('gh-token-input').value.trim();
        if(t) { localStorage.setItem('github_token', t); document.getElementById('token-modal').style.display='none'; uploadToGithub(); }
    }

    // === 4. å›æµ‹æ ¸å¿ƒé€»è¾‘ (å¤ç”¨ä¹‹å‰æˆåŠŸçš„ä»£ç ) ===
    async function prepareBacktest(idx) {
        const s = stocks[idx];
        const area = document.getElementById('backtest-area');
        area.style.display = 'block';
        area.scrollIntoView({ behavior: 'smooth' });
        
        document.getElementById('bt-title').innerHTML = `ğŸ“Š å›æµ‹ä¸­: ${s.name} (${s.code})`;
        document.getElementById('console-log').style.display = 'block';
        document.getElementById('console-log').innerHTML = 'æ­£åœ¨åˆå§‹åŒ–...';
        
        // è°ƒç”¨å›æµ‹å‡½æ•°
        await runBacktestLogic(s.code, s.minCap, s.maxCap);
    }

    function debug(msg, type='info') {
        const el = document.getElementById('console-log');
        const color = type==='err'?'red':(type==='warn'?'orange':'#666');
        el.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
        el.scrollTop = el.scrollHeight;
    }

    function getEmSecId(code) {
        if (code.endsWith('.SS') || code.startsWith('6')) return '1.'+code.replace('.SS','');
        return '0.'+code.replace('.SZ','');
    }

    function toYahooSymbol(code) {
        if (code.startsWith('6')) return code + '.SS';
        if (code.startsWith('0') || code.startsWith('3')) return code + '.SZ';
        if (code.startsWith('8')) return code + '.BJ'; 
        if (code.length === 5) return code.substring(1) + '.HK';
        return code;
    }

    async function runBacktestLogic(code, minCap, maxCap) {
        const grids = 10;
        const capital = 10000000; // é»˜è®¤1000ä¸‡
        const range = '2y';
        const lotSize = 100;
        
        try {
            // 1. è·å–è‚¡æœ¬
            debug("è·å–å®æ—¶è‚¡æœ¬...");
            const emSecId = getEmSecId(code);
            const emCode = emSecId.split('.')[1]; 
            const emMkt = emSecId.split('.')[0]; 
            
            const listUrl = `https://push2.eastmoney.com/api/qt/ulist.np/get?secids=${emMkt}.${emCode}&fields=f2,f20&invt=2&fltt=2`;
            const capRes = await fetch(PROXY + encodeURIComponent(listUrl));
            const capJson = await capRes.json();
            
            let data = null;
            if (capJson.data && capJson.data.diff) data = Array.isArray(capJson.data.diff) ? capJson.data.diff[0] : capJson.data.diff[emCode];
            if (!data) throw new Error("æ— æ³•è·å–è‚¡æœ¬");

            const curPrice = parseFloat(data.f2); 
            const curMktCap = parseFloat(data.f20); 
            const totalShares = curMktCap / curPrice; 
            const totalSharesYi = totalShares / 100000000;
            
            // 2. è®¡ç®—åŒºé—´
            const minPrice = (minCap * 100000000) / totalShares;
            const maxPrice = (maxCap * 100000000) / totalShares;
            
            document.getElementById('bt-info').innerHTML = `æ€»è‚¡æœ¬: ${totalSharesYi.toFixed(2)}äº¿ | ç½‘æ ¼ä»·æ ¼åŒºé—´: <b>${minPrice.toFixed(2)} - ${maxPrice.toFixed(2)}</b>`;
            debug(`ç½‘æ ¼åŒºé—´: ${minPrice.toFixed(2)} - ${maxPrice.toFixed(2)}`);

            // 3. è·å–Kçº¿
            debug("æ‹‰å– Yahoo å†å²æ•°æ®...");
            const yhSymbol = toYahooSymbol(emCode);
            const yhUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yhSymbol}?range=${range}&interval=1d&events=history`;
            
            const histRes = await fetch(PROXY + encodeURIComponent(yhUrl));
            if(!histRes.ok) throw new Error("Yahoo è¯·æ±‚å¤±è´¥");
            const histJson = await histRes.json();
            const result = histJson.chart.result[0];
            
            let klines = [];
            const timestamps = result.timestamp;
            const quote = result.indicators.quote[0];
            for (let i = 0; i < timestamps.length; i++) {
                if (quote.close[i] != null) {
                    const date = new Date(timestamps[i] * 1000);
                    klines.push({
                        date: date.toISOString().split('T')[0],
                        close: parseFloat(quote.close[i].toFixed(2)),
                        high: parseFloat(quote.high[i].toFixed(2)),
                        low: parseFloat(quote.low[i].toFixed(2))
                    });
                }
            }
            debug(`å†å²æ•°æ®è·å–æˆåŠŸï¼Œå…± ${klines.length} å¤©`);

            // 4. æ‰§è¡Œç­–ç•¥
            const feeRate = 0.00025;
            let cash = capital;
            let shares = 0;
            let trades = [];
            let history = [];

            // ç”Ÿæˆç½‘æ ¼
            const ratio = Math.pow((maxPrice/minPrice), 1/grids);
            let gridLines = [];
            for(let i=0; i<=grids; i++) gridLines.push(minPrice * Math.pow(ratio, i));

            const getIdx = (p) => {
                if(p < gridLines[0]) return -1;
                if(p >= gridLines[grids]) return grids;
                for(let i=0; i<grids; i++) if(p >= gridLines[i] && p < gridLines[i+1]) return i;
                return 0;
            };

            // åˆå§‹å»ºä»“
            let startP = klines[0].close;
            let idx = getIdx(startP);
            if(idx >= 0 && idx < grids) {
                let pct = (grids - idx) / grids;
                let amt = capital * pct;
                let buyVol = Math.floor(amt / startP / lotSize) * lotSize;
                if(buyVol > 0) {
                    let cost = buyVol * startP;
                    cash -= (cost * (1+feeRate));
                    shares += buyVol;
                    trades.push({date: klines[0].date, type:'å»ºä»“', price:startP, vol:buyVol});
                }
            }

            // å¾ªç¯
            for(let i=1; i<klines.length; i++) {
                const day = klines[i];
                // ä¹°å…¥
                if(idx >= 0 && idx < grids) {
                    let buyPrice = gridLines[idx];
                    if(day.low <= buyPrice) {
                        let unitMoney = capital / grids;
                        let vol = Math.floor(unitMoney / buyPrice / lotSize) * lotSize;
                        if (cash >= vol * buyPrice && vol > 0) {
                            cash -= (vol * buyPrice * (1+feeRate));
                            shares += vol;
                            trades.push({date: day.date, type:'BUY', price:buyPrice, vol:vol});
                            idx--;
                        }
                    }
                } else if (idx === grids) { // é«˜ä½å›è½
                    let buyPrice = gridLines[grids-1];
                    if(day.low <= buyPrice) {
                        let unitMoney = capital / grids;
                        let vol = Math.floor(unitMoney / buyPrice / lotSize) * lotSize;
                        if (cash >= vol * buyPrice && vol > 0) {
                            cash -= (vol * buyPrice * (1+feeRate));
                            shares += vol;
                            trades.push({date: day.date, type:'BUY', price:buyPrice, vol:vol});
                            idx--;
                        }
                    }
                }
                // å–å‡º
                if(idx < grids) {
                    let sellPrice = gridLines[idx+1];
                    if(day.high >= sellPrice) {
                        let unitMoney = capital / grids;
                        let vol = Math.floor(unitMoney / sellPrice / lotSize) * lotSize;
                        let actualSell = Math.min(shares, vol);
                        if(actualSell >= lotSize) {
                            let money = actualSell * sellPrice;
                            cash += (money * (1-feeRate));
                            shares -= actualSell;
                            trades.push({date: day.date, type:'SELL', price:sellPrice, vol:actualSell});
                            idx++;
                        }
                    }
                }
                let val = cash + shares * day.close;
                history.push({date: day.date, val: val, close: day.close});
            }

            // ç»“æœç»Ÿè®¡
            let finalVal = history[history.length-1].val;
            let ret = (finalVal - capital) / capital * 100;
            let stockRet = (klines[klines.length-1].close - klines[0].close) / klines[0].close * 100;
            
            document.getElementById('res-ret').innerText = ret.toFixed(2) + '%';
            document.getElementById('res-ret').className = 'stat-val ' + (ret>=0?'win':'loss');
            document.getElementById('res-stock').innerText = stockRet.toFixed(2) + '%';
            document.getElementById('res-stock').className = 'stat-val ' + (stockRet>=0?'win':'loss');
            document.getElementById('res-count').innerText = trades.length;

            debug("å›æµ‹å®Œæˆï¼Œæ¸²æŸ“å›¾è¡¨...");
            renderChart(history, gridLines, trades);

        } catch (e) {
            debug("âŒ " + e.message, 'err');
            alert(e.message);
        }
    }

    function renderChart(history, lines, trades) {
        const dom = document.getElementById('chart-box');
        let chart = echarts.getInstanceByDom(dom);
        if(chart) chart.clear(); else chart = echarts.init(dom);

        const dates = history.map(x=>x.date);
        const vals = history.map(x=>x.val);
        const closes = history.map(x=>x.close);
        const startVal = history[0].val;
        const startClose = history[0].close;
        const normVal = vals.map(v => v / startVal * startClose);

        const marks = trades.map(t => ({
            coord: [t.date, t.price],
            value: t.type==='BUY'?'ä¹°':'å–',
            itemStyle: { color: t.type.includes('BUY')||t.type==='å»ºä»“'?'#d32f2f':'#2e7d32' }
        }));

        const gridMarkLines = lines.map(p => ({ yAxis: p, lineStyle: { type: 'solid', color: 'rgba(0,0,255,0.1)', width: 1 }, label: { show: false } }));

        const option = {
            animation: false,
            tooltip: { trigger: 'axis', axisPointer:{type:'cross'} },
            legend: { top: 0, data: ['è‚¡ä»·', 'ç­–ç•¥å‡€å€¼(å½’ä¸€åŒ–)'] },
            grid: { left: '3%', right: '3%', bottom: '10%', top: '10%', containLabel: true },
            dataZoom: [{type:'inside'}, {type:'slider', bottom:0}],
            xAxis: { type: 'category', data: dates },
            yAxis: { type: 'value', scale: true, splitLine:{show:false} },
            series: [
                {
                    name: 'è‚¡ä»·', type: 'line', data: closes,
                    smooth: true, lineStyle: { width: 1.5, color: '#333' },
                    markPoint: { data: marks, symbolSize: 10 },
                    markLine: { symbol: 'none', data: gridMarkLines, silent: true }
                },
                {
                    name: 'ç­–ç•¥å‡€å€¼(å½’ä¸€åŒ–)', type: 'line', data: normVal,
                    smooth: true, lineStyle: { width: 2, color: '#d32f2f' },
                    symbol: 'none'
                }
            ]
        };
        chart.setOption(option);
        window.onresize = chart.resize;
    }
</script>
</body>
</html>
