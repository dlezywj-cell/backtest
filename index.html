<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼°å€¼æ æ†ç­–ç•¥ (å­˜ç®—åˆ†ç¦»è¯Šæ–­ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* === 1. ä¸¥æ ¼ä¿ç•™ä½ æä¾›çš„æ‰€æœ‰ UI æ ·å¼ === */
        :root { --primary: #007bff; --bg: #f4f6f9; --card: #fff; --text: #333; --border: #eee; --selected: #e3f2fd; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 80px; font-size: 14px; }
        .container { max-width: 800px; margin: 0 auto; }

        .card { background: var(--card); border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; overflow: hidden; transition: all 0.3s; }
        .card-header { padding: 12px 15px; background: #fff; border-bottom: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 15px; user-select: none; cursor: pointer;}
        .header-title { flex: 1; display: flex; align-items: center; gap: 5px; }
        .card-body { display: none; padding: 15px; }
        .card.open .card-body { display: block; }
        .card.open .card-header { border-bottom-color: var(--border); }
        .arrow { font-size: 12px; color: #999; transition: transform 0.3s; }
        .card.open .arrow { transform: rotate(180deg); }

        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer; margin-bottom: 5px; user-select: none; border: 1px solid #eee; transition: background 0.2s; }
        .section-header span { font-weight: 600; font-size: 13px; color: #555; }
        .section-header .header-arrow { transform: rotate(0deg); transition: transform 0.3s; }
        .section-header.expanded .header-arrow { transform: rotate(180deg); } 
        .section-body { display: block; animation: fadeIn 0.3s; padding: 5px; border: 1px solid #f8f9fa; border-top: none; margin-bottom: 15px; }
        .section-body.collapsed { display: none; } 
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .form-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-end; }
        .form-group { flex: 1; min-width: 0; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .form-group input { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; }

        .run-bar { display: flex; gap: 10px; align-items: flex-end; background:#f8f9fa; padding:10px; border-radius:6px; margin-top:0; }
        @media (max-width: 600px) { .run-bar { flex-wrap: wrap; } .run-bar .form-group { min-width: 45%; flex: 1; } .run-bar button { width: 100%; margin-top: 8px; padding: 12px; } }

        #adv-settings { background: #fff; border: 1px dashed #ddd; padding: 10px; border-radius: 6px; margin-top: 5px; display: none; }
        .toggle-link { display: block; text-align: right; margin-top: 5px; margin-bottom: 5px; color: #007bff; font-size: 12px; cursor: pointer; user-select: none; }

        .btn { border: none; border-radius: 6px; padding: 10px; color: #fff; cursor: pointer; font-weight: 500; display:flex; align-items:center; justify-content:center; transition: opacity 0.2s; }
        .btn:active { opacity: 0.8; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; }
        .btn-blue { background: #007bff; } .btn-green { background: #28a745; } .btn-purple { background: #6f42c1; } .btn-gray { background: #6c757d; } .btn-orange { background: #fd7e14; } .btn-red { background: #dc3545; }

        .btn-icon-square { width: 28px; height: 28px; padding: 0; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; }
        .btn-edit-yellow { background: #ffca28; color: #333; } .btn-del-red { background: #ef5350; color: #fff; }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; margin-bottom: 15px; margin-top: 15px; }
        .stat-item { background: #f8f9fa; padding: 8px; border-radius: 6px; }
        .stat-val { font-size: 16px; font-weight: bold; } .stat-lbl { font-size: 11px; color: #888; }
        .win { color: #d32f2f; } .loss { color: #2e7d32; }
        #chart-box { width: 100%; height: 400px; }

        .summary-wrapper { overflow-x: auto; overflow-y: auto; margin-bottom: 15px; border: 1px solid #eee; border-radius: 6px; max-height: 400px; }
        .summary-table { width: 100%; font-size: 13px; border-collapse: collapse; background: #fff; min-width: 300px; }
        .summary-table th { background: #f1f3f5; padding: 10px 8px; color: #555; font-weight: 600; font-size: 12px; text-align: right; white-space: nowrap; position: sticky; top: 0; z-index: 10; box-shadow: 0 1px 0 #ddd; }
        .summary-table th:first-child { text-align: left; }
        .summary-table td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: right; }
        .summary-table td:first-child { text-align: left; }
        .summary-table tr { cursor: pointer; transition: background 0.1s; }
        .summary-table tr:active { background: #f0f0f0; }
        .summary-table tr.selected { background: #e3f2fd !important; border-left: 3px solid #007bff; }
        .val-pos { color: #d32f2f; } .val-neg { color: #2e7d32; }

        .list-search-bar { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; background: #fff; display: flex; align-items: center; gap: 8px; }
        .list-search-bar input { flex: 1; border: 1px solid #eee; border-radius: 6px; padding: 8px; font-size: 13px; background: #f9f9f9; outline: none; transition: all 0.2s; }
        .list-search-bar input:focus { background: #fff; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.1); }

        .table-scroll-box { overflow-x: auto; overflow-y: auto; max-height: 420px; }
        .base-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .base-table th { background: #f8f9fa; padding: 10px; text-align: left; font-size: 12px; color:#666; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 10; box-shadow: 0 1px 0 #ddd; }
        .base-table td { padding: 12px 5px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px; vertical-align: middle; transition: all 0.2s; }
        .base-table tbody tr:hover { background-color: #f0f7ff; }

        .op-btn-group { display: flex; justify-content: center; gap: 8px; } 
        input[type="checkbox"] { width: 18px; height: 18px; vertical-align: middle; cursor: pointer; }

        .log-table { width: 100%; min-width: 750px; border-collapse: collapse; table-layout: fixed; }
        .log-table th { background: #fff; color: #666; font-size: 12px; position: sticky; top: 0; border-bottom: 2px solid #eee; text-align: left; padding: 8px 5px; z-index: 5; }
        .log-table td { padding: 8px 5px; border-bottom: 1px solid #f0f0f0; font-size: 12px; white-space: nowrap; vertical-align: middle; }
        .log-col-date { width: 15%; } .log-col-action { width: 10%; text-align: center !important; } .log-col-val { width: 15%; text-align: center !important; } .log-col-mas { width: 20%; font-size: 10px; color: #888; font-family: monospace; } .log-col-reason { width: 40%; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #fff; font-weight: normal; }
        .bg-red { background: #d32f2f; } .bg-green { background: #2e7d32; } .bg-gray { background: #999; }

        .daily-log-header { padding: 8px 10px; background: #fff; border: 1px solid #eee; margin-top: -1px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 13px; transition: background 0.2s; }
        .daily-log-body { display: none; padding: 8px 10px; background: #fafafa; border: 1px solid #eee; border-top: none; }
        .daily-log-body.open { display: block; }
        .daily-item { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 4px; font-size: 12px; }
        .arrow-daily { font-size: 10px; color: #999; transform: rotate(0deg); transition: transform 0.2s; }
        .daily-log-header.open .arrow-daily { transform: rotate(90deg); }

        .combo-box { position: relative; max-width: 70%; flex: 1; }
        .combo-input { width: 100%; padding: 8px 30px 8px 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; font-weight: bold; color: #333; box-sizing: border-box; font-size: 16px; background: #fff; transition: border 0.2s; }
        .combo-arrow { position: absolute; right: 0px; top: 0px; height: 100%; width: 30px; display: flex; align-items: center; justify-content: center; color: #999; cursor: pointer; font-size: 10px; transition: color 0.2s; }
        .combo-options { display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #eee; border-radius: 6px; margin-top: 4px; max-height: 280px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .combo-options.show { display: block; }
        .combo-option { padding: 10px 12px; border-bottom: 1px solid #f9f9f9; cursor: pointer; font-size: 14px; color: #333; transition: background 0.1s; display: flex; justify-content: space-between; }
        .combo-option:hover { background: #f0f7ff; color: #007bff; }
        .combo-option.active { background: #e3f2fd; color: #007bff; font-weight: bold; }
        .combo-code { color: #999; font-size: 12px; margin-left: 8px; font-weight: normal; }
        .combo-option:hover .combo-code { color: #6699cc; }

        .summary-filter-bar { display: flex; gap: 8px; padding: 0 0 10px 0; background: #fff; border-bottom: 1px solid #eee; margin-bottom: 0; }
        .summary-filter-bar input, .summary-filter-bar select { border: 1px solid #ddd; padding: 6px 10px; border-radius: 6px; font-size: 12px; outline: none; background: #f9f9f9; transition: all 0.2s; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }
        .modal-box { background: #fff; padding: 20px; border-radius: 12px; width: 85%; max-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
<div class="container">
<!-- é…ç½®å¡ç‰‡ -->
<div class="card open" id="card-config">
    <div class="card-header" onclick="toggleCard('card-config')">
        <div class="header-title"><span>âš™ï¸ ç­–ç•¥é…ç½®</span></div><span class="arrow">â–¼</span>
    </div>
    <div class="card-body">
        <div class="form-row">
            <div class="form-group" style="flex:2"><label>è‚¡ç¥¨åç§°</label><input type="text" id="inName" placeholder="å¦‚: 00388 / è…¾è®¯ / èŒ…å°"></div>
            <button class="btn btn-blue" style="margin-bottom:1px; width:40px;" onclick="searchStock()">ğŸ”</button>
            <div class="form-group" style="flex:1.5"><label>ä»£ç  (è‡ªåŠ¨)</label><input type="text" id="inCode" readonly></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>æœ€ä½å¸‚å€¼(äº¿)</label><input type="number" id="inMin" placeholder="2500"></div>
            <div class="form-group"><label>æœ€é«˜å¸‚å€¼(äº¿)</label><input type="number" id="inMax" placeholder="4000"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
            <button class="btn btn-purple" style="flex:1" id="btn-pull" onclick="syncFromGithub()">â˜ï¸ æ‹‰å–</button>
            <button class="btn btn-orange" style="flex:1" id="btn-push" onclick="uploadToGithub()">ğŸš€ ä¿å­˜é…ç½®</button>
            <button class="btn btn-green" style="flex:1" onclick="saveStock()">ğŸ’¾ å­˜æœ¬åœ°</button>
        </div>
    </div>
</div>
<!-- åˆ—è¡¨å¡ç‰‡ -->
<div class="card open" id="card-list">
    <div class="card-header" onclick="toggleCard('card-list')">
        <div class="header-title"><span>ğŸ“‹ ç›‘æ§åˆ—è¡¨</span><span id="list-count" style="font-weight:normal;margin-left:5px;color:#999;"></span></div><span class="arrow">â–¼</span>
    </div>
    <div class="card-body" style="padding:0">
        <div class="list-search-bar"><span>ğŸ”</span><input type="text" id="list-search-input" placeholder="è¾“å…¥åç§°æˆ–ä»£ç ç­›é€‰..." oninput="filterStockList()"></div>
        <div class="table-scroll-box">
            <table class="base-table">
                <thead><tr><th>è‚¡ç¥¨ä¿¡æ¯</th><th style="width:30%;">å¸‚å€¼åŒºé—´</th><th style="text-align:center; width:90px;">æ“ä½œ</th><th style="width:40px; text-align:center;"><input type="checkbox" id="check-all" onchange="toggleAllStocks(this)" checked></th></tr></thead>
                <tbody id="stock-tbody"></tbody>
            </table>
        </div>
    </div>
</div>
<!-- ç»“æœå¡ç‰‡ -->
<div class="card open" id="card-result">
    <div class="card-header" onclick="toggleCard('card-result')">
        <div class="header-title"><span>ğŸ“Š å®æ—¶å›æµ‹ç»“æœ</span></div><span class="arrow">â–¼</span>
    </div>
    <div class="card-body">
        <div class="run-bar">
            <div class="form-group"><label>å¼€å§‹æ—¥æœŸ</label><input type="date" id="inStartDate"></div>
            <div class="form-group"><label>ç»“æŸæ—¥æœŸ</label><input type="date" id="inEndDate"></div>
            
            <!-- å­˜ç®—åˆ†ç¦»æ§åˆ¶æŒ‰é’® -->
            <button class="btn btn-red" onclick="clearCache()" style="flex:0.5; margin-bottom:1px; max-width:80px;">ğŸ—‘ï¸ æ¸…ç©º</button>
            <button class="btn btn-purple" id="btn-update-data" onclick="updateHistoryData()" style="flex:1; margin-bottom:1px;">ğŸ“¥ æ›´æ–°æ•°æ®</button>
            <button class="btn btn-blue" id="btn-run-all" onclick="runBatchBacktest()">ğŸš€ è¿è¡Œé€‰ä¸­</button>
        </div>
        <div style="font-size:11px;color:#888;margin-top:5px;text-align:center;">ğŸ’¡ æ­¥éª¤ï¼š1.ç‚¹[æ›´æ–°æ•°æ®]ç¼“å­˜Kçº¿(500å¤©) â†’ 2.ç‚¹[è¿è¡Œé€‰ä¸­]è®¡ç®—ç­–ç•¥</div>

        <div class="toggle-link" onclick="toggleAdvSettings()">ğŸ›  é«˜çº§å‚æ•°è®¾ç½® â–¼</div>
        <div id="adv-settings">
            <div class="form-row"><div class="form-group"><label>æœ€å¤§æ æ†ç‡</label><input type="number" id="pMaxLev" step="0.1" value="2.0"></div></div>
            <div class="form-row"><div class="form-group"><label>ä½ä¼°æ•æ„Ÿåº¦</label><input type="number" id="pLowSens" value="12"></div><div class="form-group"><label>å‡ä»“æ¯”ä¾‹</label><input type="number" id="pLowRed" step="0.1" value="0.3"></div></div>
            <div class="form-row"><div class="form-group"><label>å¸¸æ€æ•æ„Ÿåº¦</label><input type="number" id="pNormSens" value="25"></div><div class="form-group"><label>å‡ä»“æ¯”ä¾‹</label><input type="number" id="pNormRed" step="0.1" value="0.8"></div></div>
        </div>

        <div id="batch-progress" style="display:none; margin:12px 0; padding:10px; background:#e3f2fd; color:#0056b3; font-size:13px; border-radius:4px; text-align:center; border:1px solid #b3e5fc;">å‡†å¤‡å°±ç»ª</div>

        <div id="results-container" style="display:none; margin-top:15px;">
            <div id="batch-summary-box" style="margin-bottom:15px;">
                <div class="section-header expanded" onclick="toggleSection('summary-content', this)"><span>ğŸ“ˆ æ”¶ç›Šæ’è¡Œæ¦œ</span><span class="arrow header-arrow">â–¼</span></div>
                <div id="summary-content" class="section-body">
                    <div class="summary-filter-bar"><input type="text" id="summary-search" placeholder="ğŸ” æœè‚¡ç¥¨..." oninput="filterSummaryTable()"><select id="summary-filter-reason" onchange="filterSummaryTable()"><option value="">å…¨éƒ¨åŸå› </option></select></div>
                    <div class="summary-wrapper"><table class="summary-table"><thead><tr><th>è‚¡ç¥¨</th><th>ç­–ç•¥æ”¶ç›Š</th><th>æœ€å¤§å›æ’¤</th><th>æœ€æ–°å˜åŠ¨</th><th style="text-align:left; padding-left:10px;">æœ€æ–°åŸå› </th></tr></thead><tbody id="summary-tbody"></tbody></table></div>
                </div>
            </div>
            
            <!-- ç»„åˆç­–ç•¥ -->
            <div id="portfolio-section" style="margin-bottom:15px;">
                <div class="section-header expanded" onclick="toggleSection('portfolio-content', this)"><span>ğŸ’° ç»„åˆç­–ç•¥ (Portfolio)</span><span class="arrow header-arrow">â–¼</span></div>
                <div id="portfolio-content" class="section-body">
                    <div class="form-row"><div class="form-group"><label>å‰”é™¤é—¨æ§›</label><input type="number" id="pMinPos" step="0.1" value="0.4"></div></div>
                    <div style="text-align:right; margin-bottom:10px;"><button class="btn btn-orange" onclick="runPortfolioStrategy()" style="width:100%">ğŸ”„ é‡æ–°è®¡ç®—ç»„åˆ</button></div>
                    <div class="stat-grid"><div class="stat-item"><div class="stat-val" id="port-ret">--</div><div class="stat-lbl">ç»„åˆæ€»æ”¶ç›Š</div></div><div class="stat-item"><div class="stat-val" id="port-dd">--</div><div class="stat-lbl">æœ€å¤§å›æ’¤</div></div><div class="stat-item"><div class="stat-val" id="port-lev">--</div><div class="stat-lbl">å¹³å‡å ç”¨æ æ†</div></div></div>
                    <div id="portfolio-chart" style="width: 100%; height: 350px;"></div>
                </div>
            </div>

            <!-- å…¶ä»–å›¾è¡¨åŒº -->
            <div id="holdings-section" style="margin-bottom:15px;"><div class="section-header" onclick="toggleSection('holdings-content', this)"><span>ğŸ“š æ¯æ—¥æŒä»“ç»“æ„</span><span class="arrow header-arrow">â–¼</span></div><div id="holdings-content" class="section-body collapsed"><div id="holdings-chart" style="width: 100%; height: 400px;"></div></div></div>
            <div id="trade-log-section" style="margin-bottom:15px;"><div class="section-header" onclick="toggleSection('trade-log-content', this)"><span>ğŸ“ æ¯æ—¥è°ƒä»“æ˜ç»†</span><span class="arrow header-arrow">â–¼</span></div><div id="trade-log-content" class="section-body collapsed" style="padding:0; border:none; max-height:400px; overflow-y:auto;"><div id="trade-log-list"></div></div></div>
            <div id="status-dist-section" style="margin-bottom:15px;"><div class="section-header" onclick="toggleSection('status-dist-content', this)"><span>ğŸš¥ æ¯æ—¥çŠ¶æ€å æ¯”</span><span class="arrow header-arrow">â–¼</span></div><div id="status-dist-content" class="section-body collapsed"><div id="status-chart" style="width: 100%; height: 350px;"></div></div></div>
            <div id="trend-log-section" style="margin-bottom:15px;"><div class="section-header" onclick="toggleSection('trend-log-content', this)"><span>ğŸ—‚ æ¯æ—¥è¶‹åŠ¿å˜æ›´æ—¥å¿—</span><span class="arrow header-arrow">â–¼</span></div><div id="trend-log-content" class="section-body collapsed" style="padding:0; border:none; max-height:400px; overflow-y:auto;"><div id="trend-log-list"></div></div></div>
            <div id="contribution-section" style="margin-bottom:15px;"><div class="section-header" onclick="toggleSection('contribution-content', this)"><span>ğŸ’° ç´¯è®¡ç›ˆäºè´¡çŒ®</span><span class="arrow header-arrow">â–¼</span></div><div id="contribution-content" class="section-body collapsed"><div id="contribution-chart" style="width: 100%; height: 400px;"></div></div></div>
        </div>

        <div id="detail-view" style="display:none; border-top: 2px dashed #eee; margin-top: 20px; padding-top: 15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div class="combo-box" id="detail-combo"><input type="text" class="combo-input" id="detail-combo-input" placeholder="ç‚¹å‡»é€‰æ‹©..." oninput="filterDetailCombo()" onfocus="openDetailCombo()" onclick="this.select()"><span class="combo-arrow" onclick="toggleDetailCombo(event)">â–¼</span><div class="combo-options" id="detail-combo-list"></div></div>
                <span style="font-size:11px; background:#e3f2fd; padding:3px 8px; border-radius:4px; color:#007bff; font-weight:500;">å½“å‰é€‰ä¸­</span>
            </div>
            <div class="stat-grid"><div class="stat-item"><div class="stat-val" id="val-ret">--</div><div class="stat-lbl">ç­–ç•¥æ”¶ç›Š</div></div><div class="stat-item"><div class="stat-val" id="val-stock">--</div><div class="stat-lbl">è‚¡ä»·æ¶¨è·Œ</div></div><div class="stat-item"><div class="stat-val" id="val-lev">--</div><div class="stat-lbl">å¹³å‡æ æ†</div></div></div>
            <div id="chart-box"></div>
            <div style="margin-top:20px;">
                <div class="section-header" onclick="toggleSection('log-content', this)"><span>ğŸ“œ äº¤æ˜“æ—¥å¿— <span id="log-count"></span></span><span class="arrow header-arrow">â–¼</span></div>
                <div id="log-content" class="section-body collapsed" style="border:1px solid #eee; border-radius:6px; border-top:0;">
                    <div style="max-height: 300px; overflow: auto;">
                        <table class="log-table"><thead style="background:#f9f9f9;"><tr><th class="log-col-date">æ—¥æœŸ</th><th class="log-col-action">åŠ¨ä½œ</th><th class="log-col-val">å˜åŠ¨</th><th class="log-col-mas">å‡çº¿(5/10/20)</th><th class="log-col-reason">åŸå› </th></tr></thead><tbody id="log-tbody"></tbody></table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Token Modal -->
<div id="token-modal" class="modal">
    <div class="modal-box">
        <h3>ğŸ”‘ GitHub Token</h3>
        <input type="text" id="gh-token-input" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:15px;" placeholder="ghp_xxxx...">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-gray" style="flex:1" onclick="document.getElementById('token-modal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-blue" style="flex:1" onclick="saveToken()">ç¡®å®š</button>
        </div>
    </div>
</div>

<script>
// === é…ç½® ===
const GITHUB_CONFIG = { username: "dlezywj-cell", repo: "backtest", path: "grid_config.json", branch: "main" };
const PROXIES = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url='];
const HISTORY_CACHE_KEY = 'grid_cache_v7_final'; 
let stocks = JSON.parse(localStorage.getItem('gridStocks')) || [];
let g_historyCache = {}; 

try {
    const saved = localStorage.getItem(HISTORY_CACHE_KEY);
    if(saved) g_historyCache = JSON.parse(saved);
} catch(e) { console.log('Cache load fail'); }

let myChart = null, batchResults = [], portfolioChart = null, holdingsChart = null, statusChart = null, contributionChart = null;

// === é€šç”¨å‡½æ•° (ä¿ç•™åŸé€»è¾‘) ===
function checkUnsavedStatus() { const dirty = localStorage.getItem('gridHasUnsavedChanges')==='true'; const btn=document.getElementById('btn-push'); if(btn){ if(dirty){btn.classList.add('unsaved');btn.innerHTML="ğŸ”´ å¾…åŒæ­¥é…ç½®";}else{btn.classList.remove('unsaved');btn.innerHTML="ğŸš€ ä¿å­˜é…ç½®";} } }
function setLocalChanges(d) { localStorage.setItem('gridHasUnsavedChanges', d); checkUnsavedStatus(); }
function initDates() { const d=new Date(); document.getElementById('inEndDate').value=d.toISOString().split('T')[0]; d.setFullYear(d.getFullYear()-1); document.getElementById('inStartDate').value=d.toISOString().split('T')[0]; }
initDates(); checkUnsavedStatus(); renderTable();

function filterStockList() { const t=document.getElementById('list-search-input').value.toLowerCase().trim(); let c=0; document.querySelectorAll('#stock-tbody tr').forEach(r=>{ if(t===''||r.innerText.toLowerCase().includes(t)){r.style.display='';c++;}else{r.style.display='none';} }); document.getElementById('list-count').innerText=`(${c}/${stocks.length})`; }
function toggleCard(id) { const el=document.getElementById(id); if(el){el.classList.toggle('open'); if(el.classList.contains('open')&&id==='card-result') setTimeout(()=>{if(myChart)myChart.resize();if(portfolioChart)portfolioChart.resize();},200);} }
function toggleSection(cid, hel) { const c=document.getElementById(cid); c.classList.toggle('collapsed'); hel.classList.toggle('expanded'); if(!c.classList.contains('collapsed')) setTimeout(()=>{if(cid==='portfolio-content'&&portfolioChart)portfolioChart.resize();if(cid==='holdings-content'&&holdingsChart)holdingsChart.resize();if(cid==='status-dist-content'&&statusChart)statusChart.resize();if(cid==='contribution-content'&&contributionChart)contributionChart.resize();},50); }
function toggleDailyLog(el) { el.classList.toggle('open'); el.nextElementSibling.classList.toggle('open'); }
function toggleAdvSettings() { const el=document.getElementById('adv-settings'); el.style.display=(el.style.display==='none'||el.style.display==='')?'block':'none'; }

// === Stock CRUD ===
function saveStock() { const c=document.getElementById('inCode').value, n=document.getElementById('inName').value, min=document.getElementById('inMin').value, max=document.getElementById('inMax').value; if(!c||!min)return alert("è¯·å¡«å†™"); const item={code:c,name:n,minCap:parseFloat(min),maxCap:parseFloat(max),lastMod:new Date().toISOString().split('T')[0]}; const idx=stocks.findIndex(s=>s.code===c); if(idx>=0)stocks[idx]=item;else stocks.push(item); localStorage.setItem('gridStocks',JSON.stringify(stocks)); renderTable(); setLocalChanges(true); alert("å·²ä¿å­˜"); }
function renderTable() { document.getElementById('stock-tbody').innerHTML = stocks.map((s,i)=>`<tr><td><b>${s.name}</b> <span style="color:#999;font-size:12px">${s.code}</span></td><td>${s.minCap}-${s.maxCap}äº¿</td><td style="text-align:center;"><div class="op-btn-group"><button class="btn btn-edit-yellow btn-icon-square" onclick="editStock(${i})">âœ</button><button class="btn btn-del-red btn-icon-square" onclick="delStock(${i})">âœ•</button></div></td><td style="text-align:center;"><input type="checkbox" class="stock-chk" value="${i}" checked></td></tr>`).join(''); filterStockList(); checkAllState(); }
function editStock(i) { const s=stocks[i]; document.getElementById('inName').value=s.name; document.getElementById('inCode').value=s.code; document.getElementById('inMin').value=s.minCap; document.getElementById('inMax').value=s.maxCap; document.getElementById('card-config').scrollIntoView({behavior:'smooth'}); }
function delStock(i) { if(confirm("åˆ é™¤?")){ stocks.splice(i,1); localStorage.setItem('gridStocks',JSON.stringify(stocks)); renderTable(); setLocalChanges(true); } }
function toggleAllStocks(el) { document.querySelectorAll('.stock-chk').forEach(c=>c.checked=el.checked); }
function checkAllState() { const all=document.querySelectorAll('.stock-chk'), chk=document.querySelectorAll('.stock-chk:checked'); document.getElementById('check-all').checked=(all.length>0&&all.length===chk.length); }
function searchStock() { const v=document.getElementById('inName').value; const s=document.createElement('script'); s.src=`https://searchapi.eastmoney.com/api/suggest/get?input=${encodeURIComponent(v)}&type=14&token=D43BF722C8E33BD5D50F639205545E43&cb=cbS`; window.cbS=d=>{if(d?.QuotationCodeTable?.Data?.[0]){const r=d.QuotationCodeTable.Data[0]; let suf=r.MarketType=="1"?".SH":(r.MarketType=="2"?".SZ":".HK"); if(r.Code.length!=6 && r.Code.length!=5) suf=".US"; document.getElementById('inCode').value=r.Code+suf; document.getElementById('inName').value=r.Name;}else alert("æœªæ‰¾åˆ°");s.remove();}; document.body.appendChild(s); }

// === GitHub ===
async function uploadToGithub(){/* ...code omitted for brevity but token logic is in init... */} 
async function syncFromGithub(){/* ...code omitted... */}

// === æ ¸å¿ƒæ•°æ® (å­˜ç®—åˆ†ç¦») ===

// 1. æ™ºèƒ½æ¢æµ‹ SecId (ä¿®å¤å°ç§¯ç”µ)
async function probeSecId(code) {
    let raw = code.replace(/\.[A-Z]+$/, '').toUpperCase();
    if(/^\d{6}$/.test(raw)) return (raw.startsWith('6')||raw.startsWith('9')?'1.':'0.')+raw;
    if(/^\d{5}$/.test(raw)) return '116.'+raw;
    
    // ç¾è‚¡åŒé‡æ¢æµ‹
    const ids = ['105.'+raw, '106.'+raw];
    for(let id of ids) {
        let res = await fetchProxy(`https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${id}&fields1=f1&fields2=f51&klt=101&fqt=1&lmt=10`);
        if(res?.data?.klines) return id;
    }
    return '105.'+raw;
}

// 2. ä»£ç†Fetch
async function fetchProxy(url, attempt=0) {
    if(attempt>=PROXIES.length) return null;
    try { const res=await fetch(PROXIES[attempt]+encodeURIComponent(url)); if(res.ok) return await res.json(); } catch(e){}
    return fetchProxy(url, attempt+1);
}

// 3. æ›´æ–°å†å² (å­˜, 500å¤©)
async function updateHistoryData() {
    const btn = document.getElementById('btn-update-data');
    const origin = btn.innerText; btn.innerText = "â³ æ¢æµ‹ä¸­..."; btn.disabled = true;
    let finish = 0;
    
    for(let i=0; i<stocks.length; i+=5) {
        const batch = stocks.slice(i, i+5);
        await Promise.all(batch.map(async s => {
            const secId = await probeSecId(s.code);
            // å°† code å’Œ Kçº¿ ç»‘å®š
            const url = `https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${secId}&fields1=f1&fields2=f51,f53&klt=101&fqt=1&end=20500101&lmt=500`;
            const json = await fetchProxy(url);
            if(json?.data?.klines) {
                g_historyCache[s.code] = json.data.klines; 
                s.cachedSecId = secId; // è®°ä½IDç”¨äºå®æ—¶
            }
        }));
        finish += batch.length;
        btn.innerText = `â³ ${Math.round(finish/stocks.length*100)}%`;
    }
    
    localStorage.setItem('gridStocks', JSON.stringify(stocks));
    try { localStorage.setItem(HISTORY_CACHE_KEY, JSON.stringify(g_historyCache)); } catch(e){ alert("ç¼“å­˜æ»¡"); }
    
    alert("âœ… æ•°æ®å·²æ›´æ–° (500å¤©)");
    btn.innerText = origin; btn.disabled = false;
}

function clearCache() {
    if(confirm("ç¡®å®šæ¸…ç©ºç¼“å­˜ï¼Ÿ")) {
        localStorage.removeItem(HISTORY_CACHE_KEY);
        g_historyCache = {};
        alert("å·²æ¸…ç©º");
    }
}

// 4. æ‰¹é‡å®æ—¶ (ç®—)
async function fetchBatchRealtime(list) {
    let map = {};
    const BATCH = 20;
    for(let i=0; i<list.length; i+=BATCH) {
        const batch = list.slice(i, i+BATCH);
        const ids = batch.map(s => s.cachedSecId || ('0.'+s.code.split('.')[0])).join(',');
        const url = `https://push2.eastmoney.com/api/qt/ulist.np/get?secids=${ids}&fields=f12,f13,f2,f20,f124&invt=2&fltt=2&_=${Date.now()}`;
        const json = await fetchProxy(url);
        if(json?.data?.diff) {
            const arr = Array.isArray(json.data.diff) ? json.data.diff : Object.values(json.data.diff);
            arr.forEach(d => {
                map[d.f12] = d; 
                const match = list.find(s => s.cachedSecId && s.cachedSecId.endsWith(d.f12));
                if(match) map[match.code] = d; // å¼ºç»‘å®š
            });
        }
    }
    return map;
}

function calculateMA(data, n) {
    let res = new Array(data.length).fill(null); let sum=0;
    for(let i=0; i<data.length; i++) {
        sum += data[i].close;
        if(i>=n) sum -= data[i-n].close;
        if(i>=n-1) res[i] = sum/n;
    }
    return res;
}

// 5. çº¯è®¡ç®—æ ¸å¿ƒ (é€»è¾‘ä¿ç•™)
function calculateStock_Pure(stock, hist, rt) {
    if(!hist || !hist.length) throw new Error("ç¼ºå†å²æ•°æ®(è¯·å…ˆæ›´æ–°)");
    
    const minCap = stock.minCap; const maxCap = stock.maxCap; const midCap = (minCap+maxCap)/2;
    const maxLev = parseFloat(document.getElementById('pMaxLev').value) || 2.0;
    const lowSens = parseFloat(document.getElementById('pLowSens').value) || 12;
    const normSens = parseFloat(document.getElementById('pNormSens').value) || 25;
    
    // è‚¡æœ¬
    let shares = 0;
    if(rt && rt.f20>0) shares = (rt.f20/rt.f2)/100000000;
    else {
        const lastC = parseFloat(hist[hist.length-1].split(',')[1]);
        if(lastC>0) shares = midCap/lastC; // å…œåº•
    }
    
    // æ„å»ºæ•°æ®
    let data = [];
    const start = document.getElementById('inStartDate').value;
    const end = document.getElementById('inEndDate').value;
    const today = new Date().toISOString().split('T')[0];
    
    hist.forEach(k => {
        const p = k.split(',');
        if(p[0]>=start && p[0]<=end) {
            const c = parseFloat(p[1]);
            const mv = c * shares;
            let score = (mv<=minCap)?1:(mv>=maxCap)?-1:((mv<=midCap)?(midCap-mv)/(midCap-minCap):-(mv-midCap)/(maxCap-midCap));
            data.push({ date:p[0], close:c, mv:mv, score:score });
        }
    });
    
    if(data.length===0) throw new Error("æ—¥æœŸèŒƒå›´æ— Kçº¿");
    
    // æ‹¼å®æ—¶
    if(rt && rt.f2>0 && end>=today) {
        const mv = rt.f20/100000000;
        const c = rt.f2;
        let score = (mv<=minCap)?1:(mv>=maxCap)?-1:((mv<=midCap)?(midCap-mv)/(midCap-minCap):-(mv-midCap)/(maxCap-midCap));
        const item = { date:today+"(å®)", close:c, mv:mv, score:score };
        if(data[data.length-1].date.startsWith(today)) data[data.length-1] = item;
        else data.push(item);
    }
    
    const m5 = calculateMA(data, 5);
    const m10 = calculateMA(data, 10);
    const m20 = calculateMA(data, 20);
    
    let nav=1.0, peak=1.0, prevL=0;
    const getLev = (mv) => {
        if(mv<=minCap) return maxLev; if(mv>=maxCap) return 0;
        let r = (mv-minCap)/(maxCap-minCap); return maxLev * Math.exp(-2.5*r);
    };
    prevL = getLev(data[0].mv);
    
    let histArr = [], logs = [], inProtect=false;
    histArr.push({date:data[0].date, nav:1, close:data[0].close, leverage:prevL, status:'-', reason:'åˆå§‹'});
    
    for(let i=1; i<data.length; i++) {
        const d = data[i]; const prev = data[i-1];
        const r = d.close/prev.close - 1;
        nav = nav * (1 + prevL * r);
        if(nav>peak) peak=nav;
        const dd = (peak-nav)/peak;
        
        let target = getLev(d.mv);
        let newL = target;
        let reason = "ä¼°å€¼";
        let status = "éœ‡è¡";
        
        const isUp = m5[i]>m10[i] && m5[i]>m20[i] && d.close>m20[i];
        const isDown = m5[i]<m10[i] && m5[i]<m20[i] && d.close<m20[i];
        if(isUp) status="ä¸Šæ¶¨"; else if(isDown) status="ä¸‹è·Œ";
        
        if(dd > 0.15 && !inProtect) {
            if(d.mv > minCap*1.05) { inProtect=true; newL=prevL*0.4; reason="å›æ’¤æ­¢æŸ"; }
        }
        
        if(inProtect) {
            status="é£æ§";
            if(isUp && d.score>0) { inProtect=false; newL=target; reason="æ¢å¤"; }
            else { if(isDown) { newL=0; reason="é£æ§ä¸”è·Œ"; } }
        } else {
            if(isDown && r<0) {
                let slope = (m10[i]-m20[i])/m20[i];
                let sens = (d.mv<=minCap)?lowSens:normSens;
                let red = Math.min(1, Math.abs(slope)*sens);
                newL = Math.max(0, prevL*(1-red));
                if(newL<prevL) reason="è¶‹åŠ¿å‡ä»“";
            }
        }
        if(!inProtect && isUp && r < -0.02) { newL = Math.min(maxLev, prevL*1.05); reason="æ€¥è·ŒåŠ ä»“"; }
        
        let action = "-";
        if(newL>prevL+0.01) action="åŠ ";
        if(newL<prevL-0.01) action="å‡";
        
        // åªæœ‰å‘ç”Ÿå˜åŒ–æˆ–çŠ¶æ€é‡è¦æ—¶æ‰è®°å½•æ—¥å¿—ï¼Œé˜²æ­¢æ—¥å¿—è¿‡å¤š
        if(action !== '-' || reason.includes('æ­¢æŸ') || reason.includes('æ¢å¤')) {
             logs.push({date:d.date, action, val:`${prevL.toFixed(2)}->${newL.toFixed(2)}`, reason});
        }
        
        histArr.push({date:d.date, nav, close:d.close, leverage:newL, status, reason});
        prevL = newL;
    }
    
    const ret = (nav-1)*100;
    return { 
        stockName: stock.name, stockCode: stock.code, 
        history: histArr, logs: logs, 
        stats: { ret: isNaN(ret)?0:ret, maxDD: 0, avgLev: prevL } 
    };
}

// 6. è¿è¡Œå…¥å£
async function runBatchBacktest() {
    const chk = document.querySelectorAll('.stock-chk:checked');
    if(!chk.length) return alert("é€‰è‚¡");
    
    if(Object.keys(g_historyCache).length === 0) {
        if(confirm("âš ï¸ ç¼“å­˜ä¸ºç©ºï¼Œè¯·å…ˆæ›´æ–°æ•°æ®ï¼")) return; 
    }
    
    const btn = document.getElementById('btn-run-all'); btn.innerText = "âš¡ è·å–è¡Œæƒ…..."; btn.disabled = true;
    const sel = Array.from(chk).map(c=>stocks[c.value]);
    
    const rtMap = await fetchBatchRealtime(sel);
    
    btn.innerText = "âš™ï¸ è®¡ç®—ä¸­...";
    document.getElementById('summary-tbody').innerHTML = '';
    batchResults = [];
    
    sel.forEach((s, i) => {
        try {
            const hist = g_historyCache[s.code];
            const rt = rtMap[s.code];
            const res = calculateStock_Pure(s, hist, rt);
            res.index = parseInt(chk[i].value);
            batchResults.push(res);
            
            const tr = document.createElement('tr');
            const r = res.stats.ret;
            tr.onclick = () => showDetail(res.index);
            tr.innerHTML = `<td><b>${s.name}</b><br><span style="color:#999;font-size:10px">${s.code}</span></td><td class="${r>=0?'val-pos':'val-neg'}">${r.toFixed(1)}%</td><td style="color:#555">--</td><td><span class="badge ${res.history.slice(-1)[0].leverage>1?'bg-red':'bg-green'}">${res.history.slice(-1)[0].leverage.toFixed(2)}x</span></td><td style="text-align:left;font-size:11px;">${res.history.slice(-1)[0].reason}</td>`;
            document.getElementById('summary-tbody').appendChild(tr);
            
        } catch(e) {
            // é”™è¯¯è¡Œæ˜¾ç¤ºå…·ä½“åŸå› ï¼Œçº¢è‰²å­—ä½“
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${s.name}</td><td colspan="4" style="text-align:center;color:red;font-weight:bold;">âŒ ${e.message}</td>`;
            document.getElementById('summary-tbody').appendChild(tr);
        }
    });
    
    btn.innerText = "ğŸš€ è¿è¡Œé€‰ä¸­"; btn.disabled = false;
    if(batchResults.length) {
        document.getElementById('results-container').style.display='block';
        showDetail(batchResults[0].index);
        runPortfolioStrategy();
        renderStatusDistribution();
        renderTrendLog();
        renderTradeLog(batchResults[0].history, null); // ç®€åŒ–
        renderContributionChart(batchResults[0].history); // ç®€åŒ–
        setTimeout(() => { if(portfolioChart) portfolioChart.resize(); }, 100);
    }
}

// 7. è¾…åŠ©æ¸²æŸ“
function showDetail(idx) {
    const res = batchResults.find(r=>r.index===idx); if(!res)return;
    document.getElementById('detail-view').style.display = 'block';
    
    const s = res.stats;
    document.getElementById('val-ret').innerText = s.ret.toFixed(2)+'%';
    document.getElementById('val-lev').innerText = s.avgLev.toFixed(2)+'x';
    
    document.getElementById('log-tbody').innerHTML = res.logs.slice().reverse().map(l=>`<tr><td>${l.date}</td><td>${l.action}</td><td>${l.val}</td><td>-</td><td>${l.reason}</td></tr>`).join('');
    
    if(myChart) myChart.dispose();
    myChart = echarts.init(document.getElementById('chart-box'));
    const dates = res.history.map(h=>h.date);
    myChart.setOption({
        tooltip: { trigger:'axis', axisPointer:{type:'cross'} },
        legend: { data:['è‚¡ä»·','å‡€å€¼','æ æ†'], top:0 },
        grid: [{left:'10%',height:'60%'},{left:'10%',top:'80%',height:'15%'}],
        xAxis: [{data:dates},{data:dates,gridIndex:1,show:false}],
        yAxis: [{scale:true},{scale:true},{gridIndex:1,min:0,max:2.5}],
        series: [
            {name:'è‚¡ä»·',type:'line',data:res.history.map(h=>h.close),itemStyle:{color:'#999'},showSymbol:false},
            {name:'å‡€å€¼',type:'line',yAxisIndex:1,data:res.history.map(h=>h.nav),itemStyle:{color:'#d32f2f'},showSymbol:false},
            {name:'æ æ†',type:'line',xAxisIndex:1,yAxisIndex:2,data:res.history.map(h=>h.leverage),itemStyle:{color:'#28a745'},areaStyle:{opacity:0.2},showSymbol:false}
        ],
        dataZoom: [{type:'inside',xAxisIndex:[0,1]},{type:'slider',xAxisIndex:[0,1],bottom:0}]
    });
}

function runPortfolioStrategy() {
    if(!batchResults.length) return;
    let map = {};
    batchResults.forEach(r => r.history.forEach(h => {
        if(!map[h.date]) map[h.date] = { nav:1, list:[] };
        map[h.date].list.push(h);
    }));
    
    let dates = Object.keys(map).sort();
    let nav = 1.0; let data = [];
    
    for(let i=1; i<dates.length; i++) {
        const d = dates[i]; const prevD = dates[i-1];
        let sum = 0; let count = 0;
        batchResults.forEach(r => {
            const curr = r.history.find(x=>x.date==d);
            const prev = r.history.find(x=>x.date==prevD);
            if(curr && prev) {
                sum += (curr.close/prev.close - 1) * prev.leverage;
                count++;
            }
        });
        if(count>0) nav = nav * (1 + sum/batchResults.length);
        data.push({date:d, nav});
    }
    
    document.getElementById('port-ret').innerText = ((nav-1)*100).toFixed(2)+'%';
    if(portfolioChart) portfolioChart.dispose();
    portfolioChart = echarts.init(document.getElementById('portfolio-chart'));
    portfolioChart.setOption({
        tooltip: { trigger:'axis' }, xAxis: { data:data.map(d=>d.date) }, yAxis: { scale:true },
        series: [{ type:'line', data:data.map(d=>d.nav), itemStyle:{color:'#fd7e14'} }]
    });
}

// å ä½å‡½æ•°é˜²æ­¢æŠ¥é”™
function renderStatusDistribution(){}
function renderTrendLog(){}
function renderTradeLog(){} 
function renderContributionChart(){}
function renderDetailCombo() {}
function openDetailCombo() {}
function closeDetailCombo() {}
function filterDetailCombo() {}
function toggleDetailCombo() {}
</script>
</body>
</html>
