<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼°å€¼æ æ†ç­–ç•¥ (æé€Ÿæ¶æ„ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* === åŸºç¡€å˜é‡ === */
        :root { --primary: #007bff; --bg: #f4f6f9; --card: #fff; --text: #333; --border: #eee; --selected: #e3f2fd; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 80px; font-size: 14px; }
        .container { max-width: 800px; margin: 0 auto; }

        /* === å¡ç‰‡æ¡†æ¶ === */
        .card { background: var(--card); border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; overflow: hidden; transition: all 0.3s; }
        .card-header { padding: 12px 15px; background: #fff; border-bottom: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 15px; user-select: none; cursor: pointer;}
        .header-title { flex: 1; display: flex; align-items: center; gap: 5px; }

        .card-body { display: none; padding: 15px; }
        .card.open .card-body { display: block; }
        .card.open .card-header { border-bottom-color: var(--border); }

        .arrow { font-size: 12px; color: #999; transition: transform 0.3s; }
        .card.open .arrow { transform: rotate(180deg); }

        /* === åŒºåŸŸæŠ˜å å¤´ (Section) === */
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer; margin-bottom: 5px; user-select: none; border: 1px solid #eee; transition: background 0.2s; }
        .section-header:active { background: #e9ecef; }
        .section-header span { font-weight: 600; font-size: 13px; color: #555; }
        .section-header .header-arrow { transform: rotate(0deg); transition: transform 0.3s; }
        .section-header.expanded .header-arrow { transform: rotate(180deg); } 
        .section-body { display: block; animation: fadeIn 0.3s; padding: 5px; border: 1px solid #f8f9fa; border-top: none; margin-bottom: 15px; }
        .section-body.collapsed { display: none; } 
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* === è¡¨å•ä¸æŒ‰é’® === */
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-end; }
        .form-group { flex: 1; min-width: 0; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .form-group input { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; }

        .run-bar { display: flex; gap: 10px; align-items: flex-end; background:#f8f9fa; padding:10px; border-radius:6px; margin-top:0; flex-wrap: wrap; }
        .run-bar .form-group { min-width: 120px; }
        
        .btn { border: none; border-radius: 6px; padding: 10px; color: #fff; cursor: pointer; font-weight: 500; display:flex; align-items:center; justify-content:center; transition: opacity 0.2s; flex: 1; white-space: nowrap; }
        .btn:active { opacity: 0.8; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; }
        .btn-blue { background: #007bff; } .btn-green { background: #28a745; } .btn-purple { background: #6f42c1; } .btn-gray { background: #6c757d; }
        .btn-orange { background: #fd7e14; transition: all 0.3s ease; }
        .btn-orange.unsaved { background-color: #dc3545 !important; font-weight: 800; animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }

        .btn-icon-square { width: 28px; height: 28px; padding: 0; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; flex: none; }
        .btn-edit-yellow { background: #ffca28; color: #333; }
        .btn-del-red { background: #ef5350; color: #fff; }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; margin-bottom: 15px; margin-top: 15px; }
        .stat-item { background: #f8f9fa; padding: 8px; border-radius: 6px; }
        .stat-val { font-size: 16px; font-weight: bold; }
        .stat-lbl { font-size: 11px; color: #888; }
        .win { color: #d32f2f; } .loss { color: #2e7d32; }
        #chart-box { width: 100%; height: 400px; }

        .summary-wrapper { overflow-x: auto; overflow-y: auto; margin-bottom: 15px; border: 1px solid #eee; border-radius: 6px; max-height: 400px; }
        .summary-table { width: 100%; font-size: 13px; border-collapse: collapse; background: #fff; min-width: 300px; }
        .summary-table th { background: #f1f3f5; padding: 10px 8px; color: #555; font-weight: 600; font-size: 12px; text-align: right; white-space: nowrap; position: sticky; top: 0; z-index: 10; box-shadow: 0 1px 0 #ddd; }
        .summary-table th:first-child { text-align: left; }
        .summary-table td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: right; }
        .summary-table td:first-child { text-align: left; }
        .summary-table tr { cursor: pointer; transition: background 0.1s; }
        .summary-table tr:active { background: #f0f0f0; }
        .summary-table tr.selected { background: #e3f2fd !important; border-left: 3px solid #007bff; }
        .val-pos { color: #d32f2f; } .val-neg { color: #2e7d32; }

        .list-search-bar { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; background: #fff; display: flex; align-items: center; gap: 8px; }
        .list-search-bar input { flex: 1; border: 1px solid #eee; border-radius: 6px; padding: 8px; font-size: 13px; background: #f9f9f9; outline: none; }
        .list-search-bar input:focus { background: #fff; border-color: #007bff; }

        .table-scroll-box { overflow-x: auto; overflow-y: auto; max-height: 420px; }
        .base-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .base-table th { background: #f8f9fa; padding: 10px; text-align: left; font-size: 12px; color:#666; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 10; }
        .base-table td { padding: 12px 5px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px; vertical-align: middle; }
        .base-table tbody tr:hover { background-color: #f0f7ff; }

        .op-btn-group { display: flex; justify-content: center; gap: 8px; } 
        input[type="checkbox"] { width: 18px; height: 18px; vertical-align: middle; cursor: pointer; }

        .log-table { width: 100%; min-width: 750px; border-collapse: collapse; table-layout: fixed; }
        .log-table th { background: #fff; color: #666; font-size: 12px; position: sticky; top: 0; border-bottom: 2px solid #eee; text-align: left; padding: 8px 5px; z-index: 5; }
        .log-table td { padding: 8px 5px; border-bottom: 1px solid #f0f0f0; font-size: 12px; white-space: nowrap; vertical-align: middle; }
        .log-col-date { width: 15%; } .log-col-action { width: 10%; text-align: center !important; }
        .log-col-val { width: 15%; text-align: center !important; } .log-col-mas { width: 20%; font-size: 10px; color: #888; font-family: monospace; } .log-col-reason { width: 40%; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #fff; }
        .bg-red { background: #d32f2f; } .bg-green { background: #2e7d32; } .bg-gray { background: #999; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }
        .modal-box { background: #fff; padding: 20px; border-radius: 12px; width: 85%; max-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        .daily-log-header { padding: 8px 10px; background: #fff; border: 1px solid #eee; margin-top: -1px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 13px; transition: background 0.2s; }
        .daily-log-header:hover { background: #f9f9f9; }
        .daily-log-body { display: none; padding: 8px 10px; background: #fafafa; border: 1px solid #eee; border-top: none; }
        .daily-log-body.open { display: block; }
        .daily-item { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 4px; font-size: 12px; }
        .daily-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .arrow-daily { font-size: 10px; color: #999; transform: rotate(0deg); transition: transform 0.2s; }
        .daily-log-header.open .arrow-daily { transform: rotate(90deg); }

        .combo-box { position: relative; max-width: 70%; flex: 1; }
        .combo-input { width: 100%; padding: 8px 30px 8px 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; font-weight: bold; color: #333; box-sizing: border-box; font-size: 16px; background: #fff; transition: border 0.2s; }
        .combo-input:focus { border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.1); }
        .combo-arrow { position: absolute; right: 0px; top: 0px; height: 100%; width: 30px; display: flex; align-items: center; justify-content: center; color: #999; cursor: pointer; font-size: 10px; }
        .combo-options { display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #eee; border-radius: 6px; margin-top: 4px; max-height: 280px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .combo-options.show { display: block; }
        .combo-option { padding: 10px 12px; border-bottom: 1px solid #f9f9f9; cursor: pointer; font-size: 14px; color: #333; display: flex; justify-content: space-between; }
        .combo-option:hover { background: #f0f7ff; color: #007bff; }
        .combo-option.active { background: #e3f2fd; color: #007bff; font-weight: bold; }

        .summary-filter-bar { display: flex; gap: 8px; padding: 0 0 10px 0; background: #fff; border-bottom: 1px solid #eee; margin-bottom: 0; }
        .summary-filter-bar input, .summary-filter-bar select { border: 1px solid #ddd; padding: 6px 10px; border-radius: 6px; font-size: 12px; outline: none; background: #f9f9f9; }
        
        #adv-settings { background: #fff; border: 1px dashed #ddd; padding: 10px; border-radius: 6px; margin-top: 5px; display: none; }
        .toggle-link { display: block; text-align: right; margin-top: 5px; margin-bottom: 5px; color: #007bff; font-size: 12px; cursor: pointer; user-select: none; }
    </style>
</head>
<body>
<div class="container">
<!-- é…ç½®å¡ç‰‡ -->
<div class="card open" id="card-config">
    <div class="card-header" onclick="toggleCard('card-config')">
        <div class="header-title"><span>âš™ï¸ ç­–ç•¥é…ç½®</span></div>
        <span class="arrow">â–¼</span>
    </div>
    <div class="card-body">
        <div class="form-row">
            <div class="form-group" style="flex:2"><label>è‚¡ç¥¨åç§°</label><input type="text" id="inName" placeholder="å¦‚: 00388 / è…¾è®¯ / èŒ…å°"></div>
            <button class="btn btn-blue" style="margin-bottom:1px; width:40px;" onclick="searchStock()">ğŸ”</button>
            <div class="form-group" style="flex:1.5"><label>ä»£ç  (è‡ªåŠ¨)</label><input type="text" id="inCode" readonly></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>æœ€ä½å¸‚å€¼(äº¿)</label><input type="number" id="inMin" placeholder="2500"></div>
            <div class="form-group"><label>æœ€é«˜å¸‚å€¼(äº¿)</label><input type="number" id="inMax" placeholder="4000"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
            <button class="btn btn-purple" style="flex:1" id="btn-pull" onclick="syncFromGithub()">â˜ï¸ æ‹‰å–</button>
            <button class="btn btn-orange" style="flex:1" id="btn-push" onclick="uploadToGithub()">ğŸš€ ä¿å­˜é…ç½®</button>
            <button class="btn btn-green" style="flex:1" onclick="saveStock()">ğŸ’¾ å­˜æœ¬åœ°</button>
        </div>
    </div>
</div>
<!-- åˆ—è¡¨å¡ç‰‡ -->
<div class="card open" id="card-list">
    <div class="card-header" onclick="toggleCard('card-list')">
        <div class="header-title"><span>ğŸ“‹ ç›‘æ§åˆ—è¡¨</span><span id="list-count" style="font-weight:normal;margin-left:5px;color:#999;"></span></div>
        <span class="arrow">â–¼</span>
    </div>
    <div class="card-body" style="padding:0">
        <div class="list-search-bar">
            <span style="font-size:14px">ğŸ”</span>
            <input type="text" id="list-search-input" placeholder="è¾“å…¥åç§°æˆ–ä»£ç ç­›é€‰..." oninput="filterStockList()">
        </div>
        <div class="table-scroll-box">
            <table class="base-table">
                <thead>
                    <tr>
                        <th>è‚¡ç¥¨ä¿¡æ¯</th>
                        <th style="width:30%;">å¸‚å€¼åŒºé—´</th>
                        <th style="text-align:center; width:90px;">æ“ä½œ</th>
                        <th style="width:40px; text-align:center;"><input type="checkbox" id="check-all" onchange="toggleAllStocks(this)" checked></th>
                    </tr>
                </thead>
                <tbody id="stock-tbody"></tbody>
            </table>
        </div>
    </div>
</div>
<!-- ç»“æœå¡ç‰‡ -->
<div class="card open" id="card-result">
    <div class="card-header" onclick="toggleCard('card-result')">
        <div class="header-title"><span>ğŸ“Š å®æ—¶å›æµ‹ç»“æœ</span></div>
        <span class="arrow">â–¼</span>
    </div>
    <div class="card-body">
        <div class="run-bar">
            <div class="form-group"><label>å¼€å§‹æ—¥æœŸ</label><input type="date" id="inStartDate"></div>
            <div class="form-group"><label>ç»“æŸæ—¥æœŸ</label><input type="date" id="inEndDate"></div>
            
            <button class="btn btn-purple" id="btn-update-data" onclick="updateAllHistoryData()">ğŸ“¥ æ›´æ–°æ•°æ®</button>
            <button class="btn btn-blue" id="btn-run-all" onclick="runBatchBacktest()">ğŸš€ è¿è¡Œé€‰ä¸­</button>
        </div>
        <div style="font-size:11px;color:#888;margin-top:2px;">æç¤ºï¼šè¯·å…ˆç‚¹"æ›´æ–°æ•°æ®"ç¼“å­˜Kçº¿ï¼Œä¹‹åæ¯æ¬¡ç‚¹"è¿è¡Œ"å‡ä¸ºæé€Ÿæ¨¡å¼(å°‘æµé‡)ã€‚</div>

        <div class="toggle-link" onclick="toggleAdvSettings()">ğŸ›  é«˜çº§å‚æ•°è®¾ç½® â–¼</div>
        <div id="adv-settings">
            <!-- é«˜çº§å‚æ•°ä¿æŒä¸å˜ -->
            <div class="form-row">
                <div class="form-group"><label>æœ€å¤§æ æ†ç‡</label><input type="number" id="pMaxLev" step="0.1" value="2.0"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>ä½ä¼°æ•æ„Ÿåº¦</label><input type="number" id="pLowSens" value="12"></div>
                <div class="form-group"><label>ä½ä¼°å‡ä»“(0-1)</label><input type="number" id="pLowRed" step="0.1" value="0.3"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>å¸¸æ€æ•æ„Ÿåº¦</label><input type="number" id="pNormSens" value="25"></div>
                <div class="form-group"><label>å¸¸æ€å‡ä»“(0-1)</label><input type="number" id="pNormRed" step="0.1" value="0.8"></div>
            </div>
        </div>

        <div id="batch-progress" style="display:none; margin:12px 0; padding:10px; background:#e3f2fd; color:#0056b3; font-size:13px; border-radius:4px; text-align:center; border:1px solid #b3e5fc;">å‡†å¤‡å°±ç»ª</div>

        <!-- ç»“æœç»Ÿä¸€å±•ç¤ºå®¹å™¨ -->
        <div id="results-container" style="display:none; margin-top:15px;">
            <!-- 1. æ”¶ç›Šæ’è¡Œæ¦œ -->
            <div id="batch-summary-box" style="margin-bottom:15px;">
                <div class="section-header expanded" onclick="toggleSection('summary-content', this)">
                    <span>ğŸ“ˆ æ”¶ç›Šæ’è¡Œæ¦œ</span><span class="arrow header-arrow">â–¼</span>
                </div>
                <div id="summary-content" class="section-body">
                    <div class="summary-filter-bar">
                        <input type="text" id="summary-search" placeholder="ğŸ” æœè‚¡ç¥¨/ä»£ç ..." oninput="filterSummaryTable()">
                        <select id="summary-filter-reason" onchange="filterSummaryTable()"><option value="">å…¨éƒ¨åŸå› </option></select>
                    </div>
                    <div class="summary-wrapper">
                        <table class="summary-table">
                            <thead><tr><th>è‚¡ç¥¨</th><th>ç­–ç•¥æ”¶ç›Š</th><th>æœ€å¤§å›æ’¤</th><th>æœ€æ–°å˜åŠ¨</th><th style="text-align:left; padding-left:10px;">æœ€æ–°åŸå› </th></tr></thead>
                            <tbody id="summary-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- 2. ç»„åˆç­–ç•¥ -->
            <div id="portfolio-section" style="margin-bottom:15px;">
                <div class="section-header expanded" onclick="toggleSection('portfolio-content', this)"><span>ğŸ’° ç»„åˆç­–ç•¥ (Portfolio)</span><span class="arrow header-arrow">â–¼</span></div>
                <div id="portfolio-content" class="section-body">
                    <div class="form-row"><div class="form-group"><label>å‰”é™¤é—¨æ§›</label><input type="number" id="pMinPos" step="0.1" value="0.4"></div></div>
                    <div style="text-align:right; margin-bottom:10px;"><button class="btn btn-orange" onclick="runPortfolioStrategy()" style="width:100%">ğŸ”„ é‡æ–°è®¡ç®—ç»„åˆ</button></div>
                    <div class="stat-grid">
                        <div class="stat-item"><div class="stat-val" id="port-ret">--</div><div class="stat-lbl">ç»„åˆæ€»æ”¶ç›Š</div></div>
                        <div class="stat-item"><div class="stat-val" id="port-dd">--</div><div class="stat-lbl">æœ€å¤§å›æ’¤</div></div>
                        <div class="stat-item"><div class="stat-val" id="port-lev">--</div><div class="stat-lbl">å¹³å‡å ç”¨æ æ†</div></div>
                    </div>
                    <div id="portfolio-chart" style="width: 100%; height: 350px;"></div>
                </div>
            </div>
            <!-- 3. æŒä»“ç»“æ„ -->
            <div id="holdings-section" style="margin-bottom:15px;">
                <div class="section-header" onclick="toggleSection('holdings-content', this)"><span>ğŸ“š æ¯æ—¥æŒä»“ç»“æ„</span><span class="arrow header-arrow">â–¼</span></div>
                <div id="holdings-content" class="section-body collapsed"><div id="holdings-chart" style="width: 100%; height: 400px;"></div></div>
            </div>
            <!-- 4. äº¤æ˜“æ˜ç»† -->
            <div id="trade-log-section" style="margin-bottom:15px;">
                <div class="section-header" onclick="toggleSection('trade-log-content', this)"><span>ğŸ“ æ¯æ—¥è°ƒä»“æ˜ç»†</span><span class="arrow header-arrow">â–¼</span></div>
                <div id="trade-log-content" class="section-body collapsed" style="padding:0; border:none; max-height:400px; overflow-y:auto;"><div id="trade-log-list"></div></div>
            </div>
            <!-- 5. çŠ¶æ€åˆ†å¸ƒ -->
            <div id="status-dist-section" style="margin-bottom:15px;">
                <div class="section-header" onclick="toggleSection('status-dist-content', this)"><span>ğŸš¥ æ¯æ—¥çŠ¶æ€å æ¯”</span><span class="arrow header-arrow">â–¼</span></div>
                <div id="status-dist-content" class="section-body collapsed"><div id="status-chart" style="width: 100%; height: 350px;"></div></div>
            </div>
            <!-- 6. è¶‹åŠ¿å˜æ›´ -->
            <div id="trend-log-section" style="margin-bottom:15px;">
                <div class="section-header" onclick="toggleSection('trend-log-content', this)"><span>ğŸ—‚ æ¯æ—¥è¶‹åŠ¿å˜æ›´</span><span class="arrow header-arrow">â–¼</span></div>
                <div id="trend-log-content" class="section-body collapsed" style="padding:0; border:none; max-height:400px; overflow-y:auto;"><div id="trend-log-list"></div></div>
            </div>
            <!-- 7. è´¡çŒ®å›¾ -->
            <div id="contribution-section" style="margin-bottom:15px;">
                <div class="section-header" onclick="toggleSection('contribution-content', this)"><span>ğŸ’° ç´¯è®¡ç›ˆäºè´¡çŒ®</span><span class="arrow header-arrow">â–¼</span></div>
                <div id="contribution-content" class="section-body collapsed"><div id="contribution-chart" style="width: 100%; height: 400px;"></div></div>
            </div>
        </div>

        <!-- å•åªè¯¦æƒ…å±•ç¤ºåŒº -->
        <div id="detail-view" style="display:none; border-top: 2px dashed #eee; margin-top: 20px; padding-top: 15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div class="combo-box" id="detail-combo">
                    <input type="text" class="combo-input" id="detail-combo-input" placeholder="ç‚¹å‡»é€‰æ‹©..." oninput="filterDetailCombo()" onfocus="openDetailCombo()" onclick="this.select()">
                    <span class="combo-arrow" onclick="toggleDetailCombo(event)">â–¼</span>
                    <div class="combo-options" id="detail-combo-list"></div>
                </div>
                <span style="font-size:11px; background:#e3f2fd; padding:3px 8px; border-radius:4px; color:#007bff; font-weight:500;">å½“å‰é€‰ä¸­</span>
            </div>
            <div class="stat-grid">
                <div class="stat-item"><div class="stat-val" id="val-ret">--</div><div class="stat-lbl">ç­–ç•¥æ”¶ç›Š</div></div>
                <div class="stat-item"><div class="stat-val" id="val-stock">--</div><div class="stat-lbl">è‚¡ä»·æ¶¨è·Œ</div></div>
                <div class="stat-item"><div class="stat-val" id="val-lev">--</div><div class="stat-lbl">å¹³å‡æ æ†</div></div>
            </div>
            <div id="chart-box"></div>
            <div style="margin-top:20px;">
                <div class="section-header" onclick="toggleSection('log-content', this)"><span>ğŸ“œ äº¤æ˜“æ—¥å¿— <span id="log-count"></span></span><span class="arrow header-arrow">â–¼</span></div>
                <div id="log-content" class="section-body collapsed" style="border:1px solid #eee; border-radius:6px; border-top:0;">
                    <div style="max-height: 300px; overflow: auto; -webkit-overflow-scrolling: touch;">
                        <table class="log-table">
                            <thead style="background:#f9f9f9;"><tr><th class="log-col-date">æ—¥æœŸ</th><th class="log-col-action">åŠ¨ä½œ</th><th class="log-col-val">å˜åŠ¨</th><th class="log-col-mas">å‡çº¿</th><th class="log-col-reason">åŸå› </th></tr></thead>
                            <tbody id="log-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<!-- Token Modal -->
<div id="token-modal" class="modal">
    <div class="modal-box">
        <h3>ğŸ”‘ GitHub Token</h3>
        <input type="text" id="gh-token-input" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:15px;" placeholder="ghp_xxxx...">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-gray" style="flex:1" onclick="document.getElementById('token-modal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-blue" style="flex:1" onclick="saveToken()">ç¡®å®š</button>
        </div>
    </div>
</div>

<script>
// === é…ç½®ä¸å·¥å…· ===
const GITHUB_CONFIG = { username: "dlezywj-cell", repo: "backtest", path: "grid_config.json", branch: "main" };
const PROXY = 'https://corsproxy.io/?';
const HISTORY_CACHE_KEY = 'grid_history_v2';
let stocks = JSON.parse(localStorage.getItem('gridStocks')) || [];
// å†…å­˜ç¼“å­˜ { "1.600519": [KLines...] }
let g_historyData = {};

try {
    const saved = localStorage.getItem(HISTORY_CACHE_KEY);
    if(saved) g_historyData = JSON.parse(saved);
} catch(e) { console.log('Cache error'); }

// å›¾è¡¨å’Œç»“æœå˜é‡
let myChart = null;
let batchResults = [];
let portfolioChart = null, holdingsChart = null, statusChart = null, contributionChart = null;

// === é€šç”¨å‡½æ•° ===
function checkUnsavedStatus() {
    const dirty = localStorage.getItem('gridHasUnsavedChanges') === 'true';
    const btn = document.getElementById('btn-push');
    if (dirty) { btn.classList.add('unsaved'); btn.innerHTML = "ğŸ”´ å¾…åŒæ­¥é…ç½®"; } 
    else { btn.classList.remove('unsaved'); btn.innerHTML = "ğŸš€ ä¿å­˜é…ç½®"; }
}
function setLocalChanges(isDirty) { localStorage.setItem('gridHasUnsavedChanges', isDirty); checkUnsavedStatus(); }
function initDates() {
    const d = new Date(); document.getElementById('inEndDate').value = d.toISOString().split('T')[0];
    d.setFullYear(d.getFullYear() - 1); document.getElementById('inStartDate').value = d.toISOString().split('T')[0];
}
initDates(); checkUnsavedStatus(); renderTable();

// === UI æ“ä½œ ===
function toggleCard(id) {
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.toggle('open');
    if(el.classList.contains('open') && id === 'card-result') {
        setTimeout(() => { if(myChart) myChart.resize(); if(portfolioChart) portfolioChart.resize(); }, 200);
    }
}
function toggleSection(contentId, headerEl) {
    const content = document.getElementById(contentId);
    const isCollapsed = content.classList.toggle('collapsed');
    if (isCollapsed) headerEl.classList.remove('expanded'); else headerEl.classList.add('expanded');
    if (!isCollapsed) setTimeout(() => {
        if(contentId==='portfolio-content' && portfolioChart) portfolioChart.resize();
        if(contentId==='holdings-content' && holdingsChart) holdingsChart.resize();
        if(contentId==='status-dist-content' && statusChart) statusChart.resize();
        if(contentId==='contribution-content' && contributionChart) contributionChart.resize();
    }, 50);
}
function toggleDailyLog(headerEl) { headerEl.classList.toggle('open'); headerEl.nextElementSibling.classList.toggle('open'); }
function toggleAdvSettings() { const el = document.getElementById('adv-settings'); el.style.display = (el.style.display==='block')?'none':'block'; }

// === Github & Stock CRUD ===
function safeB64ToUtf8(str) { return decodeURIComponent(escape(window.atob(str.replace(/\s/g, '')))); }
function utf8ToB64(str) { return window.btoa(unescape(encodeURIComponent(str))); }

async function uploadToGithub() {
    let token = localStorage.getItem("github_token");
    if (!token) { document.getElementById('token-modal').style.display='flex'; return; }
    const btn = document.getElementById('btn-push'); const origin = btn.innerText; btn.innerText = "â³"; btn.disabled = true;
    try {
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
        const get = await fetch(url, { headers: { "Authorization": `token ${token.trim()}` } });
        let sha = null; if (get.ok) sha = (await get.json()).sha;
        await fetch(url, { method: "PUT", headers: { "Authorization": `token ${token.trim()}` }, body: JSON.stringify({ message: "Update", content: utf8ToB64(JSON.stringify(stocks, null, 2)), sha }) });
        alert("âœ… åŒæ­¥æˆåŠŸ!"); setLocalChanges(false);
    } catch (e) { alert("âŒ " + e.message); } finally { btn.innerText = origin; btn.disabled = false; checkUnsavedStatus(); }
}
async function syncFromGithub() {
    const btn = document.getElementById('btn-pull'); const origin = btn.innerText; btn.innerText = "â³"; btn.disabled = true;
    try {
        const token = localStorage.getItem("github_token");
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
        const h = { "Accept": "application/vnd.github.v3+json" }; if(token) h["Authorization"] = `token ${token.trim()}`;
        let res = await fetch(url, { headers: h });
        let data;
        if (res.ok) { data = JSON.parse(safeB64ToUtf8((await res.json()).content)); }
        else { const raw = await fetch(`https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.path}?t=${Date.now()}`); data = await raw.json(); }
        if(Array.isArray(data) && confirm(`è¦†ç›–æœ¬åœ° ${stocks.length} æ¡æ•°æ®?`)) { stocks = data; localStorage.setItem('gridStocks', JSON.stringify(stocks)); renderTable(); setLocalChanges(false); }
    } catch (e) { alert("âŒ " + e.message); } finally { btn.innerText = origin; btn.disabled = false; }
}
function saveToken() { const t = document.getElementById('gh-token-input').value.trim(); if(t) { localStorage.setItem('github_token', t); document.getElementById('token-modal').style.display='none'; uploadToGithub(); } }

function searchStock() {
    const val = document.getElementById('inName').value.trim(); if(!val) return;
    const s = document.createElement('script');
    s.src = `https://searchapi.eastmoney.com/api/suggest/get?input=${encodeURIComponent(val)}&type=14&token=D43BF722C8E33BD5D50F639205545E43&cb=handleSearch`;
    window.handleSearch = (d) => {
        if(d?.QuotationCodeTable?.Data?.[0]) {
            let r = d.QuotationCodeTable.Data[0]; let suffix = "";
            if (/^\d{5}$/.test(r.Code)) suffix = r.Code.startsWith('6') ? ".SH" : ".SZ"; else if (!/^\d+$/.test(r.Code)) suffix = ".US"; else { if(r.MarketType == "1") suffix = ".SH"; else if(r.MarketType == "2") suffix = ".SZ"; else if(r.MarketType == "5") suffix = ".HK"; }
            document.getElementById('inCode').value = r.Code + suffix; document.getElementById('inName').value = r.Name;
        } else alert("æœªæ‰¾åˆ°"); s.remove();
    }
    document.body.appendChild(s);
}
function saveStock() {
    const code = document.getElementById('inCode').value; const name = document.getElementById('inName').value;
    const min = parseFloat(document.getElementById('inMin').value); const max = parseFloat(document.getElementById('inMax').value);
    if(!code || isNaN(min)) return alert("è¯·å¡«å†™å®Œæ•´");
    const item = { code, name, minCap: min, maxCap: max, lastMod: new Date().toISOString().split('T')[0] };
    const idx = stocks.findIndex(s => s.code === code); if(idx >= 0) stocks[idx] = item; else stocks.push(item);
    localStorage.setItem('gridStocks', JSON.stringify(stocks)); renderTable(); setLocalChanges(true);
}
function renderTable() {
    const tb = document.getElementById('stock-tbody');
    tb.innerHTML = stocks.map((s, i) => `<tr> <td><b>${s.name}</b> <span style="color:#999;font-size:12px">${s.code}</span></td> <td> ${s.minCap}-${s.maxCap}äº¿ </td> <td style="text-align:center;"><div class="op-btn-group"><button class="btn btn-edit-yellow btn-icon-square" onclick="editStock(${i})">âœ</button><button class="btn btn-del-red btn-icon-square" onclick="delStock(${i})">âœ•</button></div></td> <td style="text-align:center;"><input type="checkbox" class="stock-chk" value="${i}" checked></td> </tr>`).join('');
    filterStockList(); checkAllState();
}
function toggleAllStocks(el) { document.querySelectorAll('.stock-chk').forEach(chk => chk.checked = el.checked); }
function checkAllState() { const all = document.querySelectorAll('.stock-chk'); const checked = document.querySelectorAll('.stock-chk:checked'); document.getElementById('check-all').checked = (all.length > 0 && all.length === checked.length); }
document.addEventListener('change', function(e){ if(e.target.classList.contains('stock-chk')) checkAllState(); });
function editStock(i) { const s = stocks[i]; document.getElementById('inName').value = s.name; document.getElementById('inCode').value = s.code; document.getElementById('inMin').value = s.minCap; document.getElementById('inMax').value = s.maxCap; document.getElementById('card-config').scrollIntoView({behavior: 'smooth'}); }
function delStock(i) { if(confirm("ç¡®è®¤åˆ é™¤ï¼Ÿ")) { stocks.splice(i, 1); localStorage.setItem('gridStocks', JSON.stringify(stocks)); renderTable(); setLocalChanges(true); } }
function filterStockList() {
    const term = document.getElementById('list-search-input').value.toLowerCase().trim();
    document.querySelectorAll('#stock-tbody tr').forEach(row => { row.style.display = (term === '' || row.innerText.toLowerCase().includes(term)) ? '' : 'none'; });
    const visible = document.querySelectorAll('#stock-tbody tr:not([style*="none"])').length;
    document.getElementById('list-count').innerText = `(${visible}/${stocks.length})`;
}

// === æ ¸å¿ƒï¼šæé€Ÿæ¶æ„ (å†å²ç¼“å­˜ + æ‰¹é‡å®æ—¶) ===
const getEmSecId = c => { 
    let raw = c.replace(/\.[A-Z]+$/, '');
    if (/^\d{5}$/.test(raw)) return '116.' + raw.padStart(5, '0');
    if (c.includes('.US')) return '105.' + raw;
    if (raw.startsWith('6')) return '1.' + raw;
    return '0.' + raw; 
};

// 1. æ‰¹é‡æ›´æ–°å†å²æ•°æ® (å­˜å…¥LocalStorage)
async function updateAllHistoryData() {
    const btn = document.getElementById('btn-update-data'); 
    const originText = btn.innerText; btn.innerText = "â³ 0%"; btn.disabled = true;
    const total = stocks.length;
    let finished = 0;
    
    // 5å¹¶å‘
    for(let i=0; i<total; i+=5) {
        const batch = stocks.slice(i, i+5);
        await Promise.all(batch.map(async (s) => {
            try {
                const secId = getEmSecId(s.code);
                const url = `https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${secId}&fields1=f1&fields2=f51,f53&klt=101&fqt=1&end=20500101&lmt=500`;
                const res = await fetch(PROXY + encodeURIComponent(url));
                const json = await res.json();
                if(json?.data?.klines) g_historyData[secId] = json.data.klines;
            } catch(e) { console.error(s.name, e); }
            finished++;
            btn.innerText = `â³ ${(finished/total*100).toFixed(0)}%`;
        }));
    }
    try { localStorage.setItem(HISTORY_CACHE_KEY, JSON.stringify(g_historyData)); } catch(e) { alert("ç¼“å­˜è¿‡å¤§ï¼Œè¯·å‡å°‘è‚¡ç¥¨æ•°é‡"); }
    btn.innerText = "âœ… å®Œæˆ"; setTimeout(() => { btn.innerText = originText; btn.disabled = false; }, 2000);
}

// 2. æ‰¹é‡è·å–å®æ—¶ä»·æ ¼ (1ä¸ªè¯·æ±‚è·å–æ‰€æœ‰)
async function fetchBatchRealtime(selectedStocks) {
    let realtimeMap = {}; 
    const BATCH_SIZE = 50; 
    for(let i=0; i<selectedStocks.length; i+=BATCH_SIZE) {
        const batch = selectedStocks.slice(i, i+BATCH_SIZE);
        const secIds = batch.map(s => getEmSecId(s.code)).join(',');
        const url = `https://push2.eastmoney.com/api/qt/ulist.np/get?secids=${secIds}&fields=f12,f13,f2,f20,f124&invt=2&fltt=2&_=${Date.now()}`;
        try {
            const res = await fetch(PROXY + encodeURIComponent(url));
            const json = await res.json();
            const list = Array.isArray(json?.data?.diff) ? json.data.diff : (json?.data?.diff ? Object.values(json.data.diff) : []);
            list.forEach(item => {
                // f12=code, f2=price, f20=mv, f124=timestamp
                realtimeMap[item.f12] = { price: item.f2, mv: item.f20, time: item.f124 };
            });
        } catch(e) { console.error(e); }
    }
    return realtimeMap;
}

// 3. çº¯å†…å­˜è®¡ç®— (æ—  fetch)
function calculateMA_Array(data, dayCount) {
    let result = new Array(data.length).fill(null); let sum = 0;
    for (let i = 0; i < data.length; i++) {
        sum += data[i].close;
        if (i >= dayCount) sum -= data[i - dayCount].close;
        if (i >= dayCount - 1) result[i] = sum / dayCount;
    }
    return result;
}

function calculateStock_Pure(stock, historyKlines, rtData) {
    if(!historyKlines || historyKlines.length === 0) throw new Error("æ— å†å²æ•°æ®");
    
    const maxLev = parseFloat(document.getElementById('pMaxLev').value) || 2.0;
    const lowSens = parseFloat(document.getElementById('pLowSens').value) || 12;
    const lowRed = parseFloat(document.getElementById('pLowRed').value) || 0.3;
    const normSens = parseFloat(document.getElementById('pNormSens').value) || 25;
    const normRed = parseFloat(document.getElementById('pNormRed').value) || 0.8;
    const minCap = stock.minCap; const maxCap = stock.maxCap; const midCap = (minCap + maxCap) / 2.0;

    const getTargetLeverage = (mv) => { 
        if(mv <= minCap) return maxLev; if(mv >= maxCap) return 0.0; 
        let r = (mv - minCap) / (maxCap - minCap); return 0.0 + (maxLev - 0.0) * Math.exp(-2.5 * r); 
    };

    const userStartDate = document.getElementById('inStartDate').value;
    const userEndDate = document.getElementById('inEndDate').value;
    const todayStr = new Date().toISOString().split('T')[0];

    // ä¼°ç®—æ€»è‚¡æœ¬ï¼šå¦‚æœå®æ—¶æ•°æ®æœ‰ï¼Œç”¨å®æ—¶çš„ï¼›å¦åˆ™é»˜è®¤ç”¨ Kçº¿å€’æ¨(ä¸å‡†ä½†å¤Ÿç”¨)
    // å‡è®¾å†å² K çº¿æœ€åä¸€å¤© close å’Œ å®æ—¶ mv çš„å…³ç³»
    let totalShares = 0; 
    if (rtData && rtData.price > 0 && rtData.mv > 0) {
        totalShares = (rtData.mv / rtData.price) / 100000000; // äº¿è‚¡
    } else {
        // å…œåº•ï¼šå¦‚æœæ²¡å®æ—¶æ•°æ®ï¼Œæš‚æ— æ³•è®¡ç®—å¸‚å€¼ï¼Œåªèƒ½ä¾èµ–åç»­é€»è¾‘è·³è¿‡
    }

    let rawData = [];
    historyKlines.forEach(k => {
        const parts = k.split(',');
        const dateStr = parts[0];
        const close = parseFloat(parts[1]);
        if (dateStr >= userStartDate && dateStr <= userEndDate) {
            let mv = (totalShares > 0) ? close * totalShares : 0; // å†å²å¸‚å€¼ä¼°ç®—
            rawData.push({
                date: dateStr, close: close, mv: mv,
                valScore: (mv<=minCap)?1:(mv>=maxCap)?-1:((mv<=midCap)?(midCap-mv)/(midCap-minCap):-(mv-midCap)/(maxCap-midCap))
            });
        }
    });

    if (rawData.length === 0) throw new Error("æ—¥æœŸèŒƒå›´å†…æ— æ•°æ®");

    // æ‹¼æ¥å®æ—¶
    if (rtData && rtData.price > 0 && userEndDate >= todayStr) {
        const rtMv = rtData.mv / 100000000; // è½¬äº¿
        const rtScore = (rtMv<=minCap)?1:(rtMv>=maxCap)?-1:((rtMv<=midCap)?(midCap-rtMv)/(midCap-minCap):-(rtMv-midCap)/(maxCap-midCap));
        // è¿™é‡Œç®€åŒ–ï¼šå‡è®¾å®æ—¶å°±æ˜¯ä»Šå¤©
        const rtDateStr = todayStr + " (ç›˜ä¸­)";
        const last = rawData[rawData.length-1];
        
        // å¦‚æœæœ€åä¸€å¤©Kçº¿æ—¥æœŸ == ä»Šå¤©ï¼Œè¦†ç›–ï¼›å¦åˆ™è¿½åŠ 
        const rtItem = { date: rtDateStr, close: rtData.price, mv: rtMv, valScore: rtScore };
        // ç®€å•æ—¥æœŸå¯¹æ¯”ï¼ŒKçº¿é‡Œçš„æ—¥æœŸæ ¼å¼ yyyy-MM-dd
        if(last.date.startsWith(todayStr)) { rawData[rawData.length-1] = rtItem; }
        else { rawData.push(rtItem); }
    }
    
    // å¦‚æœæ²¡æœ‰è®¡ç®—å‡ºæœ‰æ•ˆmv(totalShares=0)ï¼Œéœ€è¦å¤„ç†
    if(totalShares === 0 && rawData.length > 0) {
        // å°è¯•ç”¨ K çº¿å€’æ¨ï¼šå‡è®¾æœ€åä¸€å¤©å¸‚å€¼åˆšå¥½åœ¨ä¸­é—´ (Blind fallback, rare case)
        // å®é™…ä¸Šæœ€å¥½æŠ¥é”™ã€‚ä½†ä¸ºäº†ä¸å´©ï¼Œç»™ä¸ªé»˜è®¤ã€‚
        rawData.forEach(d => d.mv = midCap); 
    }

    const ma5Arr = calculateMA_Array(rawData, 5);
    const ma10Arr = calculateMA_Array(rawData, 10);
    const ma20Arr = calculateMA_Array(rawData, 20);

    let nav = 1.0, peakNav = 1.0, prevL = getTargetLeverage(rawData[0].mv), inProtect = false, history = [], changeLogs = [];
    history.push({date: rawData[0].date, nav:1.0, close:rawData[0].close, leverage:prevL, status: "éœ‡è¡æ•´ç†", reason: "åˆå§‹å»ºä»“"});

    for(let i=1; i<rawData.length; i++) {
        const d = rawData[i]; const prevD = rawData[i-1]; const r = d.close / prevD.close - 1; 
        const targetL = getTargetLeverage(d.mv); let newL = targetL; let reason = "ä¼°å€¼é©±åŠ¨";
        let statusTag = "éœ‡è¡æ•´ç†";
        let m5 = ma5Arr[i], m10 = ma10Arr[i], m20 = ma20Arr[i];
        
        const isTechUp = (m5 && m10 && m20 && m5 > m10 && m5 > m20 && d.close > m20);
        const isTechDown = (m5 && m10 && m20 && m5 < m10 && m5 < m20 && d.close < m20);
        const isUp = isTechUp && (r > 0.0);
        const isDown = isTechDown && (r < 0.0);

        let winStart = Math.max(0, i - 20); let winNav = 0; for(let k=winStart; k<history.length; k++) if(history[k].nav > winNav) winNav = history[k].nav; if(i < 20) winNav = peakNav; if(nav > winNav) winNav = nav;
        let curDrawdown = (winNav > 0) ? (winNav - nav) / winNav : 0;

        if(curDrawdown > 0.15 && !inProtect) {
            if(d.mv <= minCap * 1.05) reason = "å¸‚å€¼ä½ä¼°è·³è¿‡æ­¢æŸ"; 
            else { inProtect = true; newL = prevL * 0.4; reason = `å›æ’¤æ­¢æŸ(DD:${(curDrawdown*100).toFixed(1)}%)`; peakNav = nav; }
        }
        
        if(inProtect) {
            statusTag = "è§¦å‘é£æ§"; 
            if(isUp && d.valScore > 0) { inProtect = false; newL = targetL; reason = "è¶‹åŠ¿æ¢å¤ä¸”ä¼°å€¼æ”¹å–„"; } 
            else {
                if(isDown) { 
                    let slope = (m10 - m20)/m20; let reduce = Math.min(1.0, Math.abs(slope)*25); 
                    let trendL = Math.max(0.00, prevL * (1 - reduce * 0.8)); 
                    if(trendL < newL) { newL = trendL; reason = "ä¿æŠ¤ä¸­æé€Ÿå‡ä»“"; } 
                } else { newL = 0; if(prevL > 0.001) reason = "ä¿æŠ¤ä¸­(ç©ºä»“)"; }
            }
        } else {
            if(isTechUp) statusTag = "ä¸Šæ¶¨è¶‹åŠ¿"; else if(isTechDown) statusTag = "ä¸‹è·Œè¶‹åŠ¿"; else statusTag = "éœ‡è¡æ•´ç†";
            if(isDown) {
                if (d.valScore > 0.6 && d.close > m5) { if (newL < prevL) { newL = prevL; reason = "ä½ä¼°ä¸”ç«™ä¸ŠMA5(æš‚åœå‡ä»“)"; } } 
                else {
                    let slope = (m10 - m20)/m20; 
                    let reduceSpeed, reduceMsg;
                    if (d.mv <= minCap) { reduceSpeed = Math.min(1.0, Math.abs(slope) * lowSens) * lowRed; reduceMsg = "ä½ä¼°åŒºè¶‹åŠ¿è½¬å¼±(æ…¢å‡ä»“)"; } 
                    else { reduceSpeed = Math.min(1.0, Math.abs(slope) * normSens) * normRed; reduceMsg = "è¶‹åŠ¿è½¬å¼±æé€Ÿå‡ä»“"; }
                    let trendL = Math.max(0.00, prevL * (1 - reduceSpeed)); 
                    if(trendL < newL) { newL = trendL; reason = reduceMsg; }
                }
            }
        }
        
        if(!inProtect && isUp) { if(r < -0.02) { newL = Math.min(maxLev, prevL * 1.05); reason = "ä¸Šæ¶¨ä¸­æ€¥è·ŒåŠ ä»“"; } else { newL = Math.max(prevL, targetL); } }
        
        let maStr = (m5!==null) ? `M5:${m5.toFixed(2)}<br>M10:${m10.toFixed(2)}<br>M20:${m20.toFixed(2)}` : "-";
        const diff = newL - prevL;
        let actionHtml = (diff > 0.005) ? `<span class="badge bg-red">åŠ ä»“</span>` : (diff < -0.005) ? `<span class="badge bg-green">å‡ä»“</span>` : `<span class="badge bg-gray">æŒä»“</span>`;
        if (Math.abs(diff)<0.005 && !reason.includes('ä¿æŠ¤') && !reason.includes('æ­¢æŸ') && !reason.includes('ä½ä¼°')) reason = statusTag + " (ç­–ç•¥ç»´æŒ)";

        changeLogs.push({ date: d.date, action: actionHtml, val: `${prevL.toFixed(2)} â†’ ${newL.toFixed(2)}`, reason: reason, mas: maStr }); 
        nav = nav * (1 + prevL * r); if(nav > peakNav) peakNav = nav; 
        history.push({date: d.date, nav, close: d.close, leverage: newL, status: statusTag, reason: reason}); 
        prevL = newL;
    }

    const last = history[history.length-1]; const ret = (last.nav - 1)*100; const sRet = (last.close / history[0].close - 1)*100; 
    let maxDD = 0, p = -999; history.forEach(h => { if(h.nav > p) p = h.nav; let dd = (p - h.nav) / p; if(dd > maxDD) maxDD = dd; });
    
    return { stockName: stock.name, stockCode: stock.code, history: history, logs: changeLogs, stats: { ret: ret, stockRet: sRet, alpha: ret - sRet, maxDD: maxDD * 100, avgLev: history.reduce((a,b)=>a+b.leverage,0)/history.length } };
}

// === è¿è¡Œä¸»å…¥å£ ===
async function runBatchBacktest() {
    const checkedBoxes = document.querySelectorAll('.stock-chk:checked');
    if(checkedBoxes.length === 0) return alert("è¯·è‡³å°‘å‹¾é€‰ä¸€åªè‚¡ç¥¨");
    
    const selectedIndices = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
    const selectedStocks = selectedIndices.map(i => stocks[i]);
    
    // æ£€æŸ¥ç¼“å­˜
    const missing = selectedStocks.some(s => !g_historyData[getEmSecId(s.code)]);
    if(missing) { if(!confirm("å‘ç°éƒ¨åˆ†è‚¡ç¥¨æ— å†å²ç¼“å­˜ï¼Œæ˜¯å¦å…ˆæ›´æ–°æ•°æ®(çº¦è€—æ—¶å‡ ç§’)ï¼Ÿ")) return; await updateAllHistoryData(); }

    const btn = document.getElementById('btn-run-all'); btn.innerText = "âš¡ è·å–å®æ—¶è¡Œæƒ…..."; btn.disabled = true;
    const progress = document.getElementById('batch-progress'); progress.style.display = 'block'; progress.innerText = "æ­£åœ¨æ‰¹é‡è·å–è¡Œæƒ…...";

    // 1. è·å–è¡Œæƒ…
    const rtMap = await fetchBatchRealtime(selectedStocks);

    // 2. çº¯å†…å­˜è®¡ç®—
    batchResults = []; let errCount = 0;
    const detailView = document.getElementById('detail-view'); detailView.style.display = 'none';
    const sumTbody = document.getElementById('summary-tbody'); sumTbody.innerHTML = '';
    
    selectedStocks.forEach((s, i) => {
        try {
            const secId = getEmSecId(s.code);
            const pureCode = s.code.replace(/[^\d]/g, ''); // åŒ¹é…å®æ—¶æ•°æ®çš„key
            // å®æ—¶æ•°æ®KeyåŒ¹é…é€»è¾‘: æœ‰æ—¶å€™ f12 æ˜¯ '00700'ï¼Œæœ‰æ—¶å€™æ˜¯çº¯æ•°å­—
            // ç®€å•å°è¯•ï¼šç›´æ¥ç”¨f12åŒ¹é…ï¼Œæˆ–è€…çº¯ä»£ç åŒ¹é…
            let rt = rtMap[s.code] || rtMap[s.code.split('.')[0]]; 
            // å°è¯•æ›´æ¨¡ç³ŠåŒ¹é…
            if(!rt) { const k = Object.keys(rtMap).find(k => s.code.includes(k)); if(k) rt = rtMap[k]; }

            const res = calculateStock_Pure(s, g_historyData[secId], rt);
            res.index = selectedIndices[i];
            batchResults.push(res);
            appendSummaryRow(res, res.index);
        } catch(e) {
            console.warn(s.name, e);
            sumTbody.innerHTML += `<tr><td style="text-align:left">${s.name}</td><td colspan="3" style="text-align:center;color:orange">âŒ ${e.message}</td></tr>`;
            errCount++;
        }
    });

    progress.innerText = `âœ… å®Œæˆ! æˆåŠŸ ${batchResults.length}, å¤±è´¥ ${errCount}`;
    btn.innerText = "ğŸš€ è¿è¡Œé€‰ä¸­"; btn.disabled = false;

    if(batchResults.length > 0) {
        updateSummaryFilterOptions();
        document.getElementById('results-container').style.display = 'block';
        // å±•å¼€/æ”¶èµ·åˆå§‹çŠ¶æ€
        document.querySelector('#batch-summary-box .section-header').classList.add('expanded');
        document.getElementById('summary-content').classList.remove('collapsed');
        document.querySelector('#portfolio-section .section-header').classList.add('expanded');
        document.getElementById('portfolio-content').classList.remove('collapsed'); 
        
        ['holdings','trade-log','status-dist','trend-log','contribution'].forEach(id => {
            document.querySelector(`#${id}-section .section-header`).classList.remove('expanded');
            document.getElementById(`${id}-content`).classList.add('collapsed');
        });

        runPortfolioStrategy(); 
        renderStatusDistribution(); renderTrendLog();
        renderDetailCombo(); showDetail(batchResults[0].index);
    }
}

// === åç»­æ¸²æŸ“é€»è¾‘ä¿æŒä¸å˜ ===
function updateSummaryFilterOptions() {
    const select = document.getElementById('summary-filter-reason');
    const unique = new Set(batchResults.map(r => r.logs[r.logs.length-1]?.reason).filter(Boolean));
    select.innerHTML = '<option value="">å…¨éƒ¨åŸå› </option>' + Array.from(unique).sort().map(r=>`<option value="${r}">${r}</option>`).join('');
}
function filterSummaryTable() {
    const term = document.getElementById('summary-search').value.toLowerCase().trim();
    const reason = document.getElementById('summary-filter-reason').value;
    document.querySelectorAll('#summary-tbody tr').forEach(row => {
        const text = row.cells[0].innerText.toLowerCase();
        const rText = row.cells[4].innerText.trim();
        row.style.display = (term==='' || text.includes(term)) && (reason==='' || rText === reason) ? '' : 'none';
    });
}
function appendSummaryRow(res, index) {
    const tr = document.createElement('tr'); tr.id = `row-${index}`; tr.onclick = () => showDetail(index);
    const last = res.logs[res.logs.length-1] || {action:'-', val:'-', reason:'-'};
    tr.innerHTML = `<td><b>${res.stockName}</b><br><span style="color:#999;font-size:10px">${res.stockCode}</span></td><td class="${res.stats.ret>=0?'val-pos':'val-neg'}">${res.stats.ret.toFixed(1)}%</td><td style="color:#555;">${res.stats.maxDD.toFixed(1)}%</td><td><div style="display:flex;flex-direction:column;align-items:flex-end;">${last.action}<span style="font-size:10px;color:#888;font-family:monospace;">${last.val}</span></div></td><td style="text-align:left;padding-left:10px;"><span style="font-size:11px;color:#333;line-height:1.4;">${last.reason}</span></td>`;
    document.getElementById('summary-tbody').appendChild(tr);
}
function renderDetailCombo() {
    const list = document.getElementById('detail-combo-list'); list.innerHTML = '';
    batchResults.forEach(res => {
        const d = document.createElement('div'); d.className = 'combo-option'; d.dataset.index = res.index; d.dataset.search = (res.stockName+res.stockCode).toLowerCase();
        d.innerHTML = `<span>${res.stockName}</span><span style="color:#999;font-size:12px">${res.stockCode}</span>`;
        d.onclick = (e) => { e.stopPropagation(); showDetail(res.index); closeDetailCombo(); };
        list.appendChild(d);
    });
}
function openDetailCombo() { document.getElementById('detail-combo-list').classList.add('show'); }
function closeDetailCombo() { document.getElementById('detail-combo-list').classList.remove('show'); }
function toggleDetailCombo(e) { e.stopPropagation(); const l = document.getElementById('detail-combo-list'); if(l.classList.contains('show')) closeDetailCombo(); else { document.getElementById('detail-combo-input').focus(); openDetailCombo(); } }
function filterDetailCombo() {
    const v = document.getElementById('detail-combo-input').value.toLowerCase();
    document.querySelectorAll('.combo-option').forEach(o => o.style.display = (v===''||o.dataset.search.includes(v))?'flex':'none');
    openDetailCombo();
}
document.addEventListener('click', e => { if(!document.getElementById('detail-combo').contains(e.target)) closeDetailCombo(); });

function showDetail(index) {
    const res = batchResults.find(r => r.index === index); if(!res) return;
    document.querySelectorAll('.summary-table tr').forEach(r => r.classList.remove('selected'));
    document.getElementById(`row-${index}`)?.classList.add('selected');
    document.getElementById('detail-view').style.display = 'block';
    
    document.getElementById('detail-combo-input').value = `${res.stockName} (${res.stockCode})`;
    document.querySelectorAll('.combo-option').forEach(o => o.classList.toggle('active', parseInt(o.dataset.index)===index));

    const s = res.stats;
    document.getElementById('val-ret').innerHTML = `<span class="${s.ret>=0?'win':'loss'}">${s.ret.toFixed(2)}%</span>`;
    document.getElementById('val-stock').innerHTML = `<span class="${s.stockRet>=0?'win':'loss'}">${s.stockRet.toFixed(2)}%</span>`;
    document.getElementById('val-lev').innerText = s.avgLev.toFixed(2) + 'x';
    
    renderChart(res.history); renderLog(res.logs);
}
function renderLog(logs) {
    const tbody = document.getElementById('log-tbody'); document.getElementById('log-count').innerText = `(${logs.length})`;
    tbody.innerHTML = logs.slice().reverse().map(l => `<tr><td class="log-col-date" style="color:#666;">${l.date}</td><td class="log-col-action">${l.action}</td><td class="log-col-val" style="font-family:monospace;">${l.val}</td><td class="log-col-mas">${l.mas}</td><td class="log-col-reason" style="color:#555;" title="${l.reason}">${l.reason}</td></tr>`).join('');
}
function renderChart(hist) {
    const dom = document.getElementById('chart-box'); if(myChart) myChart.clear(); else myChart = echarts.init(dom);
    myChart.group = 'g';
    const dates = hist.map(h=>h.date);
    myChart.setOption({
        tooltip: { trigger: 'axis', axisPointer: { type: 'cross' }, formatter: p => {
            const i = p[0].dataIndex; const h = hist[i];
            return `<div style="font-weight:bold;margin-bottom:5px;">${h.date}</div>è‚¡ä»·: <b>${h.close.toFixed(2)}</b><br>å‡€å€¼: <b style="color:#d32f2f">${h.nav.toFixed(3)}</b><br>æ æ†: <b style="color:#28a745">${h.leverage.toFixed(2)}x</b><br><span style="color:#666">${h.status}</span>`;
        }},
        legend: { top: 0, data: ['è‚¡ä»·','å‡€å€¼','æ æ†'] },
        grid: [{ left: '10%', right: '8%', top: '12%', height: '60%' }, { left: '10%', right: '8%', top: '80%', height: '15%' }],
        xAxis: [{type:'category', data: dates, gridIndex:0, axisLabel:{show:false}}, {type:'category', data: dates, gridIndex:1}],
        yAxis: [{position:'left'}, {position:'right'}, {gridIndex:1, min:0, max:2.1, splitLine:{show:true}}],
        series: [
            {name:'è‚¡ä»·', type:'line', data:hist.map(h=>h.close), itemStyle:{color:'#999'}, showSymbol:false, lineStyle:{width:1}},
            {name:'å‡€å€¼', type:'line', yAxisIndex:1, data:hist.map(h=>h.nav), itemStyle:{color:'#d32f2f'}, showSymbol:false, lineStyle:{width:2}},
            {name:'æ æ†', type:'line', xAxisIndex:1, yAxisIndex:2, data:hist.map(h=>h.leverage), itemStyle:{color:'#28a745'}, step:'end', showSymbol:false, areaStyle:{opacity:0.2}}
        ],
        dataZoom: [{type:'inside', xAxisIndex:[0,1]}, {type:'slider', xAxisIndex:[0,1], bottom:0, height:20}]
    });
}
// === ç»„åˆç­–ç•¥ä¸å›¾è¡¨ (é€»è¾‘ä¿æŒ) ===
function runPortfolioStrategy() {
    if(!batchResults.length) return;
    const minPos = parseFloat(document.getElementById('pMinPos').value) || 0.4;
    let dateMap = {};
    batchResults.forEach(res => {
        res.history.forEach(d => {
            if(!dateMap[d.date]) dateMap[d.date] = { date:d.date, stocks:{} };
            dateMap[d.date].stocks[res.stockName] = { close:d.close, lev:d.leverage };
        });
    });
    const dates = Object.keys(dateMap).sort();
    let portNav=1.0, portHist=[], maxDD=0, peak=1.0;
    let lastValid = {}, prevAlloc = {}, accContrib = {};
    batchResults.forEach(r => accContrib[r.stockName]=0);

    dates.forEach((date, i) => {
        const dayData = dateMap[date];
        const prevValid = {...lastValid};
        batchResults.forEach(r => { if(dayData.stocks[r.stockName]) lastValid[r.stockName] = dayData.stocks[r.stockName]; });

        if(i > 0) {
            let change = 0;
            batchResults.forEach(r => {
                const sCurr = lastValid[r.stockName], sPrev = prevValid[r.stockName], alloc = prevAlloc[r.stockName] || 0;
                if(sCurr && sPrev && sPrev.close > 0) {
                    const ret = (sCurr.close - sPrev.close)/sPrev.close;
                    const c = ret * alloc;
                    change += c; accContrib[r.stockName] += c;
                }
            });
            portNav *= (1 + change); if(portNav > peak) peak = portNav;
            const dd = (peak - portNav)/peak; if(dd>maxDD) maxDD=dd;
        }

        let validCount=0, breakdown={}, contribBreakdown={};
        batchResults.forEach(r => {
            const s = lastValid[r.stockName];
            if(s && s.lev >= minPos) validCount++;
            contribBreakdown[r.stockName] = accContrib[r.stockName];
        });
        let totalLev = 0;
        batchResults.forEach(r => {
            const s = lastValid[r.stockName];
            const alloc = (s && s.lev >= minPos && validCount>0) ? s.lev/validCount : 0;
            prevAlloc[r.stockName] = alloc; breakdown[r.stockName] = alloc; totalLev += alloc;
        });
        portHist.push({ date, nav:portNav, totalLev, breakdown, contribBreakdown, count:validCount });
    });

    // æ¸²æŸ“
    const last = portHist[portHist.length-1];
    const ret = (last.nav-1)*100; 
    document.getElementById('port-ret').innerHTML = `<span class="${ret>=0?'win':'loss'}">${ret.toFixed(2)}%</span>`;
    document.getElementById('port-dd').innerText = (maxDD*100).toFixed(2)+'%';
    document.getElementById('port-lev').innerText = (portHist.reduce((a,b)=>a+b.totalLev,0)/portHist.length).toFixed(2)+'x';
    
    renderPortChart(portHist); renderHoldingsChart(portHist); renderTradeLog(portHist, dateMap); renderContributionChart(portHist);
}

function renderPortChart(hist) {
    const dom = document.getElementById('portfolio-chart'); if(portfolioChart) portfolioChart.dispose(); portfolioChart = echarts.init(dom);
    portfolioChart.group = 'g';
    portfolioChart.setOption({
        tooltip: { trigger:'axis', axisPointer:{type:'cross'}, formatter: p => {
            const i=p[0].dataIndex; const h=hist[i];
            return `<b>${h.date}</b><br>å‡€å€¼: <b style="color:#d32f2f">${h.nav.toFixed(3)}</b><br>æ€»æ æ†: <b style="color:#1976d2">${h.totalLev.toFixed(2)}x</b><br>æŒä»“æ•°: ${h.count}`;
        }},
        legend: { top:0, data:['å‡€å€¼','æ€»æ æ†'] },
        grid: [{left:'10%', right:'8%', top:'15%', height:'55%'}, {left:'10%', right:'8%', top:'75%', height:'15%'}],
        xAxis: [{type:'category', data:hist.map(h=>h.date), gridIndex:0, axisLabel:{show:false}}, {type:'category', data:hist.map(h=>h.date), gridIndex:1}],
        yAxis: [{scale:true}, {gridIndex:1, min:0}],
        series: [
            {name:'å‡€å€¼', type:'line', data:hist.map(h=>h.nav), itemStyle:{color:'#d32f2f'}, showSymbol:false},
            {name:'æ€»æ æ†', type:'line', xAxisIndex:1, yAxisIndex:1, data:hist.map(h=>h.totalLev), itemStyle:{color:'#1976d2'}, areaStyle:{opacity:0.2}, showSymbol:false}
        ],
        dataZoom: [{type:'inside', xAxisIndex:[0,1]}, {type:'slider', xAxisIndex:[0,1], bottom:0, height:20}]
    });
}
function renderHoldingsChart(hist) {
    const dom = document.getElementById('holdings-chart'); if(holdingsChart) holdingsChart.dispose(); holdingsChart = echarts.init(dom);
    const names = batchResults.map(r=>r.stockName);
    const series = names.map(n => ({
        name: n, type:'line', stack:'Total', areaStyle:{}, showSymbol:false, lineStyle:{width:0},
        data: hist.map(h => h.breakdown[n]||0)
    }));
    holdingsChart.setOption({
        tooltip: { trigger:'axis', order:'valueDesc' }, legend: { type:'scroll', top:0 },
        grid: { left:'10%', right:'5%', bottom:'25px' }, xAxis: { type:'category', boundaryGap:false, data:hist.map(h=>h.date) },
        yAxis: { type:'value' }, dataZoom: [{type:'inside'}, {type:'slider', bottom:0, height:20}], series
    });
}
function renderStatusDistribution() {
    let stats = {};
    batchResults.forEach(r => {
        r.history.forEach(d => {
            if(!stats[d.date]) stats[d.date] = {'ä¸Šæ¶¨è¶‹åŠ¿':0,'ä¸‹è·Œè¶‹åŠ¿':0,'éœ‡è¡æ•´ç†':0,'è§¦å‘é£æ§':0};
            if(stats[d.date][d.status] !== undefined) stats[d.date][d.status]++;
        });
    });
    const dates = Object.keys(stats).sort();
    const series = ['ä¸Šæ¶¨è¶‹åŠ¿','éœ‡è¡æ•´ç†','è§¦å‘é£æ§','ä¸‹è·Œè¶‹åŠ¿'].map(k => ({
        name:k, type:'bar', stack:'t', data: dates.map(d=>stats[d][k]),
        itemStyle: { color: k.includes('ä¸Š')?'#d32f2f':k.includes('ä¸‹')?'#2e7d32':k.includes('é£')?'#616161':'#1976d2' }
    }));
    const dom = document.getElementById('status-chart'); if(statusChart) statusChart.dispose(); statusChart = echarts.init(dom);
    statusChart.setOption({
        tooltip: { trigger:'axis', axisPointer:{type:'shadow'} }, legend: { top:0 },
        grid: { left:'10%', top:'30px', bottom:'30px' }, xAxis: { type:'category', data:dates },
        yAxis: { type:'value' }, dataZoom: [{type:'inside'}, {type:'slider', bottom:0, height:20}], series
    });
}
function renderTradeLog(hist, dateMap) {
    const box = document.getElementById('trade-log-list'); box.innerHTML = '';
    const maxLev = parseFloat(document.getElementById('pMaxLev').value) || 2.0;
    
    // åªæ˜¾ç¤ºæœ€è¿‘ 30 å¤©çš„æœ‰æ•ˆæ—¥å¿—é˜²æ­¢å¡é¡¿ï¼Œæˆ–è€…å€’åºå…¨éƒ¨
    // è¿™é‡Œç®€å•å®ç°
    let html = '';
    for(let i=hist.length-1; i>0; i--) {
        const today=hist[i], yest=hist[i-1];
        let changes = [];
        Object.keys(today.breakdown).forEach(n => {
            const now = today.breakdown[n]/maxLev*100, prev = (yest.breakdown[n]||0)/maxLev*100;
            if(Math.abs(now-prev)>0.1) {
                const sToday = dateMap[today.date]?.stocks[n], sYest = dateMap[yest.date]?.stocks[n];
                const lNow = sToday?sToday.lev:0, lPrev=sYest?sYest.lev:0;
                const isPassive = Math.abs(lNow-lPrev)<0.01;
                changes.push({name:n, diff:now-prev, val:`${prev.toFixed(1)}â†’${now.toFixed(1)}%`, reason: isPassive?'è¢«åŠ¨':'ä¸»åŠ¨', realReason: batchResults.find(r=>r.stockName==n)?.history.find(h=>h.date==today.date)?.reason||''});
            }
        });
        if(changes.length===0) continue;
        
        changes.sort((a,b)=>Math.abs(b.diff)-Math.abs(a.diff));
        const net = changes.reduce((a,b)=>a+b.diff,0);
        html += `<div class="daily-log-header" onclick="toggleDailyLog(this)">
            <div style="font-weight:bold;color:#555;">${today.date} <span style="font-size:11px;padding:2px 5px;background:${net>0?'#d32f2f':net<0?'#2e7d32':'#999'};color:#fff;border-radius:3px;">${net>0?'+':''}${net.toFixed(1)}%</span></div><span class="arrow-daily">â–¶</span></div>
            <div class="daily-log-body">${changes.map(c=>`
                <div class="daily-item">
                    <div style="display:flex;align-items:center;gap:5px;"><span style="font-weight:500">${c.name}</span><span style="font-size:10px;color:#999;background:#f0f0f0;padding:1px 3px;">${c.reason}</span><span style="font-size:10px;color:#aaa;max-width:120px;overflow:hidden;white-space:nowrap;">${c.realReason}</span></div>
                    <span style="color:${c.diff>0?'#d32f2f':'#2e7d32'};font-weight:bold;">${c.diff>0?'+':''}${c.diff.toFixed(1)}% <span style="color:#999;font-weight:normal;font-size:11px;">(${c.val})</span></span>
                </div>`).join('')}</div>`;
    }
    box.innerHTML = html || '<div style="padding:20px;text-align:center;color:#999">æ— è°ƒä»“è®°å½•</div>';
}
function renderTrendLog() {
    const box = document.getElementById('trend-log-list'); box.innerHTML = '';
    let dateMap = {}; let dates = new Set();
    batchResults.forEach(r => r.history.forEach(d => { if(!dateMap[d.date]) dateMap[d.date]={}; dateMap[d.date][r.stockName]=d.status; dates.add(d.date); }));
    const sortedDates = Array.from(dates).sort().reverse();
    
    let html = '';
    for(let i=0; i<sortedDates.length-1; i++) {
        const d = sortedDates[i], prevD = sortedDates[i+1];
        let changes = {'ä¸Šæ¶¨è¶‹åŠ¿':[],'ä¸‹è·Œè¶‹åŠ¿':[],'è§¦å‘é£æ§':[]};
        batchResults.forEach(r => {
            const now = dateMap[d][r.stockName], prev = dateMap[prevD][r.stockName];
            if(now && prev && now!==prev && changes[now]) changes[now].push(r.stockName);
        });
        if(Object.values(changes).every(a=>a.length===0)) continue;
        
        html += `<div class="daily-log-header" onclick="toggleDailyLog(this)"><b>${d}</b> <span class="arrow-daily">â–¶</span></div>
        <div class="daily-log-body">
            ${changes['ä¸Šæ¶¨è¶‹åŠ¿'].length ? `<div style="margin-bottom:5px;"><span class="badge bg-red">å…¥ä¸Šæ¶¨</span> ${changes['ä¸Šæ¶¨è¶‹åŠ¿'].join(', ')}</div>` : ''}
            ${changes['ä¸‹è·Œè¶‹åŠ¿'].length ? `<div style="margin-bottom:5px;"><span class="badge bg-green">å…¥ä¸‹è·Œ</span> ${changes['ä¸‹è·Œè¶‹åŠ¿'].join(', ')}</div>` : ''}
            ${changes['è§¦å‘é£æ§'].length ? `<div><span class="badge bg-gray">è§¦é£æ§</span> ${changes['è§¦å‘é£æ§'].join(', ')}</div>` : ''}
        </div>`;
    }
    box.innerHTML = html || '<div style="padding:20px;text-align:center;color:#999">æ— è¶‹åŠ¿å˜æ›´</div>';
}
function renderContributionChart(hist) {
    const dom = document.getElementById('contribution-chart'); if(contributionChart) contributionChart.dispose(); contributionChart = echarts.init(dom);
    const series = batchResults.map(r => ({ name:r.stockName, type:'line', stack:'T', areaStyle:{}, showSymbol:false, lineStyle:{width:0}, data: hist.map(h=>h.contribBreakdown[r.stockName]||0) }));
    contributionChart.setOption({
        tooltip: { trigger:'axis', order:'valueDesc' }, legend: { type:'scroll', top:0 },
        grid: { left:'10%', right:'8%', bottom:'25px' }, xAxis: { type:'category', boundaryGap:false, data:hist.map(h=>h.date) },
        yAxis: { type:'value', axisLabel:{formatter:v=>(v*100).toFixed(0)+'%'} }, dataZoom: [{type:'inside'}, {type:'slider', bottom:0, height:20}], series
    });
}

window.addEventListener('beforeunload', (e) => { if (localStorage.getItem('gridHasUnsavedChanges') === 'true') { e.preventDefault(); e.returnValue = ''; } });
echarts.connect('g');

// è‡ªåŠ¨æ‹‰å–
(async function() {
    if(localStorage.getItem("github_token")) {
        try { await syncFromGithub(); } catch(e){}
    }
})();
</script>
</body>
</html>
