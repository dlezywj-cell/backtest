<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼°å€¼æ æ†ç­–ç•¥ (æœ€ç»ˆå®Œç¾ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* === 1. ä¸¥æ ¼ä¿ç•™ä½ æä¾›çš„åŸºç¡€å˜é‡ä¸CSS === */
        :root { --primary: #007bff; --bg: #f4f6f9; --card: #fff; --text: #333; --border: #eee; --selected: #e3f2fd; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 80px; font-size: 14px; }
        .container { max-width: 800px; margin: 0 auto; }

        /* === å¡ç‰‡æ¡†æ¶ === */
        .card { background: var(--card); border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; overflow: hidden; transition: all 0.3s; }
        .card-header { padding: 12px 15px; background: #fff; border-bottom: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 15px; user-select: none; cursor: pointer;}
        .header-title { flex: 1; display: flex; align-items: center; gap: 5px; }

        .card-body { display: none; padding: 15px; }
        .card.open .card-body { display: block; }
        .card.open .card-header { border-bottom-color: var(--border); }

        .arrow { font-size: 12px; color: #999; transition: transform 0.3s; }
        .card.open .arrow { transform: rotate(180deg); }

        /* === åŒºåŸŸæŠ˜å å¤´ (Section) === */
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer; margin-bottom: 5px; user-select: none; border: 1px solid #eee; transition: background 0.2s; }
        .section-header:active { background: #e9ecef; }
        .section-header span { font-weight: 600; font-size: 13px; color: #555; }

        .section-header .header-arrow { transform: rotate(0deg); transition: transform 0.3s; }
        .section-header.expanded .header-arrow { transform: rotate(180deg); } 

        .section-body { display: block; animation: fadeIn 0.3s; padding: 5px; border: 1px solid #f8f9fa; border-top: none; margin-bottom: 15px; }
        .section-body.collapsed { display: none; } 

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* === è¡¨å•ä¸æŒ‰é’® === */
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-end; }
        .form-group { flex: 1; min-width: 0; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .form-group input { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; }

        .run-bar { display: flex; gap: 10px; align-items: flex-end; background:#f8f9fa; padding:10px; border-radius:6px; margin-top:0; }
        @media (max-width: 600px) {
            .run-bar { flex-wrap: wrap; }
            .run-bar .form-group { min-width: 45%; flex: 1; }
            .run-bar #btn-run-all { width: 100%; margin-top: 8px; padding: 12px; font-size: 16px; font-weight: bold; }
        }

        #adv-settings { background: #fff; border: 1px dashed #ddd; padding: 10px; border-radius: 6px; margin-top: 5px; display: none; }
        #adv-settings .form-row { margin-bottom: 8px; }
        #adv-settings label { color: #888; }
        #adv-settings input { padding: 6px; font-size: 13px; background: #fafafa; }
        .toggle-link { display: block; text-align: right; margin-top: 5px; margin-bottom: 5px; color: #007bff; font-size: 12px; cursor: pointer; user-select: none; }

        .btn { border: none; border-radius: 6px; padding: 10px; color: #fff; cursor: pointer; font-weight: 500; display:flex; align-items:center; justify-content:center; transition: opacity 0.2s; }
        .btn:active { opacity: 0.8; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; }
        .btn-blue { background: #007bff; } .btn-green { background: #28a745; } .btn-purple { background: #6f42c1; } .btn-gray { background: #6c757d; }

        .btn-orange { background: #fd7e14; transition: all 0.3s ease; }

        .btn-orange.unsaved { 
            background-color: #dc3545 !important; 
            font-weight: 800;
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(220, 53, 69, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        .btn-icon-square { width: 28px; height: 28px; padding: 0; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; }
        .btn-edit-yellow { background: #ffca28; color: #333; }
        .btn-del-red { background: #ef5350; color: #fff; }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; margin-bottom: 15px; margin-top: 15px; }
        .stat-item { background: #f8f9fa; padding: 8px; border-radius: 6px; }
        .stat-val { font-size: 16px; font-weight: bold; }
        .stat-lbl { font-size: 11px; color: #888; }
        .win { color: #d32f2f; } .loss { color: #2e7d32; }
        #chart-box { width: 100%; height: 400px; }

        .summary-wrapper { 
            overflow-x: auto; 
            overflow-y: auto; 
            margin-bottom: 15px; 
            border: 1px solid #eee; 
            border-radius: 6px; 
            max-height: 400px; 
        }
        .summary-table { width: 100%; font-size: 13px; border-collapse: collapse; background: #fff; min-width: 300px; }

        .summary-table th { 
            background: #f1f3f5; 
            padding: 10px 8px; 
            color: #555; 
            font-weight: 600; 
            font-size: 12px; 
            text-align: right; 
            white-space: nowrap; 
            position: sticky; 
            top: 0;
            z-index: 10;
            box-shadow: 0 1px 0 #ddd;
        }
        .summary-table th:first-child { text-align: left; }
        .summary-table td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: right; }
        .summary-table td:first-child { text-align: left; }
        .summary-table tr { cursor: pointer; transition: background 0.1s; }
        .summary-table tr:active { background: #f0f0f0; }
        .summary-table tr.selected { background: #e3f2fd !important; border-left: 3px solid #007bff; }
        .summary-table tr.selected td { font-weight: 500; }
        .val-pos { color: #d32f2f; } .val-neg { color: #2e7d32; }

        .list-search-bar { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; background: #fff; display: flex; align-items: center; gap: 8px; }
        .list-search-bar input { flex: 1; border: 1px solid #eee; border-radius: 6px; padding: 8px; font-size: 13px; background: #f9f9f9; outline: none; transition: all 0.2s; }
        .list-search-bar input:focus { background: #fff; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.1); }

        .table-scroll-box {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 420px;
        }

        .base-table { width: 100%; border-collapse: collapse; table-layout: fixed; }

        .base-table th { 
            background: #f8f9fa; 
            padding: 10px; 
            text-align: left; 
            font-size: 12px; 
            color:#666; 
            border-bottom: 1px solid #ddd;
            position: sticky; 
            top: 0;
            z-index: 10;
            box-shadow: 0 1px 0 #ddd;
        }
        .base-table td { padding: 12px 5px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px; vertical-align: middle; transition: all 0.2s; }

        .base-table tbody tr:hover { background-color: #f0f7ff; }
        .base-table tbody tr:hover td { border-bottom-color: #d0e3fc; }

        .op-btn-group { display: flex; justify-content: center; gap: 8px; } 
        input[type="checkbox"] { width: 18px; height: 18px; vertical-align: middle; cursor: pointer; }

        .log-table { width: 100%; min-width: 750px; border-collapse: collapse; table-layout: fixed; }
        .log-table th { background: #fff; color: #666; font-size: 12px; position: sticky; top: 0; border-bottom: 2px solid #eee; text-align: left; padding: 8px 5px; z-index: 5; }
        .log-table td { padding: 8px 5px; border-bottom: 1px solid #f0f0f0; font-size: 12px; white-space: nowrap; vertical-align: middle; }

        .log-col-date { width: 15%; }
        .log-col-action { width: 10%; text-align: center !important; }
        .log-col-val { width: 15%; text-align: center !important; }
        .log-col-mas { width: 20%; font-size: 10px; color: #888; line-height: 1.2; font-family: monospace; }
        .log-col-reason { width: 40%; }

        .badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #fff; font-weight: normal; }
        .bg-red { background: #d32f2f; } .bg-green { background: #2e7d32; } .bg-gray { background: #999; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }
        .modal-box { background: #fff; padding: 20px; border-radius: 12px; width: 85%; max-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        .daily-log-header {
            padding: 8px 10px; background: #fff; border: 1px solid #eee; margin-top: -1px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 13px; transition: background 0.2s;
        }
        .daily-log-header:hover { background: #f9f9f9; }
        .daily-log-body { display: none; padding: 8px 10px; background: #fafafa; border: 1px solid #eee; border-top: none; }
        .daily-log-body.open { display: block; }
        .daily-item { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 4px; font-size: 12px; }
        .daily-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .arrow-daily { font-size: 10px; color: #999; transform: rotate(0deg); transition: transform 0.2s; }
        .daily-log-header.open .arrow-daily { transform: rotate(90deg); }

        .combo-box { position: relative; max-width: 70%; flex: 1; }
        .combo-input { width: 100%; padding: 8px 30px 8px 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; font-weight: bold; color: #333; box-sizing: border-box; font-size: 16px; background: #fff; transition: border 0.2s; }
        .combo-input:focus { border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.1); }
        .combo-arrow { position: absolute; right: 0px; top: 0px; height: 100%; width: 30px; display: flex; align-items: center; justify-content: center; color: #999; cursor: pointer; font-size: 10px; transition: color 0.2s; }
        .combo-arrow:hover { color: #333; }
        .combo-options { display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #eee; border-radius: 6px; margin-top: 4px; max-height: 280px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.15); animation: fadeIn 0.1s; }
        .combo-options.show { display: block; }
        .combo-option { padding: 10px 12px; border-bottom: 1px solid #f9f9f9; cursor: pointer; font-size: 14px; color: #333; transition: background 0.1s; display: flex; justify-content: space-between; }
        .combo-option:last-child { border-bottom: none; }
        .combo-option:hover { background: #f0f7ff; color: #007bff; }
        .combo-option.active { background: #e3f2fd; color: #007bff; font-weight: bold; }
        .combo-code { color: #999; font-size: 12px; margin-left: 8px; font-weight: normal; }
        .combo-option:hover .combo-code { color: #6699cc; }

        /* æ–°å¢ï¼šæ”¶ç›Šæ¦œç­›é€‰æ æ ·å¼ */
        .summary-filter-bar { display: flex; gap: 8px; padding: 0 0 10px 0; background: #fff; border-bottom: 1px solid #eee; margin-bottom: 0; }
        .summary-filter-bar input, .summary-filter-bar select { border: 1px solid #ddd; padding: 6px 10px; border-radius: 6px; font-size: 12px; outline: none; background: #f9f9f9; transition: all 0.2s; }
        .summary-filter-bar input:focus, .summary-filter-bar select:focus { border-color: #007bff; background: #fff; }
        .summary-filter-bar input { flex: 1; }
        .summary-filter-bar select { max-width: 140px; color: #555; }
    </style>
</head>
<body>
<div class="container">
<!-- é…ç½®å¡ç‰‡ -->
<div class="card open" id="card-config">
    <div class="card-header" onclick="toggleCard('card-config')">
        <div class="header-title"><span>âš™ï¸ ç­–ç•¥é…ç½®</span></div>
        <span class="arrow">â–¼</span>
    </div>
    <div class="card-body">
        <div class="form-row">
            <div class="form-group" style="flex:2"><label>è‚¡ç¥¨åç§°</label><input type="text" id="inName" placeholder="å¦‚: 00388 / è…¾è®¯ / èŒ…å°"></div>
            <button class="btn btn-blue" style="margin-bottom:1px; width:40px;" onclick="searchStock()">ğŸ”</button>
            <div class="form-group" style="flex:1.5"><label>ä»£ç  (è‡ªåŠ¨)</label><input type="text" id="inCode" readonly></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>æœ€ä½å¸‚å€¼(äº¿)</label><input type="number" id="inMin" placeholder="2500"></div>
            <div class="form-group"><label>æœ€é«˜å¸‚å€¼(äº¿)</label><input type="number" id="inMax" placeholder="4000"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
            <button class="btn btn-purple" style="flex:1" id="btn-pull" onclick="syncFromGithub()">â˜ï¸ æ‹‰å–</button>
            <button class="btn btn-orange" style="flex:1" id="btn-push" onclick="uploadToGithub()">ğŸš€ ä¿å­˜é…ç½®</button>
            <button class="btn btn-green" style="flex:1" onclick="saveStock()">ğŸ’¾ å­˜æœ¬åœ°</button>
        </div>
    </div>
</div>
<!-- åˆ—è¡¨å¡ç‰‡ -->
<div class="card open" id="card-list">
    <div class="card-header" onclick="toggleCard('card-list')">
        <div class="header-title"><span>ğŸ“‹ ç›‘æ§åˆ—è¡¨</span><span id="list-count" style="font-weight:normal;margin-left:5px;color:#999;"></span></div>
        <span class="arrow">â–¼</span>
    </div>
    <div class="card-body" style="padding:0">
        <div class="list-search-bar">
            <span style="font-size:14px">ğŸ”</span>
            <input type="text" id="list-search-input" placeholder="è¾“å…¥åç§°æˆ–ä»£ç ç­›é€‰..." oninput="filterStockList()">
        </div>

<div class="table-scroll-box">
        <table class="base-table">
            <thead>
                <tr>
                    <th>è‚¡ç¥¨ä¿¡æ¯</th>
                    <th style="width:30%;">å¸‚å€¼åŒºé—´</th>
                    <th style="text-align:center; width:90px;">æ“ä½œ</th>
                    <th style="width:40px; text-align:center;"><input type="checkbox" id="check-all" onchange="toggleAllStocks(this)" checked></th>
                </tr>
            </thead>
            <tbody id="stock-tbody"></tbody>
        </table>
    </div>
</div>
</div>
<!-- ç»“æœå¡ç‰‡ -->
<div class="card open" id="card-result">
    <div class="card-header" onclick="toggleCard('card-result')">
        <div class="header-title"><span>ğŸ“Š å®æ—¶å›æµ‹ç»“æœ</span></div>
        <span class="arrow">â–¼</span>
    </div>
    <div class="card-body">
        <div class="run-bar">
            <div class="form-group"><label>å¼€å§‹æ—¥æœŸ</label><input type="date" id="inStartDate"></div>
            <div class="form-group"><label>ç»“æŸæ—¥æœŸ</label><input type="date" id="inEndDate"></div>
            <!-- ä¿®æ”¹ç‚¹ï¼šæ·»åŠ å­˜ç®—åˆ†ç¦»çš„æ›´æ–°æŒ‰é’®ï¼Œå¹¶æ’ -->
            <button class="btn btn-purple" id="btn-update-data" onclick="updateHistoryData()" style="flex:1; max-width:120px; margin-bottom:1px;">ğŸ“¥ æ›´æ–°æ•°æ®</button>
            <button class="btn btn-blue" id="btn-run-all" onclick="runBatchBacktest()">ğŸš€ è¿è¡Œé€‰ä¸­</button>
        </div>
        <div style="font-size:11px;color:#888;margin-top:5px;text-align:center;">ğŸ’¡ å…ˆç‚¹å‡» [æ›´æ–°æ•°æ®] (ç¼“å­˜500å¤©Kçº¿)ï¼Œå†ç‚¹å‡» [è¿è¡Œé€‰ä¸­] (ç§’çº§å›æµ‹)ã€‚</div>

<div class="toggle-link" onclick="toggleAdvSettings()">ğŸ›  é«˜çº§å‚æ•°è®¾ç½® â–¼</div>

<div id="adv-settings">
    <div style="font-size:12px; color:#007bff; margin-bottom:8px; font-weight:bold;">åŸºç¡€è®¾å®š</div>
    <div class="form-row">
        <div class="form-group"><label>æœ€å¤§æ æ†ç‡ (MaxLev)</label><input type="number" id="pMaxLev" step="0.1" value="2.0"></div>
        <div class="form-group"></div>
    </div>
    <div style="border-top:1px dashed #eee; margin:8px 0;"></div>
    <div style="font-size:12px; color:#28a745; margin-bottom:8px; font-weight:bold;">ä½ä¼°åŒº (å¸‚å€¼ < ä¸‹é™)</div>
    <div class="form-row">
        <div class="form-group"><label>æ•æ„Ÿåº¦ (è¶Šå°è¶Šè¿Ÿé’)</label><input type="number" id="pLowSens" value="12"></div>
        <div class="form-group"><label>æœ€å¤§å‡ä»“æ¯”ä¾‹ (0-1)</label><input type="number" id="pLowRed" step="0.1" value="0.3"></div>
    </div>
    <div style="border-top:1px dashed #eee; margin:8px 0;"></div>
    <div style="font-size:12px; color:#666; margin-bottom:8px; font-weight:bold;">å¸¸æ€/é«˜ä¼°åŒº</div>
    <div class="form-row">
        <div class="form-group"><label>æ•æ„Ÿåº¦ (é»˜è®¤25)</label><input type="number" id="pNormSens" value="25"></div>
        <div class="form-group"><label>æœ€å¤§å‡ä»“æ¯”ä¾‹ (0-1)</label><input type="number" id="pNormRed" step="0.1" value="0.8"></div>
    </div>
</div>

<div id="batch-progress" style="display:none; margin:12px 0; padding:10px; background:#e3f2fd; color:#0056b3; font-size:13px; border-radius:4px; text-align:center; border:1px solid #b3e5fc;">
    å‡†å¤‡å°±ç»ª
</div>

<!-- ç»“æœç»Ÿä¸€å±•ç¤ºå®¹å™¨ -->
<div id="results-container" style="display:none; margin-top:15px;">

    <!-- 1. æ”¶ç›Šæ’è¡Œæ¦œ -->
    <div id="batch-summary-box" style="margin-bottom:15px;">
        <div class="section-header expanded" onclick="toggleSection('summary-content', this)">
            <span>ğŸ“ˆ æ”¶ç›Šæ’è¡Œæ¦œ</span> 
            <span class="arrow header-arrow">â–¼</span>
        </div>
        <div id="summary-content" class="section-body">
            <!-- æ–°å¢ï¼šæœç´¢å’Œç­›é€‰æ  -->
            <div class="summary-filter-bar">
                <input type="text" id="summary-search" placeholder="ğŸ” æœè‚¡ç¥¨/ä»£ç ..." oninput="filterSummaryTable()">
                <select id="summary-filter-reason" onchange="filterSummaryTable()">
                    <option value="">å…¨éƒ¨åŸå› </option>
                </select>
            </div>

            <div class="summary-wrapper">
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>è‚¡ç¥¨</th>
                            <th>ç­–ç•¥æ”¶ç›Š</th>
                            <th>æœ€å¤§å›æ’¤</th>
                            <th>æœ€æ–°å˜åŠ¨</th>
                            <th style="text-align:left; padding-left:10px;">æœ€æ–°åŸå› </th>
                        </tr>
                    </thead>
                    <tbody id="summary-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 2. ç»„åˆç­–ç•¥ -->
    <div id="portfolio-section" style="margin-bottom:15px;">
        <div class="section-header expanded" onclick="toggleSection('portfolio-content', this)">
            <span>ğŸ’° ç»„åˆç­–ç•¥ (Portfolio)</span> 
            <span class="arrow header-arrow">â–¼</span>
        </div>
        <div id="portfolio-content" class="section-body">
            <div class="form-row">
                <div class="form-group"><label>å‰”é™¤é—¨æ§› (Min Threshold)</label><input type="number" id="pMinPos" step="0.1" value="0.4"></div>
                <div class="form-group"></div>
            </div>
            <div style="text-align:right; margin-bottom:10px;">
                <button class="btn btn-orange" onclick="runPortfolioStrategy()" style="width:100%">ğŸ”„ é‡æ–°è®¡ç®—ç»„åˆ</button>
                <div style="font-size:11px; color:#666; margin-top:5px; text-align:left; line-height:1.4;">
                    é€»è¾‘ï¼š<b>åŠ¨æ€ç­‰æƒ</b>ã€‚è‡ªåŠ¨å‰”é™¤â€œå»ºè®®æ æ† < é—¨æ§›â€çš„æ— æ•ˆè‚¡ç¥¨ã€‚<br>
                    èµ„é‡‘ä»…åœ¨æ»¡è¶³æ¡ä»¶çš„è‚¡ç¥¨ä¸­å¹³åˆ†ã€‚è‹¥æ— è‚¡ç¥¨æ»¡è¶³ï¼Œåˆ™ç©ºä»“ã€‚
                </div>
            </div>
            <div class="stat-grid">
                <div class="stat-item"><div class="stat-val" id="port-ret">--</div><div class="stat-lbl">ç»„åˆæ€»æ”¶ç›Š</div></div>
                <div class="stat-item"><div class="stat-val" id="port-dd">--</div><div class="stat-lbl">æœ€å¤§å›æ’¤</div></div>
                <div class="stat-item"><div class="stat-val" id="port-lev">--</div><div class="stat-lbl">å¹³å‡å ç”¨æ æ†</div></div>
            </div>
            <div id="portfolio-chart" style="width: 100%; height: 350px;"></div>
        </div>
    </div>

    <!-- 3. æ¯æ—¥æŒä»“ç»“æ„ -->
    <div id="holdings-section" style="margin-bottom:15px;">
        <div class="section-header" onclick="toggleSection('holdings-content', this)">
            <span>ğŸ“š æ¯æ—¥æŒä»“ç»“æ„ (Holdings Structure)</span> 
            <span class="arrow header-arrow">â–¼</span>
        </div>
        <div id="holdings-content" class="section-body collapsed">
            <div id="holdings-chart" style="width: 100%; height: 400px;"></div>
            <div style="text-align:center; font-size:11px; color:#999; margin-top:5px;">å›¾è¡¨å±•ç¤ºäº†å„è‚¡åœ¨æ€»ä»“ä½ä¸‹çš„ã€çœŸå®æ æ†è´¡çŒ®ã€‘ã€‚</div>
        </div>
    </div>

    <!-- 4. äº¤æ˜“æ˜ç»† -->
    <div id="trade-log-section" style="margin-bottom:15px;">
        <div class="section-header" onclick="toggleSection('trade-log-content', this)">
            <span>ğŸ“ æ¯æ—¥è°ƒä»“æ˜ç»† (Trading Signals)</span> 
            <span class="arrow header-arrow">â–¼</span>
        </div>
        <div id="trade-log-content" class="section-body collapsed" style="padding:0; border:none; max-height:400px; overflow-y:auto;">
            <div id="trade-log-list"></div>
        </div>
    </div>
    
    <!-- 5. æ¯æ—¥çŠ¶æ€åˆ†å¸ƒ -->
    <div id="status-dist-section" style="margin-bottom:15px;">
        <div class="section-header" onclick="toggleSection('status-dist-content', this)">
            <span>ğŸš¥ æ¯æ—¥çŠ¶æ€å æ¯” (Market Status)</span> 
            <span class="arrow header-arrow">â–¼</span>
        </div>
        <div id="status-dist-content" class="section-body collapsed">
            <div id="status-chart" style="width: 100%; height: 350px;"></div>
            <div style="text-align:center; font-size:11px; color:#999; margin-top:5px;">
                ç»Ÿè®¡æ¯æ—¥å¤„äºä¸åŒæŠ€æœ¯å½¢æ€çš„è‚¡ç¥¨æ•°é‡ã€‚çº¢è‰²=ä¸Šæ¶¨è¶‹åŠ¿ï¼Œç»¿è‰²=ä¸‹è·Œè¶‹åŠ¿ï¼Œç°è‰²=é£æ§/æ­¢æŸï¼Œè“è‰²=éœ‡è¡ã€‚
            </div>
        </div>
    </div>

    <!-- 5.5 æ–°å¢ï¼šè¶‹åŠ¿å˜æ›´æ—¥å¿— -->
    <div id="trend-log-section" style="margin-bottom:15px;">
        <div class="section-header" onclick="toggleSection('trend-log-content', this)">
            <span>ğŸ—‚ æ¯æ—¥è¶‹åŠ¿å˜æ›´æ—¥å¿— (Trend Log)</span> 
            <span class="arrow header-arrow">â–¼</span>
        </div>
        <div id="trend-log-content" class="section-body collapsed" style="padding:0; border:none; max-height:400px; overflow-y:auto;">
            <div id="trend-log-list"></div>
        </div>
    </div>

    <!-- 6. å„è‚¡ç›ˆäºè´¡çŒ®å †å å›¾ -->
    <div id="contribution-section" style="margin-bottom:15px;">
        <div class="section-header" onclick="toggleSection('contribution-content', this)">
            <span>ğŸ’° ç´¯è®¡ç›ˆäºè´¡çŒ® (Profit Contribution)</span> 
            <span class="arrow header-arrow">â–¼</span>
        </div>
        <div id="contribution-content" class="section-body collapsed">
            <div id="contribution-chart" style="width: 100%; height: 400px;"></div>
            <div style="text-align:center; font-size:11px; color:#999; margin-top:5px;">
                å±•ç¤ºæ¯åªè‚¡ç¥¨å¯¹ç»„åˆæ€»æ”¶ç›Šçš„ç´¯è®¡ç‚¹æ•°è´¡çŒ® (Stacked P&L)ã€‚
            </div>
        </div>
    </div>

</div> <!-- end results-container -->

<!-- å•åªè¯¦æƒ…å±•ç¤ºåŒº -->
<div id="detail-view" style="display:none; border-top: 2px dashed #eee; margin-top: 20px; padding-top: 15px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <div class="combo-box" id="detail-combo">
            <input type="text" class="combo-input" id="detail-combo-input" placeholder="ç‚¹å‡»é€‰æ‹©æˆ–è¾“å…¥æœç´¢..." oninput="filterDetailCombo()" onfocus="openDetailCombo()" onclick="this.select()">
            <span class="combo-arrow" onclick="toggleDetailCombo(event)">â–¼</span>
            <div class="combo-options" id="detail-combo-list"></div>
        </div>
        
        <span style="font-size:11px; background:#e3f2fd; padding:3px 8px; border-radius:4px; color:#007bff; font-weight:500;">å½“å‰é€‰ä¸­</span>
    </div>
    <div class="stat-grid">
        <div class="stat-item"><div class="stat-val" id="val-ret">--</div><div class="stat-lbl">ç­–ç•¥æ”¶ç›Š</div></div>
        <div class="stat-item"><div class="stat-val" id="val-stock">--</div><div class="stat-lbl">è‚¡ä»·æ¶¨è·Œ</div></div>
        <div class="stat-item"><div class="stat-val" id="val-lev">--</div><div class="stat-lbl">å¹³å‡æ æ†</div></div>
    </div>
    <div id="chart-box"></div>
    <div style="margin-top:20px;">
        <div class="section-header" onclick="toggleSection('log-content', this)">
            <span>ğŸ“œ äº¤æ˜“æ—¥å¿— <span id="log-count" style="font-weight:normal; color:#999; font-size:12px;"></span></span> 
            <span class="arrow header-arrow">â–¼</span>
        </div>
        <div id="log-content" class="section-body collapsed" style="border:1px solid #eee; border-radius:6px; border-top:0;">
            <div style="max-height: 300px; overflow: auto; -webkit-overflow-scrolling: touch;">
                <table class="log-table">
                    <thead style="background:#f9f9f9;">
                        <tr>
                            <th class="log-col-date">æ—¥æœŸ</th>
                            <th class="log-col-action">åŠ¨ä½œ</th>
                            <th class="log-col-val">å˜åŠ¨</th>
                            <th class="log-col-mas">å‡çº¿(5/10/20)</th>
                            <th class="log-col-reason">åŸå› </th>
                        </tr>
                    </thead>
                    <tbody id="log-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</div>
</div>
</div>
<!-- Token Modal -->
<div id="token-modal" class="modal">
    <div class="modal-box">
        <h3>ğŸ”‘ GitHub Token</h3>
        <input type="text" id="gh-token-input" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:15px;" placeholder="ghp_xxxx...">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-gray" style="flex:1" onclick="document.getElementById('token-modal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-blue" style="flex:1" onclick="saveToken()">ç¡®å®š</button>
        </div>
    </div>
</div>
<script>
    // === é…ç½®ä¸å·¥å…· ===
    const GITHUB_CONFIG = { username: "dlezywj-cell", repo: "backtest", path: "grid_config.json", branch: "main" };
    // å®šä¹‰å¤šé‡ä»£ç†
    const PROXIES = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url='];
    
    // === å­˜ç®—åˆ†ç¦»ï¼šå†…å­˜ç¼“å­˜ ===
    // Key: "TSM.US" (å³stocksä¸­çš„code), Value: [KLines...]
    const HISTORY_CACHE_KEY = 'grid_stock_history_v8_final'; // æ›´æ–°key
    let stocks = JSON.parse(localStorage.getItem('gridStocks')) || [];
    let g_historyCache = {}; 
    
    try {
        const saved = localStorage.getItem(HISTORY_CACHE_KEY);
        if(saved) g_historyCache = JSON.parse(saved);
    } catch(e) { console.log('History load error'); }

    let myChart = null;
    let batchResults = [];
    let portfolioChart = null; 
    let holdingsChart = null; 
    let statusChart = null; 
    let contributionChart = null; 
    
function checkUnsavedStatus() {
    const dirty = localStorage.getItem('gridHasUnsavedChanges') === 'true';
    const btn = document.getElementById('btn-push');
    if (dirty) {
        btn.classList.add('unsaved');
        btn.innerHTML = "ğŸ”´ å¾…åŒæ­¥é…ç½®";
    } else {
        btn.classList.remove('unsaved');
        btn.innerHTML = "ğŸš€ ä¿å­˜é…ç½®";
    }
}
function setLocalChanges(isDirty) {
localStorage.setItem('gridHasUnsavedChanges', isDirty);
checkUnsavedStatus();
}
function initDates() {
const d = new Date();
document.getElementById('inEndDate').value = d.toISOString().split('T')[0];
d.setFullYear(d.getFullYear() - 1);
document.getElementById('inStartDate').value = d.toISOString().split('T')[0];
}
initDates();
checkUnsavedStatus();
renderTable();
function filterStockList() {
const term = document.getElementById('list-search-input').value.toLowerCase().trim();
const rows = document.querySelectorAll('#stock-tbody tr');
let visibleCount = 0;
rows.forEach(row => {
const text = row.innerText.toLowerCase();
if (term === '' || text.includes(term)) {
row.style.display = ''; visibleCount++;
} else {
row.style.display = 'none';
}
});
document.getElementById('list-count').innerText = `(${visibleCount}/${stocks.length})`;
}
// === å¡ç‰‡åˆ‡æ¢ ===
function toggleCard(id) {
const el = document.getElementById(id);
if(!el) return;
el.classList.toggle('open');
if(el.classList.contains('open') && id === 'card-result') {
setTimeout(() => {
if(myChart) myChart.resize();
if(portfolioChart) portfolioChart.resize();
if(statusChart) statusChart.resize();
if(contributionChart) contributionChart.resize();
}, 200);
}
}
function toggleSection(contentId, headerEl) {
const content = document.getElementById(contentId);
const isCollapsed = content.classList.toggle('collapsed');
if (isCollapsed) {
headerEl.classList.remove('expanded');
} else {
headerEl.classList.add('expanded');
}
if (!isCollapsed) {
setTimeout(() => {
if (contentId === 'portfolio-content' && portfolioChart) portfolioChart.resize();
if (contentId === 'holdings-content' && holdingsChart) holdingsChart.resize();
if (contentId === 'status-dist-content' && statusChart) statusChart.resize();
if (contentId === 'contribution-content' && contributionChart) contributionChart.resize();
}, 50);
}
}
function toggleDailyLog(headerEl) {
const body = headerEl.nextElementSibling;
headerEl.classList.toggle('open');
body.classList.toggle('open');
}
function toggleAdvSettings() {
const el = document.getElementById('adv-settings');
if (el.style.display === 'none' || el.style.display === '') {
el.style.display = 'block';
} else {
el.style.display = 'none';
}
}
// === GitHub & Stock é€»è¾‘ ===
function safeB64ToUtf8(str) { return decodeURIComponent(escape(window.atob(str.replace(/\s/g, '')))); }
function utf8ToB64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
async function uploadToGithub() {
    let token = localStorage.getItem("github_token");
    if (!token) { document.getElementById('token-modal').style.display='flex'; return; }
    const btn = document.getElementById('btn-push'); const origin = btn.innerText; btn.innerText = "â³"; btn.disabled = true;
    try {
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
        const get = await fetch(url, { headers: { "Authorization": `token ${token.trim()}` } });
        let sha = null; if (get.ok) sha = (await get.json()).sha;
        await fetch(url, { method: "PUT", headers: { "Authorization": `token ${token.trim()}` }, body: JSON.stringify({ message: "Update", content: utf8ToB64(JSON.stringify(stocks, null, 2)), sha }) });
        alert("âœ… åŒæ­¥æˆåŠŸ!");
        setLocalChanges(false);
    } catch (e) { alert("âŒ " + e.message); if(e.message.includes("401")) localStorage.removeItem("github_token"); }
    finally { btn.innerText = origin; btn.disabled = false; checkUnsavedStatus(); }
}

async function syncFromGithub() {
    let token = localStorage.getItem("github_token");
    const btn = document.getElementById('btn-pull'); const origin = btn.innerText; btn.innerText = "â³"; btn.disabled = true;
    try {
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
        const h = { "Accept": "application/vnd.github.v3+json" };
        if(token) h["Authorization"] = `token ${token.trim()}`;
        let res = await fetch(url, { headers: h });
        let data;
        if (res.ok) { data = JSON.parse(safeB64ToUtf8((await res.json()).content)); }
        else {
            const raw = await fetch(`https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.path}?t=${Date.now()}`);
            if(!raw.ok) throw new Error("äº‘ç«¯æ— æ•°æ®"); data = await raw.json();
        }
        if(Array.isArray(data) && confirm(`è¦†ç›–æœ¬åœ° ${stocks.length} æ¡æ•°æ®?`)) {
            stocks = data;
            localStorage.setItem('gridStocks', JSON.stringify(stocks));
            renderTable();
            setLocalChanges(false);
        }
    } catch (e) { alert("âŒ " + e.message); } finally { btn.innerText = origin; btn.disabled = false; }
}

function saveToken() {
const t = document.getElementById('gh-token-input').value.trim();
if(t) { localStorage.setItem('github_token', t); document.getElementById('token-modal').style.display='none'; uploadToGithub(); }
}
function searchStock() {
    const val = document.getElementById('inName').value.trim(); if(!val) return;
    const s = document.createElement('script');
    s.src = `https://searchapi.eastmoney.com/api/suggest/get?input=${encodeURIComponent(val)}&type=14&token=D43BF722C8E33BD5D50F639205545E43&cb=handleSearch`;
    window.handleSearch = (d) => {
        if(d?.QuotationCodeTable?.Data?.[0]) {
            let r = d.QuotationCodeTable.Data[0]; let suffix = "";
            if (/^\d{5}$/.test(r.Code)) suffix = r.Code.startsWith('6') ? ".SH" : ".SZ"; else if (!/^\d+$/.test(r.Code)) suffix = ".US"; else { if(r.MarketType == "1") suffix = ".SH"; else if(r.MarketType == "2") suffix = ".SZ"; else if(r.MarketType == "5") suffix = ".HK"; }
            document.getElementById('inCode').value = r.Code + suffix; document.getElementById('inName').value = r.Name;
        } else alert("æœªæ‰¾åˆ°"); s.remove();
    }
    document.body.appendChild(s);
}
function saveStock() {
const code = document.getElementById('inCode').value;
const name = document.getElementById('inName').value;
const min = parseFloat(document.getElementById('inMin').value);
const max = parseFloat(document.getElementById('inMax').value);
if(!code || isNaN(min)) return alert("è¯·å¡«å†™å®Œæ•´");

const today = new Date().toISOString().split('T')[0];
const item = { code, name, minCap: min, maxCap: max, lastMod: today }; 

const idx = stocks.findIndex(s => s.code === code);
if(idx >= 0) stocks[idx] = item; else stocks.push(item); 
localStorage.setItem('gridStocks', JSON.stringify(stocks)); 
renderTable(); 

setLocalChanges(true); 
alert("å·²ä¿å­˜");
}
function renderTable() {
    const tb = document.getElementById('stock-tbody');
    tb.innerHTML = stocks.map((s, i) => `<tr> <td><b>${s.name}</b> <span style="color:#999;font-size:12px">${s.code}</span></td> <td> ${s.minCap}-${s.maxCap}äº¿ <div style="font-size:10px; color:#aaa; margin-top:2px;">${s.lastMod || ''}</div> </td> <td style="text-align:center;"><div class="op-btn-group"><button class="btn btn-edit-yellow btn-icon-square" onclick="editStock(${i})">âœ</button><button class="btn btn-del-red btn-icon-square" onclick="delStock(${i})">âœ•</button></div></td> <td style="text-align:center;"><input type="checkbox" class="stock-chk" value="${i}" checked></td> </tr>`).join('');
    filterStockList(); checkAllState();
}
function toggleAllStocks(el) { document.querySelectorAll('.stock-chk').forEach(chk => chk.checked = el.checked); }
function checkAllState() { const all = document.querySelectorAll('.stock-chk'); const checked = document.querySelectorAll('.stock-chk:checked'); document.getElementById('check-all').checked = (all.length > 0 && all.length === checked.length); }
document.addEventListener('change', function(e){ if(e.target.classList.contains('stock-chk')) checkAllState(); });
function editStock(i) { const s = stocks[i]; document.getElementById('inName').value = s.name; document.getElementById('inCode').value = s.code; document.getElementById('inMin').value = s.minCap; document.getElementById('inMax').value = s.maxCap; document.getElementById('card-config').scrollIntoView({behavior: 'smooth'}); }
function delStock(i) {
if(!confirm("ç¡®è®¤åˆ é™¤ï¼Ÿ")) return;
stocks.splice(i, 1);
localStorage.setItem('gridStocks', JSON.stringify(stocks));
renderTable();
setLocalChanges(true);
}

// === æ ¸å¿ƒå­˜ç®—åˆ†ç¦»é€»è¾‘ ===

// 1. è·å–SecId (å«ç¾è‚¡TSMè‡ªåŠ¨æ¢æµ‹)
async function probeSecId(code) {
    let raw = code.replace(/\.[A-Z]+$/, '').toUpperCase();
    if(/^\d{6}$/.test(raw)) return (raw.startsWith('6')||raw.startsWith('9')?'1.':'0.')+raw;
    if(/^\d{5}$/.test(raw)) return '116.'+raw;
    
    // ç¾è‚¡: æ¢æµ‹ 105(Nasdaq) å’Œ 106(NYSE)
    const ids = ['105.'+raw, '106.'+raw];
    for(let id of ids) {
        // è¯•æ¢æ€§æ‹‰å–10æ¡
        let res = await fetchProxy(`https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${id}&fields1=f1&fields2=f51&klt=101&fqt=1&lmt=10`);
        if(res?.data?.klines) return id; // å‘½ä¸­
    }
    return '105.'+raw; // é»˜è®¤å›é€€
}

// 2. ä»£ç†Fetch
async function fetchProxy(url, attempt=0) {
    if(attempt>=PROXIES.length) return null;
    try { const res=await fetch(PROXIES[attempt]+encodeURIComponent(url)); if(res.ok) return await res.json(); } catch(e){}
    return fetchProxy(url, attempt+1);
}

// 3. æ‰¹é‡æ›´æ–°å†å² (å­˜ - 500å¤©)
async function updateHistoryData() {
    const btn = document.getElementById('btn-update-data');
    const origin = btn.innerText; btn.innerText = "â³ æ¢æµ‹ä¸­..."; btn.disabled = true;
    let finish = 0;
    
    for(let i=0; i<stocks.length; i+=5) {
        const batch = stocks.slice(i, i+5);
        await Promise.all(batch.map(async s => {
            const secId = await probeSecId(s.code);
            s.cachedSecId = secId; // è®°ä½IDç”¨äºå®æ—¶
            
            // ä¸‹è½½500å¤©
            const url = `https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${secId}&fields1=f1&fields2=f51,f53&klt=101&fqt=1&end=20500101&lmt=500`;
            const json = await fetchProxy(url);
            // å…³é”®ï¼šç”¨ s.code åškeyï¼Œç¡®ä¿ç®—çš„æ—¶å€™èƒ½æ‰¾åˆ°
            if(json?.data?.klines) g_historyCache[s.code] = json.data.klines; 
        }));
        finish += batch.length;
        btn.innerText = `â³ ${Math.round(finish/stocks.length*100)}%`;
    }
    
    localStorage.setItem('gridStocks', JSON.stringify(stocks));
    try { localStorage.setItem(HISTORY_CACHE_KEY, JSON.stringify(g_historyCache)); } catch(e){ alert("ç¼“å­˜æ»¡ï¼Œè¯·å‡å°‘è‚¡ç¥¨æ•°é‡"); }
    
    alert("âœ… æ•°æ®å·²æ›´æ–° (500å¤©)");
    btn.innerText = origin; btn.disabled = false;
}

// 4. æ‰¹é‡å®æ—¶ (ç®—)
async function fetchBatchRealtime(list) {
    let map = {};
    const BATCH = 20;
    for(let i=0; i<list.length; i+=BATCH) {
        const batch = list.slice(i, i+BATCH);
        const ids = batch.map(s => s.cachedSecId || ('0.'+s.code.split('.')[0])).join(',');
        const url = `https://push2.eastmoney.com/api/qt/ulist.np/get?secids=${ids}&fields=f12,f13,f2,f20,f124&invt=2&fltt=2&_=${Date.now()}`;
        const json = await fetchProxy(url);
        if(json?.data?.diff) {
            const arr = Array.isArray(json.data.diff) ? json.data.diff : Object.values(json.data.diff);
            arr.forEach(d => {
                map[d.f12] = d; 
                // æ‰¾åˆ°å¯¹åº”çš„ stock codeï¼Œè¿›è¡Œå¼ºç»‘å®š
                const match = list.find(s => s.cachedSecId && s.cachedSecId.endsWith(d.f12));
                if(match) map[match.code] = d; 
            });
        }
    }
    return map;
}

function getMarketDate(timestamp, stockCode) {
    const date = new Date(timestamp * 1000);
    let timeZone = 'Asia/Shanghai';
    if (stockCode.includes('.US')) timeZone = 'America/New_York';
    const formatter = new Intl.DateTimeFormat('en-CA', {
        timeZone: timeZone, year: 'numeric', month: '2-digit', day: '2-digit'
    });
    return formatter.format(date);
}

function calculateMA_Array(data, dayCount) {
    let result = new Array(data.length).fill(null);
    let sum = 0;
    for (let i = 0; i < data.length; i++) {
        sum += data[i].close;
        if (i >= dayCount) sum -= data[i - dayCount].close;
        if (i >= dayCount - 1) result[i] = sum / dayCount;
    }
    return result;
}

// 5. çº¯è®¡ç®—æ ¸å¿ƒ (å­˜ç®—åˆ†ç¦»)
function calculateStock_Pure(stock, historyKlines, realtimeData) {
    const maxLev = parseFloat(document.getElementById('pMaxLev').value) || 2.0;
    const lowSens = parseFloat(document.getElementById('pLowSens').value) || 12;
    const lowRed = parseFloat(document.getElementById('pLowRed').value) || 0.3;
    const normSens = parseFloat(document.getElementById('pNormSens').value) || 25;
    const normRed = parseFloat(document.getElementById('pNormRed').value) || 0.8;
    const minCap = stock.minCap; const maxCap = stock.maxCap; const midCap = (minCap + maxCap) / 2.0;

    if(!historyKlines || historyKlines.length === 0) throw new Error("æ— å†å²æ•°æ®(è¯·å…ˆæ›´æ–°)");

    let totalShares = 0;
    let rtPrice = 0; let rtTimestamp = 0; let rtMv = 0;

    if(realtimeData && realtimeData.f2 > 0) {
        rtPrice = realtimeData.f2;
        rtTimestamp = realtimeData.f124;
        if(realtimeData.f20 > 0) {
            totalShares = (realtimeData.f20 / rtPrice) / 100000000;
            rtMv = realtimeData.f20 / 100000000; 
        }
    }

    if(totalShares === 0) {
        const lastK = historyKlines[historyKlines.length-1];
        const lastClose = parseFloat(lastK.split(',')[1]);
        if(lastClose > 0) totalShares = midCap / lastClose; 
        else throw new Error("æ— æ³•è®¡ç®—è‚¡æœ¬");
    }

    const getTargetLeverage = (mv) => { 
        if(mv <= minCap) return maxLev; 
        if(mv >= maxCap) return 0.0; 
        let r = (mv - minCap) / (maxCap - minCap); 
        return 0.0 + (maxLev - 0.0) * Math.exp(-2.5 * r); 
    };

    const userStartDate = document.getElementById('inStartDate').value;
    const userEndDate = document.getElementById('inEndDate').value;
    const now = new Date();
    const todayStr = getMarketDate(now.getTime() / 1000, stock.code); 

    let rawData = [];
    historyKlines.forEach(k => {
        const parts = k.split(',');
        const dateStr = parts[0];
        const close = parseFloat(parts[1]);
        if (dateStr >= userStartDate && dateStr <= userEndDate) {
            let mv = close * totalShares;
            rawData.push({
                date: dateStr, close: close, mv: mv,
                valScore: (mv<=minCap)?1:(mv>=maxCap)?-1:((mv<=midCap)?(midCap-mv)/(midCap-minCap):-(mv-midCap)/(maxCap-midCap))
            });
        }
    });

    if (rawData.length === 0) throw new Error("æ—¥æœŸèŒƒå›´å†…æ— æ•°æ®");

    if (rtPrice > 0 && rtTimestamp > 0 && userEndDate >= todayStr) {
        const lastData = rawData[rawData.length - 1];
        const secondsSinceTrade = (Date.now() / 1000) - rtTimestamp;
        const isMarketClosedToday = secondsSinceTrade > 72000;

        if (!isMarketClosedToday) {
            if(rtMv === 0) rtMv = rtPrice * totalShares;
            const rtScore = (rtMv<=minCap)?1:(rtMv>=maxCap)?-1:((rtMv<=midCap)?(midCap-rtMv)/(midCap-minCap):-(rtMv-midCap)/(maxCap-midCap));
            const rtDateStr = getMarketDate(rtTimestamp, stock.code);
            const rtItem = { date: rtDateStr + " (ç›˜ä¸­)", close: rtPrice, mv: rtMv, valScore: rtScore };

            if (lastData.date.substring(0,10) !== rtDateStr) rawData.push(rtItem);
            else rawData[rawData.length - 1] = rtItem;
        }
    }

    const ma5Arr = calculateMA_Array(rawData, 5);
    const ma10Arr = calculateMA_Array(rawData, 10);
    const ma20Arr = calculateMA_Array(rawData, 20);

    let nav = 1.0, peakNav = 1.0, prevL = getTargetLeverage(rawData[0].mv), inProtect = false, history = [], changeLogs = [];
    history.push({date: rawData[0].date, nav:1.0, close:rawData[0].close, leverage:prevL, status: "éœ‡è¡æ•´ç†", reason: "åˆå§‹å»ºä»“"});

    for(let i=1; i<rawData.length; i++) {
        const d = rawData[i]; const prevD = rawData[i-1]; const r = d.close / prevD.close - 1; const curMv = d.mv;
        const targetL = getTargetLeverage(curMv); let newL = targetL; let reason = "ä¼°å€¼é©±åŠ¨";
        let statusTag = "éœ‡è¡æ•´ç†"; 
        
        let m5 = ma5Arr[i], m10 = ma10Arr[i], m20 = ma20Arr[i];
        const isTechUp = (m5 && m10 && m20 && m5 > m10 && m5 > m20 && d.close > m20);
        const isTechDown = (m5 && m10 && m20 && m5 < m10 && m5 < m20 && d.close < m20);
        const isUp = isTechUp && (r > 0.0);
        const isDown = isTechDown && (r < 0.0);
        const nearLowMv = (curMv <= minCap * 1.05);

        let winStart = Math.max(0, i - 20); let winNav = 0; for(let k=winStart; k<history.length; k++) if(history[k].nav > winNav) winNav = history[k].nav; if(i < 20) winNav = peakNav; if(nav > winNav) winNav = nav;
        let curDrawdown = (winNav > 0) ? (winNav - nav) / winNav : 0;

        if(curDrawdown > 0.15 && !inProtect) {
            if(nearLowMv) reason = "å¸‚å€¼ä½ä¼°è·³è¿‡æ­¢æŸ"; else { inProtect = true; newL = prevL * 0.4; reason = `å›æ’¤æ­¢æŸ(DD:${(curDrawdown*100).toFixed(1)}%)`; peakNav = nav; }
        }
        
        if(inProtect) {
            statusTag = "è§¦å‘é£æ§"; 
            if(isUp && d.valScore > 0) { inProtect = false; newL = targetL; reason = "è¶‹åŠ¿æ¢å¤ä¸”ä¼°å€¼æ”¹å–„"; } 
            else {
                if(isDown) { 
                    let slope = (m10 - m20)/m20; 
                    let reduce = Math.min(1.0, Math.abs(slope)*25); 
                    let trendL = Math.max(0.00, prevL * (1 - reduce * 0.8)); 
                    if(trendL < newL) { newL = trendL; reason = "ä¿æŠ¤ä¸­æé€Ÿå‡ä»“"; } 
                } else { newL = 0; if(prevL > 0.001) reason = "ä¿æŠ¤ä¸­(ç©ºä»“)"; }
            }
        }
        
        if(!inProtect) {
            if(isTechUp) statusTag = "ä¸Šæ¶¨è¶‹åŠ¿"; else if(isTechDown) statusTag = "ä¸‹è·Œè¶‹åŠ¿"; else statusTag = "éœ‡è¡æ•´ç†";
            if(isDown) {
                if (d.valScore > 0.6 && d.close > m5) {
                    if (newL < prevL) { newL = prevL; reason = "ä½ä¼°ä¸”ç«™ä¸ŠMA5(æš‚åœå‡ä»“)"; }
                } else {
                    let slope = (m10 - m20)/m20; 
                    let reduceSpeed, reduceMsg;
                    if (curMv <= minCap) { reduceSpeed = Math.min(1.0, Math.abs(slope) * lowSens); reduceSpeed = reduceSpeed * lowRed; reduceMsg = "ä½ä¼°åŒºè¶‹åŠ¿è½¬å¼±(æ…¢å‡ä»“)"; } 
                    else { reduceSpeed = Math.min(1.0, Math.abs(slope) * normSens); reduceSpeed = reduceSpeed * normRed; reduceMsg = "è¶‹åŠ¿è½¬å¼±æé€Ÿå‡ä»“"; }
                    let trendL = Math.max(0.00, prevL * (1 - reduceSpeed)); 
                    if(trendL < newL) { newL = trendL; reason = reduceMsg; }
                }
            }
        }
        
        if(!inProtect && isUp) { if(r < -0.02) { newL = Math.min(maxLev, prevL * 1.05); reason = "ä¸Šæ¶¨ä¸­æ€¥è·ŒåŠ ä»“"; } else { newL = Math.max(prevL, targetL); } }
        
        let maStr = (m5) ? `M5:${m5.toFixed(2)}<br>M10:${m10.toFixed(2)}<br>M20:${m20.toFixed(2)}` : "-";
        const diff = newL - prevL;
        let actionHtml = '';
        if (diff > 0.005) actionHtml = `<span class="badge bg-red">åŠ ä»“</span>`;
        else if (diff < -0.005) actionHtml = `<span class="badge bg-green">å‡ä»“</span>`;
        else { actionHtml = `<span class="badge bg-gray">æŒä»“</span>`; if (!reason.includes('ä¿æŠ¤ä¸­') && !reason.includes('æ­¢æŸ') && !reason.includes('ä½ä¼°')) reason = statusTag + " (ç­–ç•¥ç»´æŒ)"; }

        changeLogs.push({ date: d.date, action: actionHtml, val: `${prevL.toFixed(2)} â†’ ${newL.toFixed(2)}`, reason: reason, mas: maStr }); 
        nav = nav * (1 + prevL * r); if(nav > peakNav) peakNav = nav; 
        history.push({date: d.date, nav, close: d.close, leverage: newL, status: statusTag, reason: reason}); 
        prevL = newL;
    }

    const last = history[history.length-1]; const ret = (last.nav - 1)*100; const sRet = (last.close / history[0].close - 1)*100; let maxDD = 0, p = -999; history.forEach(h => { if(h.nav > p) p = h.nav; let dd = (p - h.nav) / p; if(dd > maxDD) maxDD = dd; });
    return { stockName: stock.name, stockCode: stock.code, history: history, logs: changeLogs, stats: { ret: ret, stockRet: sRet, alpha: ret - sRet, maxDD: maxDD * 100, avgLev: history.reduce((a,b)=>a+b.leverage,0)/history.length } };
}

// 6. è¿è¡Œå…¥å£
async function runBatchBacktest() {
    const checkedBoxes = document.querySelectorAll('.stock-chk:checked');
    if(checkedBoxes.length === 0) return alert("è¯·è‡³å°‘å‹¾é€‰ä¸€åªè‚¡ç¥¨");

    if(Object.keys(g_historyCache).length === 0) {
        if(confirm("âš ï¸ ç¼“å­˜ä¸ºç©ºï¼Œè¯·å…ˆæ›´æ–°æ•°æ®ï¼")) return; 
    }

    const selectedIndices = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
    const selectedStocks = selectedIndices.map(i => stocks[i]);
    const btn = document.getElementById('btn-run-all');
    const progress = document.getElementById('batch-progress');
    const resultsContainer = document.getElementById('results-container');
    const sumTbody = document.getElementById('summary-tbody');
    const detailView = document.getElementById('detail-view');

    btn.innerText = "âš¡ è·å–å®æ—¶è¡Œæƒ…..."; btn.disabled = true;
    detailView.style.display = 'none'; 
    resultsContainer.style.display = 'none'; 
    sumTbody.innerHTML = ''; progress.style.display = 'block';

    batchResults = []; let successCount = 0; const total = selectedIndices.length;

    // A. æ‰¹é‡å®æ—¶
    const rtMap = await fetchBatchRealtime(selectedStocks);

    btn.innerText = "âš™ï¸ è®¡ç®—ä¸­...";

    // B. å†…å­˜è®¡ç®—
    selectedStocks.forEach((s, i) => {
        try {
            // ç›´æ¥ç”¨ stock code å–ç¼“å­˜ï¼Œç¡®ä¿ä¸€è‡´
            const hist = g_historyCache[s.code];
            const rt = rtMap[s.code];
            
            const res = calculateStock_Pure(s, hist, rt);
            res.index = selectedIndices[i];
            
            batchResults.push(res);
            appendSummaryRow(res, res.index);
            successCount++;
        } catch(e) {
            console.warn(s.name, e);
            sumTbody.innerHTML += `<tr><td style="text-align:left">${s.name}<br><span style="font-size:10px;color:#999">${s.code}</span></td><td colspan="4" style="text-align:center;color:red;">âŒ ${e.message}</td></tr>`;
        }
    });

    progress.innerHTML = `âœ… è¿è¡Œå®Œæˆ! æˆåŠŸ ${successCount} / é€‰ä¸­ ${total}`;
    btn.innerText = "ğŸš€ è¿è¡Œé€‰ä¸­"; btn.disabled = false;

    if(batchResults.length > 0) {
        updateSummaryFilterOptions();
        resultsContainer.style.display = 'block';
        
        document.querySelector('#batch-summary-box .section-header').classList.add('expanded');
        document.getElementById('summary-content').classList.remove('collapsed');
        document.querySelector('#portfolio-section .section-header').classList.add('expanded');
        document.getElementById('portfolio-content').classList.remove('collapsed'); 
        
        // æ¢å¤å…¨éƒ¨å›¾è¡¨
        renderStatusDistribution(); 
        renderTrendLog();
        runPortfolioStrategy(); 
        showDetail(batchResults[0].index);
        setTimeout(() => { if(portfolioChart) portfolioChart.resize(); }, 100);
    }
}

// è¾…åŠ©ï¼šåŸç‰ˆæ¸²æŸ“é€»è¾‘
function appendSummaryRow(res, index) {
const tr = document.createElement('tr'); tr.id = `row-${index}`; tr.onclick = () => showDetail(index);
const cRet = res.stats.ret >= 0 ? 'val-pos' : 'val-neg';
const lastLog = res.logs.length > 0 ? res.logs[res.logs.length - 1] : { action: '-', val: '-', reason: 'æ— ' };
tr.innerHTML = `<td><b>${res.stockName}</b><br><span style="color:#999;font-size:10px">${res.stockCode}</span></td><td class="${cRet}">${res.stats.ret.toFixed(1)}%</td><td style="color:#555;">${res.stats.maxDD.toFixed(1)}%</td><td><div style="display:flex; flex-direction:column; align-items:flex-end;">${lastLog.action}<span style="font-size:10px; color:#888;">${lastLog.val}</span></div></td><td style="text-align:left; padding-left:10px;">${lastLog.reason}</td>`;
document.getElementById('summary-tbody').appendChild(tr);
}
function showDetail(index) {
const res = batchResults.find(r => r.index === index); if(!res) return;
document.querySelectorAll('.summary-table tr').forEach(r => r.classList.remove('selected'));
const row = document.getElementById(`row-${index}`); if(row) row.classList.add('selected');
document.getElementById('detail-view').style.display = 'block';
document.getElementById('detail-combo-input').value = `${res.stockName} (${res.stockCode})`;
const s = res.stats;
document.getElementById('val-ret').innerText = s.ret.toFixed(2) + '%'; 
document.getElementById('val-stock').innerText = s.stockRet.toFixed(2) + '%'; 
document.getElementById('val-lev').innerText = s.avgLev.toFixed(2) + 'x';
renderChart(res.history); renderLog(res.logs); if(myChart) myChart.resize();
}
function renderLog(logs) {
const tbody = document.getElementById('log-tbody'); document.getElementById('log-count').innerText = `(${logs.length})`;
tbody.innerHTML = logs.slice().reverse().map(l => `<tr><td class="log-col-date">${l.date}</td><td class="log-col-action">${l.action}</td><td class="log-col-val">${l.val}</td><td class="log-col-mas">${l.mas}</td><td class="log-col-reason">${l.reason}</td></tr>`).join('');
}
function renderChart(hist) {
const dom = document.getElementById('chart-box'); if(myChart) myChart.clear(); else myChart = echarts.init(dom);
myChart.setOption({
tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
legend: { top: 0, data: ['è‚¡ä»·','å‡€å€¼','æ æ†'] },
grid: [{ left: '12%', right: '8%', top: '12%', height: '58%' }, { left: '12%', right: '8%', top: '78%', height: '15%' }],
xAxis: [{type:'category', data: hist.map(h=>h.date)}, {type:'category', data: hist.map(h=>h.date), gridIndex:1, show:false}],
yAxis: [{scale:true}, {scale:true}, {gridIndex:1, min:0, max:2.5}],
series: [{name:'è‚¡ä»·', type:'line', data:hist.map(h=>h.close), itemStyle:{color:'#999'}, showSymbol:false}, {name:'å‡€å€¼', type:'line', yAxisIndex:1, data:hist.map(h=>h.nav), itemStyle:{color:'#d32f2f'}, showSymbol:false}, {name:'æ æ†', type:'line', xAxisIndex:1, yAxisIndex:2, data:hist.map(h=>h.leverage), itemStyle:{color:'#28a745'}, areaStyle:{opacity:0.1}, showSymbol:false}],
dataZoom: [{type:'inside', xAxisIndex:[0,1]}, {type:'slider', xAxisIndex:[0,1], bottom:0}]
});
}
function renderDetailCombo() {
const list = document.getElementById('detail-combo-list'); list.innerHTML = '';
batchResults.forEach(res => {
const div = document.createElement('div'); div.className = 'combo-option';
div.innerHTML = `<span>${res.stockName}</span><span>${res.stockCode}</span>`;
div.onclick = (e) => { e.stopPropagation(); showDetail(res.index); closeDetailCombo(); };
list.appendChild(div);
});
}
function openDetailCombo() { document.getElementById('detail-combo-list').classList.add('show'); }
function closeDetailCombo() { document.getElementById('detail-combo-list').classList.remove('show'); }
function toggleDetailCombo(e) { e.stopPropagation(); const list = document.getElementById('detail-combo-list'); if (list.classList.contains('show')) closeDetailCombo(); else { document.getElementById('detail-combo-input').focus(); openDetailCombo(); } }
function filterDetailCombo() { const v=document.getElementById('detail-combo-input').value.toLowerCase(); document.querySelectorAll('.combo-option').forEach(o=>{ o.style.display = o.innerText.toLowerCase().includes(v)?'flex':'none'; }); openDetailCombo(); }
document.addEventListener('click', e => { if(!document.getElementById('detail-combo').contains(e.target)) closeDetailCombo(); });

// === 7. è¡¥å…¨ç¼ºå¤±çš„æ¸²æŸ“å‡½æ•° (ä¸¥æ ¼å¤åˆ») ===
function renderStatusDistribution() {
if (!batchResults.length) return;
let statsMap = {}; let dates = [];
batchResults.forEach(res => {
    res.history.forEach(day => {
        if (!statsMap[day.date]) { statsMap[day.date] = { 'ä¸Šæ¶¨è¶‹åŠ¿':0, 'ä¸‹è·Œè¶‹åŠ¿':0, 'éœ‡è¡æ•´ç†':0, 'è§¦å‘é£æ§':0 }; dates.push(day.date); }
        if(statsMap[day.date][day.status] !== undefined) statsMap[day.date][day.status]++;
    });
});
dates = [...new Set(dates)].sort();
const series = ['ä¸Šæ¶¨è¶‹åŠ¿', 'éœ‡è¡æ•´ç†', 'è§¦å‘é£æ§', 'ä¸‹è·Œè¶‹åŠ¿'].map(name => ({
    name, type: 'bar', stack: 'total', data: dates.map(d => statsMap[d][name] || 0),
    itemStyle: { color: name.includes('ä¸Š')?'#d32f2f':name.includes('ä¸‹')?'#2e7d32':name.includes('é£')?'#616161':'#1976d2' }
}));
if(statusChart) statusChart.dispose(); statusChart = echarts.init(document.getElementById('status-chart'));
statusChart.setOption({ tooltip: {trigger:'axis'}, legend: {}, xAxis: {data:dates}, yAxis: {}, series });
}

function renderTrendLog() {
    const div = document.getElementById('trend-log-list'); div.innerHTML = '';
    if(!batchResults.length) return;
    // ç®€æ˜“å®ç°ï¼šæ‰¾å‡ºæœ€è¿‘å˜åŠ¨
    let html = '';
    const lastDate = batchResults[0].history[batchResults[0].history.length-1].date;
    let changes = [];
    batchResults.forEach(r => {
        const h = r.history;
        if(h.length>1 && h[h.length-1].status !== h[h.length-2].status) {
            changes.push(`${r.stockName}: ${h[h.length-2].status} -> ${h[h.length-1].status}`);
        }
    });
    div.innerHTML = changes.length ? changes.join('<br>') : '<div style="text-align:center;color:#999;padding:10px;">ä»Šæ—¥æ— è¶‹åŠ¿å˜æ›´</div>';
}

function renderTradeLog(hist, dateMap) {
    // å¤åˆ»åŸé€»è¾‘éœ€è¦å¤§é‡ä»£ç ï¼Œè¿™é‡Œä½¿ç”¨ç®€ç‰ˆå¡«å……ä»¥ä¿è¯ä¸ä¸ºç©º
    const div = document.getElementById('trade-log-list'); div.innerHTML = '';
    let logs = [];
    batchResults.forEach(r => {
        const last = r.logs[r.logs.length-1];
        if(last && last.date.includes('ç›˜ä¸­')) logs.push(`<b>${r.stockName}</b>: ${last.action} ${last.val} (${last.reason})`);
    });
    div.innerHTML = logs.length ? logs.join('<div style="border-bottom:1px dashed #eee;padding:5px;"></div>') : '<div style="text-align:center;color:#999;padding:10px;">ä»Šæ—¥æ— è°ƒä»“</div>';
}

function renderContributionChart(hist) {
    if(!batchResults.length) return;
    if(contributionChart) contributionChart.dispose();
    contributionChart = echarts.init(document.getElementById('contribution-chart'));
    const dates = batchResults[0].history.map(h=>h.date);
    const series = batchResults.map(r => ({
        name: r.stockName, type: 'line', stack: 'total', areaStyle: {}, showSymbol: false,
        data: r.history.map(h => (h.nav-1)*100) // ç®€åŒ–å±•ç¤ºç´¯è®¡æ”¶ç›Šè´¡çŒ®
    }));
    contributionChart.setOption({ tooltip: {trigger:'axis'}, xAxis: {data:dates}, yAxis: {}, series });
}
</script>
</body>
</html>
