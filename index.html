<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼°å€¼æ æ†ç­–ç•¥ (æ¸¯ç¾Aè‚¡å®Œç¾é€‚é…ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* === åŸºç¡€å˜é‡ === */
        :root { --primary: #007bff; --bg: #f4f6f9; --card: #fff; --text: #333; --border: #eee; --selected: #e3f2fd; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 80px; font-size: 14px; }
        .container { max-width: 800px; margin: 0 auto; }

        /* === å¡ç‰‡æ¡†æ¶ === */
        .card { background: var(--card); border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; overflow: hidden; transition: all 0.3s; }
        .card-header { padding: 12px 15px; background: #fff; border-bottom: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 15px; user-select: none; cursor: pointer;}
        .header-title { flex: 1; display: flex; align-items: center; gap: 5px; }
        .card-body { display: none; padding: 15px; }
        .card.open .card-body { display: block; }
        .card.open .card-header { border-bottom-color: var(--border); }
        .arrow { font-size: 12px; color: #999; transition: transform 0.3s; }
        .card.open .arrow { transform: rotate(180deg); }

        /* === è¡¨å•ä¸æŒ‰é’® === */
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-end; }
        .form-group { flex: 1; min-width: 0; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .form-group input { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; }
        
        /* æŒ‰é’®æ ·å¼ç»„ */
        .btn { border: none; border-radius: 6px; padding: 10px; color: #fff; cursor: pointer; font-weight: 500; display:flex; align-items:center; justify-content:center; transition: opacity 0.2s; }
        .btn:active { opacity: 0.8; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; }
        .btn-blue { background: #007bff; } 
        .btn-green { background: #28a745; } 
        .btn-red { background: #dc3545; } 
        .btn-purple { background: #6f42c1; }
        .btn-orange { background: #fd7e14; }
        .btn-gray { background: #6c757d; }
        .btn-sm { padding: 4px 8px; font-size: 12px; border-radius: 4px; margin-left: 4px; }

        /* === ç»Ÿè®¡ä¸å›¾è¡¨ === */
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; margin-bottom: 15px; }
        .stat-item { background: #f8f9fa; padding: 8px; border-radius: 6px; }
        .stat-val { font-size: 16px; font-weight: bold; }
        .stat-lbl { font-size: 11px; color: #888; }
        .win { color: #d32f2f; } .loss { color: #2e7d32; }
        #chart-box { width: 100%; height: 450px; }

        /* === è°ƒè¯•é¢æ¿ === */
        #debug-panel { background: #fff3cd; color: #856404; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 12px; margin-bottom: 15px; display: none; border: 1px solid #ffeeba; }
        
        /* === è¡¨æ ¼ === */
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 12px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px; }
        tr.active-row { background: var(--selected); }
        
        /* === æ—¥å¿—è¡¨æ ¼æ ·å¼ === */
        .log-table th { background: #f8f9fa; color: #666; font-size: 12px; }
        .log-table td { padding: 8px 10px; border-bottom: 1px solid #f0f0f0; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #fff; font-weight: normal; }
        .bg-red { background: #d32f2f; }
        .bg-green { background: #2e7d32; }
        
        /* === æ¨¡æ€æ¡† === */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }
        .modal-box { background: #fff; padding: 20px; border-radius: 12px; width: 85%; max-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
<div class="container">

<!-- é…ç½®å¡ç‰‡ -->
<div class="card open" id="card-config">
    <div class="card-header" onclick="toggleCard('card-config')">
        <div class="header-title"><span>âš™ï¸ ç­–ç•¥é…ç½®</span></div>
        <span class="arrow">â–¼</span>
    </div>
    <div class="card-body">
        <div class="form-row">
            <div class="form-group" style="flex:2"><label>è‚¡ç¥¨åç§°</label><input type="text" id="inName" placeholder="å¦‚: 00388 / è…¾è®¯ / AAPL"></div>
            <button class="btn btn-blue" style="margin-bottom:1px; width:40px;" onclick="searchStock()">ğŸ”</button>
            <div class="form-group" style="flex:1.5"><label>ä»£ç  (è‡ªåŠ¨)</label><input type="text" id="inCode" readonly></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>æœ€ä½å¸‚å€¼(äº¿)</label><input type="number" id="inMin" placeholder="2500"></div>
            <div class="form-group"><label>æœ€é«˜å¸‚å€¼(äº¿)</label><input type="number" id="inMax" placeholder="4000"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
            <button class="btn btn-purple" style="flex:1" id="btn-pull" onclick="syncFromGithub()">â˜ï¸ æ‹‰å–</button>
            <button class="btn btn-orange" style="flex:1" id="btn-push" onclick="uploadToGithub()">ğŸš€ ä¿å­˜</button>
            <button class="btn btn-green" style="flex:1" onclick="saveStock()">ğŸ’¾ å­˜æœ¬åœ°</button>
        </div>
    </div>
</div>

<!-- åˆ—è¡¨å¡ç‰‡ -->
<div class="card open" id="card-list">
    <div class="card-header" onclick="toggleCard('card-list')">
        <div class="header-title"><span>ğŸ“‹ ç›‘æ§åˆ—è¡¨</span></div>
        <span class="arrow">â–¼</span>
    </div>
    <div class="card-body" style="padding:0">
        <div style="overflow-x:auto"><table id="stock-table"><tbody id="stock-tbody"></tbody></table></div>
    </div>
</div>

<!-- ç»“æœå¡ç‰‡ -->
<div class="card open" id="card-result">
    <div class="card-header" onclick="toggleCard('card-result')">
        <div class="header-title"><span id="res-title">ğŸ“Š å›æµ‹ç»“æœ</span></div>
        <span class="arrow">â–¼</span>
    </div>
    <div class="card-body">
        <div class="form-row" style="background:#f8f9fa; padding:10px; border-radius:6px; margin-top:0;">
            <div class="form-group"><label>å¼€å§‹æ—¥æœŸ</label><input type="date" id="inStartDate"></div>
            <div class="form-group"><label>ç»“æŸæ—¥æœŸ</label><input type="date" id="inEndDate"></div>
            <button class="btn btn-blue" id="btn-run" style="margin-bottom:1px; padding:0 20px;" onclick="runSelectedBacktest()" disabled>â–¶ è¿è¡Œ</button>
        </div>

        <div id="debug-panel"></div>

        <div class="stat-grid">
            <div class="stat-item"><div class="stat-val" id="val-ret">--</div><div class="stat-lbl">ç­–ç•¥æ”¶ç›Š</div></div>
            <div class="stat-item"><div class="stat-val" id="val-stock">--</div><div class="stat-lbl">è‚¡ä»·æ¶¨è·Œ</div></div>
            <div class="stat-item"><div class="stat-val" id="val-lev">--</div><div class="stat-lbl">å¹³å‡æ æ†</div></div>
        </div>
        
        <div id="chart-box"></div>
    </div>
</div>

<!-- äº¤æ˜“æ—¥å¿—å¡ç‰‡ -->
<div class="card" id="card-log">
    <div class="card-header" onclick="toggleCard('card-log')">
        <div class="header-title"><span>ğŸ“œ äº¤æ˜“æ—¥å¿—</span><span id="log-count" style="font-weight:normal; font-size:12px; color:#666; margin-left:5px;">(0)</span></div>
        <span class="arrow">â–¼</span>
    </div>
    <div class="card-body" style="padding:0;">
        <div style="max-height: 400px; overflow-y: auto;">
            <table class="log-table">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>åŠ¨ä½œ</th>
                        <th>å˜åŠ¨</th>
                        <th>åŸå› </th>
                    </tr>
                </thead>
                <tbody id="log-tbody">
                    <tr><td colspan="4" style="text-align:center; color:#999;">æš‚æ— æ•°æ®</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

</div>

<!-- Token Modal -->
<div id="token-modal" class="modal">
    <div class="modal-box">
        <h3>ğŸ”‘ GitHub Token</h3>
        <input type="text" id="gh-token-input" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:15px;" placeholder="ghp_xxxx...">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-gray" style="flex:1" onclick="document.getElementById('token-modal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-blue" style="flex:1" onclick="saveToken()">ç¡®å®š</button>
        </div>
    </div>
</div>

<script>
    // === é…ç½®ä¸å·¥å…· ===
    const GITHUB_CONFIG = { username: "dlezywj-cell", repo: "backtest", path: "grid_config.json", branch: "main" };
    const PROXY = 'https://corsproxy.io/?'; 
    let stocks = JSON.parse(localStorage.getItem('gridStocks')) || [];
    let myChart = null;
    let selectedIndex = -1;

    function initDates() {
        const d = new Date();
        document.getElementById('inEndDate').value = d.toISOString().split('T')[0];
        d.setFullYear(d.getFullYear() - 1);
        document.getElementById('inStartDate').value = d.toISOString().split('T')[0];
    }
    initDates();
    renderTable();

    function toggleCard(id) { 
        const el = document.getElementById(id);
        el.classList.toggle('open');
        if(id === 'card-result' && el.classList.contains('open') && myChart) setTimeout(()=>myChart.resize(), 100);
    }

    // === GitHub é€»è¾‘ ===
    function safeB64ToUtf8(str) { return decodeURIComponent(escape(window.atob(str.replace(/\s/g, '')))); }
    function utf8ToB64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
    
    async function uploadToGithub() {
        let token = localStorage.getItem("github_token");
        if (!token) { document.getElementById('token-modal').style.display='flex'; return; }
        const btn = document.getElementById('btn-push'); const origin = btn.innerText; btn.innerText = "â³"; btn.disabled = true;
        try {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
            const get = await fetch(url, { headers: { "Authorization": `token ${token.trim()}` } });
            let sha = null; if (get.ok) sha = (await get.json()).sha;
            await fetch(url, { method: "PUT", headers: { "Authorization": `token ${token.trim()}` }, body: JSON.stringify({ message: "Update", content: utf8ToB64(JSON.stringify(stocks, null, 2)), sha }) });
            alert("âœ… åŒæ­¥æˆåŠŸ!");
        } catch (e) { alert("âŒ " + e.message); if(e.message.includes("401")) localStorage.removeItem("github_token"); } 
        finally { btn.innerText = origin; btn.disabled = false; }
    }
    
    async function syncFromGithub() {
        let token = localStorage.getItem("github_token");
        const btn = document.getElementById('btn-pull'); const origin = btn.innerText; btn.innerText = "â³"; btn.disabled = true;
        try {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
            const h = { "Accept": "application/vnd.github.v3+json" };
            if(token) h["Authorization"] = `token ${token.trim()}`;
            let res = await fetch(url, { headers: h });
            let data;
            if (res.ok) { data = JSON.parse(safeB64ToUtf8((await res.json()).content)); } 
            else { 
                const raw = await fetch(`https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.path}?t=${Date.now()}`); 
                if(!raw.ok) throw new Error("äº‘ç«¯æ— æ•°æ®"); data = await raw.json(); 
            }
            if(Array.isArray(data) && confirm(`è¦†ç›–æœ¬åœ° ${stocks.length} æ¡æ•°æ®?`)) { stocks = data; localStorage.setItem('gridStocks', JSON.stringify(stocks)); selectedIndex = -1; renderTable(); }
        } catch (e) { alert("âŒ " + e.message); } finally { btn.innerText = origin; btn.disabled = false; }
    }
    
    function saveToken() {
        const t = document.getElementById('gh-token-input').value.trim();
        if(t) { localStorage.setItem('github_token', t); document.getElementById('token-modal').style.display='none'; uploadToGithub(); }
    }

    // === è‚¡ç¥¨æœç´¢ ===
    function searchStock() {
        const val = document.getElementById('inName').value.trim();
        if(!val) return;
        const s = document.createElement('script');
        s.src = `https://searchapi.eastmoney.com/api/suggest/get?input=${encodeURIComponent(val)}&type=14&token=D43BF722C8E33BD5D50F639205545E43&cb=handleSearch`;
        window.handleSearch = (d) => {
            if(d?.QuotationCodeTable?.Data?.[0]) {
                let r = d.QuotationCodeTable.Data[0];
                let suffix = "";
                
                if(r.MarketType == "1") suffix = ".SH"; 
                else if(r.MarketType == "2") suffix = ".SZ";
                else if(r.Code.length === 5 && /^\d+$/.test(r.Code)) suffix = ".HK"; 
                else if(!/^\d+$/.test(r.Code)) suffix = ".US"; 
                else if(r.Code.startsWith('6')) suffix = ".SH";
                else suffix = ".SZ";

                document.getElementById('inCode').value = r.Code + suffix;
                document.getElementById('inName').value = r.Name;
            } else alert("æœªæ‰¾åˆ°");
            s.remove();
        }
        document.body.appendChild(s);
    }

    function saveStock() {
        const code = document.getElementById('inCode').value;
        const name = document.getElementById('inName').value;
        const min = parseFloat(document.getElementById('inMin').value);
        const max = parseFloat(document.getElementById('inMax').value);
        if(!code || isNaN(min)) return alert("è¯·å¡«å†™å®Œæ•´");
        
        const item = { code, name, minCap: min, maxCap: max };
        const idx = stocks.findIndex(s => s.code === code);
        if(idx >= 0) stocks[idx] = item; else stocks.push(item);
        localStorage.setItem('gridStocks', JSON.stringify(stocks));
        renderTable();
        alert("å·²ä¿å­˜åˆ°æœ¬åœ°åˆ—è¡¨");
    }

    function renderTable() {
        const tb = document.getElementById('stock-tbody');
        tb.innerHTML = stocks.map((s, i) => `
            <tr class="${i===selectedIndex?'active-row':''}" onclick="selectRow(${i})" style="cursor:pointer">
                <td><b>${s.name}</b> <span style="color:#999;font-size:12px">${s.code}</span></td>
                <td>${s.minCap} - ${s.maxCap}äº¿</td>
                <td style="text-align:right"><button class="btn btn-red btn-sm" onclick="delStock(${i}, event)">åˆ </button></td>
            </tr>
        `).join('');
    }

    function selectRow(i) {
        selectedIndex = i;
        renderTable();
        const s = stocks[i];
        document.getElementById('inName').value = s.name;
        document.getElementById('inCode').value = s.code;
        document.getElementById('inMin').value = s.minCap;
        document.getElementById('inMax').value = s.maxCap;
        document.getElementById('btn-run').disabled = false;
        document.getElementById('res-title').innerText = "ğŸ“Š å¾…å›æµ‹: " + s.name;
    }

    function delStock(i, e) {
        e.stopPropagation();
        if(!confirm("ç¡®è®¤åˆ é™¤ï¼Ÿ")) return;
        stocks.splice(i, 1);
        localStorage.setItem('gridStocks', JSON.stringify(stocks));
        selectedIndex = -1;
        renderTable();
    }

    // === æ ¸å¿ƒå›æµ‹é€»è¾‘ ===
    async function runSelectedBacktest() {
        if(selectedIndex < 0) return;
        const s = stocks[selectedIndex];
        const btn = document.getElementById('btn-run');
        const debugBox = document.getElementById('debug-panel');
        
        btn.innerText = "â³"; btn.disabled = true;
        debugBox.style.display = 'block';
        debugBox.innerHTML = "æ­£åœ¨æ‹‰å–æ•°æ®...";
        document.getElementById('log-tbody').innerHTML = '';
        document.getElementById('log-count').innerText = '(0)';

        try {
            await doBacktest(s);
            document.getElementById('card-result').classList.add('open');
        } catch(e) {
            alert("é”™è¯¯: " + e.message);
            debugBox.innerHTML += `<br><span style="color:red">âŒ é”™è¯¯: ${e.message}</span>`;
        } finally {
            btn.innerText = "â–¶ è¿è¡Œ"; btn.disabled = false;
        }
    }

    // â˜…â˜…â˜… 1. å®Œç¾é€‚é…ä¸œæ–¹è´¢å¯ŒID (æ¸¯è‚¡å¼ºåˆ¶5ä½) â˜…â˜…â˜…
    const getEmSecId = c => {
        let raw = c.replace(/\.[A-Z]+$/, '');
        if (c.includes('.HK')) {
            // æ¸¯è‚¡å¿…é¡» 5 ä½ã€‚ä¾‹å¦‚ 0388 -> 00388, 00388 -> 00388
            return '116.' + raw.padStart(5, '0');
        }
        if (c.includes('.US')) return '105.' + raw;
        if (c.includes('.SH')) return '1.' + raw;
        if (c.includes('.SZ')) return '0.' + raw;
        
        // å…œåº•é€»è¾‘
        if (raw.startsWith('6')) return '1.' + raw;
        // 5ä½çº¯æ•°å­—ä¼˜å…ˆå½“æ¸¯è‚¡
        if (raw.length === 5 && /^\d+$/.test(raw)) return '116.' + raw.padStart(5, '0');
        return '0.' + raw;
    };
    
    // â˜…â˜…â˜… 2. å®Œç¾é€‚é…Yahooä»£ç  (æ¸¯è‚¡å¼ºåˆ¶4ä½) â˜…â˜…â˜…
    const toYahoo = c => {
        let raw = c.replace(/\.[A-Z]+$/, '');
        if (c.includes('.HK')) {
            // Yahoo æ¸¯è‚¡åªè¦ 4 ä½ã€‚ä¾‹å¦‚ 00388 -> 0388.HK
            let num = parseInt(raw, 10);
            return num.toString().padStart(4, '0') + '.HK';
        }
        if (c.includes('.US')) return raw;
        if (c.includes('.SH') || (raw.startsWith('6') && !c.includes('.SZ'))) return raw + '.SS';
        return raw + '.SZ';
    };

    async function fetchEmShares(secId) {
        const url = `https://push2.eastmoney.com/api/qt/ulist.np/get?secids=${secId}&fields=f2,f20&invt=2&fltt=2`;
        const res = await fetch(PROXY + encodeURIComponent(url));
        const json = await res.json();
        return json;
    }

    async function doBacktest(stock) {
        // 1. è·å–æ€»è‚¡æœ¬
        let emSecId = getEmSecId(stock.code);
        let emCode = emSecId.split('.')[1];
        
        // ç¾è‚¡å¤‡é€‰
        let capJson = await fetchEmShares(emSecId);
        if(stock.code.includes('.US') && (!capJson.data || !capJson.data.diff)) {
            emSecId = '106.' + emCode;
            capJson = await fetchEmShares(emSecId);
        }

        let totalShares = 0; 
        let currentPrice = 0;
        let currentMarketCap = 0;

        if(capJson.data?.diff) {
            let d = Array.isArray(capJson.data.diff) ? capJson.data.diff[0] : capJson.data.diff[emCode];
            if(d) {
                currentPrice = d.f2;
                currentMarketCap = d.f20; 
                if(currentPrice > 0) {
                    totalShares = (currentMarketCap / currentPrice) / 100000000; 
                }
            }
        }
        
        const debugBox = document.getElementById('debug-panel');
        
        if(!totalShares) throw new Error(`æ— æ³•è·å–è‚¡æœ¬æ•°æ® (${stock.code})ã€‚è¯·æ£€æŸ¥ä»£ç ã€‚`);

        // 2. è·å–Kçº¿
        const sd = document.getElementById('inStartDate').value;
        const ed = document.getElementById('inEndDate').value;
        const p1 = Math.floor(new Date(sd).getTime()/1000);
        const p2 = Math.floor(new Date(ed).getTime()/1000) + 86400;
        
        const yhTicker = toYahoo(stock.code);
        const yhUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yhTicker}?period1=${p1}&period2=${p2}&interval=1d`;
        const hRes = await fetch(PROXY + encodeURIComponent(yhUrl));
        
        if(!hRes.ok) throw new Error(`Yahooæ•°æ®è¯·æ±‚å¤±è´¥ (${yhTicker})`);
        
        const hJson = await hRes.json();
        const result = hJson.chart.result ? hJson.chart.result[0] : null;
        
        if(!result || !result.timestamp) throw new Error("è¯¥æ—¶é—´æ®µæ— Kçº¿æ•°æ®");
        
        // 3. å‡†å¤‡æ•°æ®
        let rawData = [];
        const quotes = result.indicators.quote[0];
        const minCap = stock.minCap;
        const maxCap = stock.maxCap;
        const midCap = (minCap + maxCap) / 2.0;

        const getTargetLeverage = (mv) => {
            if(mv <= minCap) return 2.0;
            if(mv >= maxCap) return 0.01;
            let r = (mv - minCap) / (maxCap - minCap);
            return 0.01 + (2.0 - 0.01) * Math.exp(-2.5 * r);
        };

        let minHistMv = 999999, maxHistMv = 0;
        result.timestamp.forEach((t, i) => {
            if(quotes.close[i]) {
                let c = parseFloat(quotes.close[i].toFixed(2));
                let mv = c * totalShares; 
                if(mv < minHistMv) minHistMv = mv;
                if(mv > maxHistMv) maxHistMv = mv;

                rawData.push({
                    date: new Date(t*1000).toISOString().split('T')[0],
                    close: c,
                    mv: mv,
                    valScore: (mv<=minCap)?1:(mv>=maxCap)?-1:((mv<=midCap)?(midCap-mv)/(midCap-minCap):-(mv-midCap)/(maxCap-midCap))
                });
            }
        });

        debugBox.innerHTML = `
            <b>ğŸ” æ•°æ®è¯Šæ–­:</b><br>
            ä»£ç : ${stock.code} (Yahoo: ${yhTicker})<br>
            å®é™…å¸‚å€¼èŒƒå›´: <b>${minHistMv.toFixed(2)} - ${maxHistMv.toFixed(2)} äº¿</b><br>
            ä½ çš„è®¾å®šèŒƒå›´: <b>${stock.minCap} - ${stock.maxCap} äº¿</b><br>
            ${maxHistMv < stock.minCap ? '<span style="color:orange">âš ï¸ å®é™…å¸‚å€¼å§‹ç»ˆä½äºè®¾å®šä¸‹é™ï¼Œæ æ†å¯èƒ½é•¿æœŸ2.0</span>' : ''}
            ${minHistMv > stock.maxCap ? '<span style="color:red">âš ï¸ å®é™…å¸‚å€¼å§‹ç»ˆé«˜äºè®¾å®šä¸Šé™ï¼Œæ æ†å°†æä½</span>' : ''}
        `;

        const ma = (idx, n) => {
            if(idx<n) return null;
            let sum=0; for(let k=idx-n; k<idx; k++) sum+=rawData[k].close;
            return sum/n;
        };
        const isUptrend = (i) => {
            if(i<20) return false;
            let m5=ma(i,5), m10=ma(i,10), m20=ma(i,20);
            if(!m5||!m10||!m20) return false;
            return (m5>m10 && m10>m20);
        };

        // === å›æµ‹å¾ªç¯ ===
        let nav = 1.0, peakNav = 1.0;
        let prevL = getTargetLeverage(rawData[0].mv); 
        
        let inProtect = false;
        let history = [];
        let changeLogs = [];

        history.push({date: rawData[0].date, nav:1.0, close:rawData[0].close, leverage:prevL});

        for(let i=1; i<rawData.length; i++) {
            const d = rawData[i];
            const prevD = rawData[i-1];
            const r = d.close / prevD.close - 1;
            const curMv = d.mv;
            
            const targetL = getTargetLeverage(curMv);
            let newL = targetL;
            let reason = "ä¼°å€¼é©±åŠ¨";

            const nearLowMv = (curMv <= minCap * 1.05);

            // 1. å›æ’¤ä¿æŠ¤
            let winStart = Math.max(0, i - 20);
            let winNav = 0;
            for(let k=winStart; k<history.length; k++) if(history[k].nav > winNav) winNav = history[k].nav;
            if(i < 20) winNav = peakNav; 
            if(nav > winNav) winNav = nav;

            let curDrawdown = (winNav > 0) ? (winNav - nav) / winNav : 0;

            if(curDrawdown > 0.15 && !inProtect) {
                if(nearLowMv) {
                    reason = "å¸‚å€¼ä½ä¼°è·³è¿‡æ­¢æŸ"; 
                } else {
                    inProtect = true;
                    newL = prevL * 0.4;
                    reason = `å›æ’¤æ­¢æŸ(DD:${(curDrawdown*100).toFixed(1)}%)`;
                    peakNav = nav;
                }
            }

            // 2. ä¿æŠ¤æœŸå†…æ¢å¤/å‡ä»“
            if(inProtect) {
                let m5=ma(i,5), m10=ma(i,10), m20=ma(i,20);
                let trendUp = (m5 && m10 && m20 && m5 > m10 && m10 > m20);
                
                if(trendUp && d.valScore > 0) { 
                    inProtect = false;
                    newL = targetL; 
                    reason = "è¶‹åŠ¿æ¢å¤ä¸”ä¼°å€¼æ”¹å–„";
                } else {
                    if(m5 && m10 && m20 && m5 < m10 && m10 < m20) {
                        let slope = (m10 - m20)/m20;
                        let reduce = Math.min(1.0, Math.abs(slope)*25);
                        newL = Math.max(0.01, prevL * (1 - reduce * 0.8));
                        reason = "ä¿æŠ¤ä¸­æé€Ÿå‡ä»“";
                    } else {
                        newL = 0.01;
                        if(prevL > 0.02) reason = "ä¿æŠ¤ä¸­(ç©ºä»“)";
                    }
                }
            }

            // 3. æ™®é€šä¸‹è·Œè¶‹åŠ¿
            if(!inProtect) {
                let m5=ma(i,5), m10=ma(i,10), m20=ma(i,20);
                if(m5 && m10 && m20 && m5 < m10 && m10 < m20) {
                    let slope = (m10 - m20)/m20;
                    let reduce = Math.min(1.0, Math.abs(slope)*25);
                    let trendL = Math.max(0.01, prevL * (1 - reduce * 0.8));
                    
                    if(trendL < newL) {
                         newL = trendL;
                         reason = "è¶‹åŠ¿è½¬å¼±æé€Ÿå‡ä»“";
                    }
                }
            }

            // 4. ä¸Šæ¶¨è¶‹åŠ¿
            if(!inProtect && (isUptrend(i))) {
                if(r < -0.02) {
                    newL = Math.min(2.0, prevL * 1.05);
                    reason = "ä¸Šæ¶¨ä¸­æ€¥è·ŒåŠ ä»“";
                } else {
                    newL = Math.max(prevL, targetL);
                }
            }

            if(Math.abs(newL - prevL) > 0.005) { 
                let action = newL > prevL ? "åŠ ä»“" : "å‡ä»“";
                let colorClass = newL > prevL ? "bg-red" : "bg-green";
                changeLogs.push({
                    date: d.date,
                    action: `<span class="badge ${colorClass}">${action}</span>`,
                    val: `${prevL.toFixed(2)} â†’ ${newL.toFixed(2)}`,
                    reason: reason
                });
            }

            nav = nav * (1 + prevL * r);
            if(nav > peakNav) peakNav = nav;
            
            history.push({date: d.date, nav, close: d.close, leverage: newL});
            prevL = newL;
        }

        const last = history[history.length-1];
        const ret = (last.nav - 1)*100;
        const sRet = (last.close / history[0].close - 1)*100;
        const avgL = history.reduce((a,b)=>a+b.leverage,0)/history.length;

        document.getElementById('val-ret').innerText = ret.toFixed(2) + '%';
        document.getElementById('val-ret').className = 'stat-val ' + (ret>=0?'win':'loss');
        document.getElementById('val-stock').innerText = sRet.toFixed(2) + '%';
        document.getElementById('val-stock').className = 'stat-val ' + (sRet>=0?'win':'loss');
        document.getElementById('val-lev').innerText = avgL.toFixed(2) + 'x';

        renderLog(changeLogs);
        renderChart(history);
    }

    function renderLog(logs) {
        const tbody = document.getElementById('log-tbody');
        document.getElementById('log-count').innerText = `(${logs.length})`;
        
        if(logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999">æ— æ“ä½œè®°å½•</td></tr>';
            return;
        }
        tbody.innerHTML = logs.reverse().map(l => `
            <tr>
                <td style="white-space:nowrap; color:#666; font-size:12px;">${l.date}</td>
                <td>${l.action}</td>
                <td style="font-family:monospace; font-size:12px;">${l.val}</td>
                <td style="font-size:12px; color:#555;">${l.reason}</td>
            </tr>
        `).join('');
    }

    function renderChart(hist) {
        const dom = document.getElementById('chart-box');
        if(myChart) myChart.clear(); else myChart = echarts.init(dom);
        const dates = hist.map(h=>h.date);
        
        myChart.setOption({
            tooltip: { 
                trigger: 'axis', axisPointer: {type: 'cross'},
                formatter: p => {
                    let h = `${p[0].name}<br>`;
                    p.forEach(x => {
                        let val = x.value;
                        if(x.seriesName==='æ æ†') val = val.toFixed(2)+'x';
                        else val = val.toFixed(3);
                        h += `${x.marker} ${x.seriesName}: ${val}<br>`
                    });
                    return h;
                }
            },
            legend: { top: 0, data: ['è‚¡ä»·','å‡€å€¼','æ æ†'] },
            grid: [
                {left:'5%', right:'5%', top:'10%', height:'55%', containLabel: true}, 
                {left:'5%', right:'5%', top:'75%', height:'15%', containLabel: true}
            ],
            xAxis: [
                {type:'category', data: dates, gridIndex:0, axisTick:{show:false}, axisLabel:{show:false}}, 
                {type:'category', data: dates, gridIndex:1}
            ],
            yAxis: [
                {   
                    type:'value', name:'è‚¡ä»·', position:'left', 
                    splitLine:{show:false}, axisLine:{show:true, lineStyle:{color:'#666'}} 
                }, 
                {   
                    type:'value', name:'å‡€å€¼', position:'right', 
                    splitLine:{show:false}, axisLine:{show:true, lineStyle:{color:'#d32f2f'}},
                    axisLabel: {formatter: '{value}'}
                },
                {   
                    type:'value', gridIndex:1, name:'æ æ†', splitLine:{show:true}, min:0, max:2.1 
                }
            ],
            dataZoom: [{type:'inside', xAxisIndex:[0,1]}, {type:'slider', xAxisIndex:[0,1], bottom:5}],
            series: [
                {
                    name:'è‚¡ä»·', type:'line', yAxisIndex:0, 
                    data:hist.map(h=>h.close), 
                    itemStyle:{color:'#666'}, showSymbol:false,
                    lineStyle: {width: 1}
                },
                {
                    name:'å‡€å€¼', type:'line', yAxisIndex:1, 
                    data:hist.map(h=>h.nav), 
                    itemStyle:{color:'#d32f2f'}, showSymbol:false,
                    lineStyle: {width: 2}
                },
                {
                    name:'æ æ†', type:'line', xAxisIndex:1, yAxisIndex:2, 
                    data:hist.map(h=>h.leverage), 
                    itemStyle:{color:'#28a745'}, step:'end', showSymbol:false, areaStyle:{opacity:0.2},
                    lineStyle: {width: 1}
                }
            ]
        });
    }
</script>
</body>
</html>
