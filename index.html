<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼°å€¼æ æ†ç­–ç•¥ (å¼ºåŠ›è¯Šæ–­ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* === æ ·å¼éƒ¨åˆ†ä¿æŒç²¾ç®€ === */
        :root { --primary: #007bff; --bg: #f4f6f9; --card: #fff; --text: #333; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 80px; font-size: 14px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; overflow: hidden; }
        .card-header { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-weight: bold; cursor: pointer; }
        .card-body { padding: 15px; display: block; }
        .card.closed .card-body { display: none; }
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .form-group { flex: 1; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn { padding: 10px; border: none; border-radius: 6px; color: #fff; font-weight: bold; cursor: pointer; flex: 1; text-align: center;}
        .btn-blue { background: #007bff; } .btn-purple { background: #6f42c1; } .btn-green { background: #28a745; } .btn-red { background: #dc3545; }
        .run-bar { display: flex; gap: 8px; flex-wrap: wrap; background: #f8f9fa; padding: 10px; border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; background: #f1f3f5; padding: 8px; }
        td { border-bottom: 1px solid #eee; padding: 8px; vertical-align: middle; }
        .val-pos { color: #d32f2f; } .val-neg { color: #2e7d32; }
    </style>
</head>
<body>
<div class="container">
    <!-- é…ç½®åŒºåŸŸ -->
    <div class="card" id="card-config">
        <div class="card-header" onclick="this.parentElement.classList.toggle('closed')"><span>âš™ï¸ ç­–ç•¥é…ç½®</span><span>â–¼</span></div>
        <div class="card-body">
            <div class="form-row">
                <input type="text" id="inName" placeholder="è‚¡ç¥¨åç§°">
                <button class="btn btn-blue" style="width:50px; flex:none;" onclick="searchStock()">ğŸ”</button>
                <input type="text" id="inCode" readonly placeholder="ä»£ç ">
            </div>
            <div class="form-row">
                <input type="number" id="inMin" placeholder="æœ€ä½å¸‚å€¼(äº¿)">
                <input type="number" id="inMax" placeholder="æœ€é«˜å¸‚å€¼(äº¿)">
            </div>
            <div class="form-row">
                <button class="btn btn-green" onclick="saveStock()">ğŸ’¾ å­˜å…¥åˆ—è¡¨</button>
            </div>
        </div>
    </div>

    <!-- åˆ—è¡¨åŒºåŸŸ -->
    <div class="card" id="card-list">
        <div class="card-header" onclick="this.parentElement.classList.toggle('closed')"><span>ğŸ“‹ ç›‘æ§åˆ—è¡¨</span><span>â–¼</span></div>
        <div class="card-body" style="padding:0">
            <div style="padding:10px;"><input type="text" id="search-list" placeholder="ç­›é€‰åˆ—è¡¨..." oninput="renderTable()"></div>
            <div style="max-height:300px; overflow:auto;">
                <table id="stock-table"><thead><tr><th>è‚¡ç¥¨</th><th>å¸‚å€¼è®¾å®š</th><th>æ“ä½œ</th><th>é€‰</th></tr></thead><tbody id="stock-tbody"></tbody></table>
            </div>
        </div>
    </div>

    <!-- è¿è¡ŒåŒºåŸŸ -->
    <div class="card" id="card-result">
        <div class="card-header"><span>ğŸ“Š æ“ä½œå°</span></div>
        <div class="card-body">
            <div class="run-bar">
                <div style="flex:1"><label style="font-size:12px;">å¼€å§‹</label><input type="date" id="inStartDate"></div>
                <div style="flex:1"><label style="font-size:12px;">ç»“æŸ</label><input type="date" id="inEndDate"></div>
            </div>
            <div class="run-bar" style="margin-top:10px;">
                <button class="btn btn-red" onclick="clearCache()">ğŸ—‘ï¸ æ¸…ç¼“å­˜</button>
                <button class="btn btn-purple" id="btn-update" onclick="updateHistoryData()">ğŸ“¥ æ›´æ–°æ•°æ®</button>
            </div>
            <div class="run-bar" style="margin-top:5px;">
                <button class="btn btn-green" onclick="diagnoseFirstStock()">ğŸ”§ è¯Šæ–­ç¬¬ä¸€åª</button>
                <button class="btn btn-blue" id="btn-run" onclick="runBacktest()">ğŸš€ è¿è¡Œå›æµ‹</button>
            </div>
            <div id="progress-box" style="margin-top:10px; padding:10px; background:#e3f2fd; color:#0056b3; display:none; border-radius:4px;"></div>
            
            <div id="result-area" style="margin-top:15px;">
                <table class="summary-table">
                    <thead><tr><th>è‚¡ç¥¨</th><th>æ”¶ç›Š</th><th>æœ€æ–°ä¿¡å·</th><th>çŠ¶æ€</th></tr></thead>
                    <tbody id="result-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// === 1. åŸºç¡€é…ç½®ä¸æ•°æ® ===
const PROXIES = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url='];
let stocks = JSON.parse(localStorage.getItem('gridStocks')) || [];
let historyCache = {}; // å†…å­˜ä¸­çš„å†å²æ•°æ®
const CACHE_KEY = 'grid_hist_data_v3'; // å‡çº§ç‰ˆæœ¬å·ï¼Œå¼ºåˆ¶éš”ç¦»æ—§ç¼“å­˜

// åˆå§‹åŒ–æ—¥æœŸ
const d = new Date(); 
document.getElementById('inEndDate').value = d.toISOString().split('T')[0];
d.setFullYear(d.getFullYear()-1);
document.getElementById('inStartDate').value = d.toISOString().split('T')[0];

// åŠ è½½æœ¬åœ°ç¼“å­˜
try {
    const saved = localStorage.getItem(CACHE_KEY);
    if(saved) historyCache = JSON.parse(saved);
} catch(e) { console.log('Cache load failed'); }

renderTable();

// === 2. æ ¸å¿ƒå·¥å…·å‡½æ•° ===

// è·å–ä¸œæ–¹è´¢å¯ŒSecId (å…¼å®¹æ€§å¢å¼ºç‰ˆ)
function getSecId(code) {
    let c = code.replace(/\.[A-Z]+$/, ''); // å»æ‰ .SH .SZ
    // æ¸¯è‚¡ 5ä½
    if(/^\d{5}$/.test(c)) return '116.' + c;
    // ç¾è‚¡
    if(code.includes('.US')) return '105.' + c;
    // æ²ªå¸‚
    if(c.startsWith('6') || c.startsWith('9')) return '1.' + c;
    // æ·±å¸‚/åŒ—äº¤
    if(c.startsWith('0') || c.startsWith('3') || c.startsWith('8') || c.startsWith('4')) return '0.' + c;
    return '0.' + c; 
}

// ä»£ç† Fetch (å¤±è´¥è‡ªåŠ¨åˆ‡æ¢)
async function fetchProxy(url, attempt=0) {
    if(attempt >= PROXIES.length) throw new Error("æ‰€æœ‰ä»£ç†å‡å¤±è´¥");
    const target = PROXIES[attempt] + encodeURIComponent(url);
    try {
        const res = await fetch(target);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
    } catch(e) {
        console.warn(`ä»£ç†${attempt}å¤±è´¥:`, e);
        return fetchProxy(url, attempt+1);
    }
}

// === 3. æ•°æ®æ›´æ–°é€»è¾‘ ===
async function updateHistoryData() {
    const btn = document.getElementById('btn-update');
    btn.innerText = "â³ ä¸‹è½½ä¸­..."; btn.disabled = true;
    
    let count = 0;
    // åˆ†æ‰¹å¹¶å‘
    for(let i=0; i<stocks.length; i+=5) {
        const batch = stocks.slice(i, i+5);
        await Promise.all(batch.map(async (s) => {
            const secId = getSecId(s.code);
            // ç¡®ä¿ fields2 åŒ…å« f51 (æ—¥æœŸ,å¼€,æ”¶,é«˜,ä½,é‡,é¢,æŒ¯å¹…)
            const url = `https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${secId}&fields1=f1&fields2=f51&klt=101&fqt=1&end=20500101&lmt=500`;
            try {
                const json = await fetchProxy(url);
                if(json?.data?.klines) {
                    historyCache[secId] = json.data.klines;
                }
            } catch(e) { console.error(s.name, e); }
        }));
        count += batch.length;
        btn.innerText = `â³ ${count}/${stocks.length}`;
    }
    
    // ä¿å­˜åˆ° LocalStorage
    try {
        localStorage.setItem(CACHE_KEY, JSON.stringify(historyCache));
        alert(`âœ… æˆåŠŸç¼“å­˜ ${Object.keys(historyCache).length} åªè‚¡ç¥¨çš„å†å²æ•°æ®`);
    } catch(e) {
        alert("âš ï¸ æ•°æ®é‡å¤ªå¤§ï¼Œç¼“å­˜å¤±è´¥ã€‚è¯·å‡å°‘è‚¡ç¥¨æ•°é‡ã€‚");
    }
    btn.innerText = "ğŸ“¥ æ›´æ–°æ•°æ®"; btn.disabled = false;
}

function clearCache() {
    if(confirm("ç¡®å®šæ¸…é™¤æ‰€æœ‰å†å²æ•°æ®ç¼“å­˜å—ï¼Ÿéœ€è¦é‡æ–°ä¸‹è½½ã€‚")) {
        localStorage.removeItem(CACHE_KEY);
        historyCache = {};
        alert("å·²æ¸…é™¤ï¼Œè¯·ç‚¹å‡»'æ›´æ–°æ•°æ®'");
    }
}

// === 4. è¯Šæ–­åŠŸèƒ½ (å¸®ä½ æ‰¾å‡ºä¸ºä»€ä¹ˆå…¨æ˜¯å¤±è´¥) ===
async function diagnoseFirstStock() {
    const checked = document.querySelectorAll('.chk:checked');
    if(checked.length === 0) return alert("è¯·å…ˆå‹¾é€‰ä¸€åªè‚¡ç¥¨");
    
    const idx = checked[0].value;
    const s = stocks[idx];
    const secId = getSecId(s.code);
    
    let msg = `è¯Šæ–­å¯¹è±¡: ${s.name} (${s.code})\nSecID: ${secId}\n\n`;
    
    // 1. æ£€æŸ¥å†å²æ•°æ®
    const hist = historyCache[secId];
    if(!hist) {
        msg += "âŒ å†å²æ•°æ®: æœ¬åœ°ç¼“å­˜ç¼ºå¤±ï¼\n-> è¯·ç‚¹å‡»'æ›´æ–°æ•°æ®'æŒ‰é’®ã€‚\n";
    } else {
        msg += `âœ… å†å²æ•°æ®: æ‰¾åˆ° ${hist.length} æ¡Kçº¿\n   (æœ€æ–°æ—¥æœŸ: ${hist[hist.length-1].split(',')[0]})\n`;
    }
    
    // 2. æ£€æŸ¥å®æ—¶æ•°æ®
    msg += "\nå°è¯•è·å–å®æ—¶æ•°æ®...\n";
    const url = `https://push2.eastmoney.com/api/qt/ulist.np/get?secids=${secId}&fields=f12,f13,f2,f20,f124&invt=2&fltt=2&_=${Date.now()}`;
    
    try {
        const json = await fetchProxy(url);
        if(!json || !json.data || !json.data.diff) {
            msg += "âŒ å®æ—¶æ•°æ®: APIè¿”å›ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯ã€‚\n";
            console.log("Full JSON:", json);
        } else {
            const list = Array.isArray(json.data.diff) ? json.data.diff : Object.values(json.data.diff);
            if(list.length > 0) {
                const item = list[0];
                msg += `âœ… å®æ—¶æ•°æ®: è·å–æˆåŠŸ\n   ç°ä»·: ${item.f2}\n   ä»£ç (f12): ${item.f12}\n   å¸‚å€¼(f20): ${(item.f20/100000000).toFixed(2)}äº¿\n`;
                
                // 3. æ¨¡æ‹ŸåŒ¹é…
                let codeMatch = false;
                if(s.code.includes(item.f12)) codeMatch = true;
                msg += codeMatch ? "âœ… ä»£ç åŒ¹é…: æˆåŠŸ" : `âŒ ä»£ç åŒ¹é…: å¤±è´¥ (é…ç½®ä»£ç  ${s.code} vs æ¥å£è¿”å› ${item.f12})`;
                
            } else {
                msg += "âŒ å®æ—¶æ•°æ®: APIè¿”å›åˆ—è¡¨ä¸ºç©ºã€‚\n";
            }
        }
    } catch(e) {
        msg += `âŒ å®æ—¶æ•°æ®: ç½‘ç»œè¯·æ±‚å¤±è´¥ (${e.message})\n-> å¯èƒ½æ˜¯ä»£ç†é—®é¢˜ã€‚`;
    }
    
    alert(msg);
}

// === 5. æ­£å¼å›æµ‹é€»è¾‘ ===
async function runBacktest() {
    const checked = document.querySelectorAll('.chk:checked');
    if(checked.length === 0) return alert("è¯·è‡³å°‘å‹¾é€‰ä¸€åª");
    
    const btn = document.getElementById('btn-run');
    btn.innerText = "è¿è¡Œä¸­..."; btn.disabled = true;
    const tbody = document.getElementById('result-tbody'); tbody.innerHTML = "";
    
    // 1. æ‰¹é‡è·å–å®æ—¶
    const selected = Array.from(checked).map(c => stocks[c.value]);
    const secIds = selected.map(s => getSecId(s.code)).join(',');
    const url = `https://push2.eastmoney.com/api/qt/ulist.np/get?secids=${secIds}&fields=f12,f13,f2,f20,f124&invt=2&fltt=2&_=${Date.now()}`;
    
    let rtMap = {};
    try {
        const json = await fetchProxy(url);
        const list = Array.isArray(json?.data?.diff) ? json.data.diff : (json?.data?.diff ? Object.values(json.data.diff) : []);
        list.forEach(d => {
            rtMap[d.f12] = d; // çº¯æ•°å­—
            // å°è¯•å…¼å®¹åç¼€
            rtMap[d.f12 + (d.f13==1?".SH":".SZ")] = d;
        });
    } catch(e) {
        alert("å®æ—¶è¡Œæƒ…è·å–å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜");
        btn.innerText = "ğŸš€ è¿è¡Œå›æµ‹"; btn.disabled = false;
        return;
    }
    
    let success = 0, fail = 0;
    
    // 2. å¾ªç¯è®¡ç®—
    selected.forEach(s => {
        try {
            const secId = getSecId(s.code);
            const hist = historyCache[secId];
            if(!hist) throw new Error("ç¼ºå†å²æ•°æ®");
            
            // åŒ¹é…å®æ—¶
            let rt = rtMap[s.code] || rtMap[s.code.split('.')[0]];
            if(!rt) {
                // æ¨¡ç³ŠåŒ¹é…ï¼šåªè¦åŒ…å«6ä½æ•°å­—
                const num = s.code.match(/\d{5,6}/);
                if(num) rt = rtMap[num[0]];
            }
            if(!rt) throw new Error("ç¼ºå®æ—¶æ•°æ®");
            if(rt.f2 === '-') throw new Error("åœç‰Œæˆ–æ— ä»·æ ¼");

            // è®¡ç®—é€»è¾‘
            const result = calcOne(s, hist, rt);
            
            // æ¸²æŸ“è¡Œ
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><b>${s.name}</b><br><span style="color:#999;font-size:10px">${s.code}</span></td>
                <td class="${result.ret>=0?'val-pos':'val-neg'}">${result.ret.toFixed(1)}%</td>
                <td>${result.action}</td>
                <td style="font-size:11px;color:#666;">${result.reason}</td>
            `;
            tbody.appendChild(tr);
            success++;
            
        } catch(e) {
            fail++;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${s.name}</td><td colspan="3" style="color:orange;text-align:center;">âŒ ${e.message}</td>`;
            tbody.appendChild(tr);
        }
    });
    
    document.getElementById('progress-box').style.display = 'block';
    document.getElementById('progress-box').innerText = `ç»“æœ: æˆåŠŸ ${success}, å¤±è´¥ ${fail}`;
    btn.innerText = "ğŸš€ è¿è¡Œå›æµ‹"; btn.disabled = false;
}

// å•åªè®¡ç®—æ ¸å¿ƒ (ç®€åŒ–ç‰ˆ)
function calcOne(stock, klines, rt) {
    // è§£ææ•°æ®
    // Kçº¿æ ¼å¼: "2023-01-01,10.5,..." (æ—¥æœŸ,æ”¶ç›˜,...)
    // å®æ—¶: rt.f2(ä»·), rt.f20(æ€»å¸‚å€¼å…ƒ)
    
    const minCap = stock.minCap; const maxCap = stock.maxCap;
    const maxLev = 2.0; // ç®€åŒ–ï¼Œç›´æ¥å†™æ­»æˆ–è¯»é…ç½®
    
    // åˆå¹¶æ•°æ®
    let data = [];
    const start = document.getElementById('inStartDate').value;
    const end = document.getElementById('inEndDate').value;
    
    // ä¼°ç®—è‚¡æœ¬
    const shares = (rt.f20 / rt.f2) / 100000000; // äº¿è‚¡
    
    klines.forEach(k => {
        const p = k.split(',');
        if(p[0] >= start && p[0] <= end) {
            const close = parseFloat(p[1]);
            const mv = close * shares;
            data.push({ date: p[0], close: close, mv: mv });
        }
    });
    
    // è¿½åŠ ä»Šå¤©
    const today = new Date().toISOString().split('T')[0];
    if(end >= today) {
        data.push({ date: today, close: rt.f2, mv: rt.f20/100000000 });
    }
    
    if(data.length < 5) throw new Error("Kçº¿æ•°æ®ä¸è¶³");

    // è®¡ç®—MA
    const ma = (day) => {
        let arr = [];
        for(let i=0; i<data.length; i++) {
            if(i<day-1) { arr.push(null); continue; }
            let s=0; for(let j=0; j<day; j++) s+=data[i-j].close;
            arr.push(s/day);
        }
        return arr;
    }
    const m20 = ma(20);
    const m10 = ma(10);
    const m5 = ma(5);
    
    // ç®€å•å›æµ‹
    let nav = 1.0;
    let prevL = 0; // åˆå§‹å‡è®¾ç©ºä»“æˆ–æ ¹æ®ç¬¬ä¸€å¤©è®¡ç®—
    
    // æ æ†å‡½æ•°
    const getLev = (mv) => {
        if(mv<=minCap) return maxLev;
        if(mv>=maxCap) return 0;
        let r = (mv-minCap)/(maxCap-minCap);
        return maxLev * Math.exp(-2.5 * r);
    };
    
    prevL = getLev(data[0].mv);
    let reason = "";
    
    for(let i=1; i<data.length; i++) {
        const d = data[i];
        const r = d.close / data[i-1].close - 1;
        nav = nav * (1 + prevL * r);
        
        let target = getLev(d.mv);
        
        // è¶‹åŠ¿é£æ§ (ç®€å•ç‰ˆ)
        const isDown = m5[i] && m20[i] && m5[i] < m20[i] && d.close < m20[i];
        if(isDown && target > 0) {
            target = target * 0.2; // è¶‹åŠ¿ä¸å¥½ï¼Œé™ä»“
            reason = "è¶‹åŠ¿å‘ä¸‹å‡ä»“";
        } else {
            reason = "ä¼°å€¼é©±åŠ¨";
        }
        prevL = target;
    }
    
    // ç”Ÿæˆæœ€åçš„æ“ä½œä¿¡å·
    const last = data[data.length-1];
    const lastLev = prevL;
    let action = `<span style="font-weight:bold;color:${lastLev>0.5?'#d32f2f':'#2e7d32'}">${lastLev.toFixed(1)}x</span>`;
    
    return { ret: (nav-1)*100, action: action, reason: reason };
}

// === 6. UI è¾…åŠ©å‡½æ•° ===
function searchStock() {
    const val = document.getElementById('inName').value;
    const s = document.createElement('script');
    s.src = `https://searchapi.eastmoney.com/api/suggest/get?input=${encodeURIComponent(val)}&type=14&token=D43BF722C8E33BD5D50F639205545E43&cb=cbSearch`;
    window.cbSearch = (d) => {
        if(d?.QuotationCodeTable?.Data?.[0]) {
            const r = d.QuotationCodeTable.Data[0];
            let suffix = r.MarketType == "1" ? ".SH" : (r.MarketType=="2"?".SZ":".HK");
            if(r.Code.length==5) suffix = ".HK";
            document.getElementById('inCode').value = r.Code + suffix;
            document.getElementById('inName').value = r.Name;
        } else alert("æœªæ‰¾åˆ°");
        s.remove();
    };
    document.body.appendChild(s);
}
function saveStock() {
    const code = document.getElementById('inCode').value;
    const name = document.getElementById('inName').value;
    const min = parseFloat(document.getElementById('inMin').value);
    const max = parseFloat(document.getElementById('inMax').value);
    if(!code || !min) return alert("ä¿¡æ¯ä¸å…¨");
    stocks.push({code, name, minCap:min, maxCap:max});
    localStorage.setItem('gridStocks', JSON.stringify(stocks));
    renderTable();
    alert("å·²ä¿å­˜ï¼Œè®°å¾—ç‚¹'æ›´æ–°æ•°æ®'ï¼");
}
function renderTable() {
    const k = document.getElementById('search-list').value.toLowerCase();
    const tb = document.getElementById('stock-tbody');
    tb.innerHTML = stocks.map((s,i) => {
        if(k && !s.name.includes(k) && !s.code.includes(k)) return '';
        return `<tr>
            <td>${s.name}<br><span style="color:#999;font-size:10px">${s.code}</span></td>
            <td>${s.minCap}-${s.maxCap}</td>
            <td><button onclick="stocks.splice(${i},1);localStorage.setItem('gridStocks',JSON.stringify(stocks));renderTable()">âœ•</button></td>
            <td><input type="checkbox" class="chk" value="${i}" checked></td>
        </tr>`;
    }).join('');
}

// è‡ªåŠ¨åˆå§‹åŒ–
(async function(){
    if(stocks.length > 0 && Object.keys(historyCache).length === 0) {
        // è‡ªåŠ¨æç¤ºæ›´æ–°
        // alert("è¯·ç‚¹å‡» 'ğŸ“¥ æ›´æ–°æ•°æ®' ä»¥ç¼“å­˜å†å²Kçº¿");
    }
})();
</script>
</body>
</html>
